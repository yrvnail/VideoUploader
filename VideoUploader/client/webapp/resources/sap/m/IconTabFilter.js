/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./library","./AccButton","./IconTabFilterExpandButtonBadge","sap/ui/core/library","sap/ui/core/Core","sap/ui/core/Item","sap/ui/core/Renderer","sap/ui/core/IconPool",'sap/ui/core/InvisibleMessage',"sap/ui/core/InvisibleText",'sap/ui/Device',"sap/m/BadgeCustomData","sap/m/Button","sap/m/ResponsivePopover","sap/m/IconTabBarSelectList","sap/m/BadgeEnabler"],function(l,A,I,c,C,a,R,b,d,e,D,B,f,g,h,j){"use strict";var T=c.TextAlign;var k=c.TextDirection;var m=l.ButtonType;var P=l.PlacementType;var n=l.ImageHelper;var o=l.IconTabFilterDesign;var p=l.BadgeStyle;var q=l.BadgeState;var r=c.IconColor;var s=3000;var t=c.InvisibleMessageMode;var u=a.extend("sap.m.IconTabFilter",{metadata:{interfaces:["sap.m.IconTab","sap.ui.core.PopupInterface","sap.m.IBadge"],library:"sap.m",designtime:"sap/m/designtime/IconTabFilter.designtime",properties:{count:{type:"string",group:"Data",defaultValue:''},showAll:{type:"boolean",group:"Misc",defaultValue:false},icon:{type:"sap.ui.core.URI",group:"Misc",defaultValue:''},iconColor:{type:"sap.ui.core.IconColor",group:"Appearance",defaultValue:r.Default},iconDensityAware:{type:"boolean",group:"Appearance",defaultValue:true},visible:{type:"boolean",group:"Behavior",defaultValue:true},design:{type:"sap.m.IconTabFilterDesign",group:"Appearance",defaultValue:o.Vertical}},defaultAggregation:"content",aggregations:{content:{type:"sap.ui.core.Control",multiple:true,singularName:"content"},items:{type:"sap.m.IconTab",multiple:true,singularName:"item"},_expandButton:{type:"sap.m.Button",multiple:false,visibility:"hidden"},_expandButtonBadge:{type:"sap.ui.core.Control",multiple:false,visibility:"hidden"}}}});j.call(u.prototype);var v=C.getLibraryResourceBundle("sap.m");u._aAllIconColors=['sapMITBFilterCritical','sapMITBFilterPositive','sapMITBFilterNegative','sapMITBFilterDefault','sapMITBFilterNeutral'];u.prototype._getImageControl=function(i,w,x){var y={src:this.getIcon(),densityAware:this.getIconDensityAware(),useIconTooltip:false};if(y.src){this._oImageControl=n.getImageControl(this.getId()+"-icon",this._oImageControl,w,y,i,x);}else if(this._oImageControl){this._oImageControl.destroy();this._oImageControl=null;}return this._oImageControl;};u.prototype.init=function(){this._oDragEventDelegate={onlongdragover:this._handleOnLongDragOver,ondragover:this._handleOnDragOver,ondragleave:this._handleOnDragLeave,ondrop:this._handleOnDrop};this.initBadgeEnablement({style:p.Attention,selector:{selector:".sapMITBBadgeHolder"}});this._oCloneInList=null;this.setAggregation("_expandButtonBadge",new I());};u.prototype.exit=function(E){if(this._oImageControl){this._oImageControl.destroy();}if(a.prototype.exit){a.prototype.exit.call(this,E);}if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null;}if(this._oPopover){this._oPopover.destroy();this._oPopover=null;}if(this._oExpandButton){this._oExpandButton.removeEventDelegate(this._oDragEventDelegate);this._oExpandButton.destroy();this._oExpandButton=null;}this.removeEventDelegate(this._oDragEventDelegate);this._oDragEventDelegate=null;if(this._iHideBadgeTimeout){clearTimeout(this._iHideBadgeTimeout);}};u.prototype.invalidate=function(){var i=this.getParent(),w,O;if(!i){return;}w=i.getParent();if(!(w instanceof sap.m.IconTabBar)){i.invalidate();return;}O=w.getParent();if(O instanceof sap.m.ObjectHeader){O.invalidate();}else{w.invalidate();}};u.prototype.setProperty=function(i,V,S){switch(i){case'textDirection':case'text':case'count':case'showAll':case'icon':case'iconColor':case'iconDensityAware':case'design':if(this.getProperty(i)===V){return this;}a.prototype.setProperty.call(this,i,V,true);if(!S){var w=this.getParent();if(w instanceof sap.m.IconTabHeader){w.invalidate();}}break;default:a.prototype.setProperty.apply(this,arguments);break;}return this;};u.prototype._getNonEmptyKey=function(){var K=this.getKey();if(K){return K;}return this.getId();};u.prototype._getRealTab=function(){return this._oRealItem||this;};u.prototype._getRootTab=function(){var i=this._getRealTab(),w=i.getParent();while(w&&w.isA("sap.m.IconTabFilter")){i=w;w=w.getParent();}return i;};u.prototype._getNestedLevel=function(){var i=this._getRealTab().getParent(),L;for(L=1;i&&i.isA("sap.m.IconTabFilter");L++){i=i.getParent();}return L;};u.prototype.render=function(i,V,w){if(!this.getVisible()){return;}this._prepareDragEventDelegate();var x=this.getParent(),y=x.getParent(),H=x._isInsideIconTabBar(),z={role:"tab"},E=this.getId(),F=this.getCount(),G=this.getText(),J=this.getIcon(),K=this.getIconColor(),L=this.getEnabled(),S=L&&(K=="Positive"||K=="Critical"||K=="Negative"||K=="Neutral"),M=this.getDesign()===o.Horizontal,N=x._bTextOnly,O=x._bInLine||x.isInlineMode(),Q=this.getShowAll(),U=this.getTextDirection();if(H){z.controls=y.getId()+"-content";}if(this.getItems().length){z.roledescription=v.getText("ICONTABFILTER_SPLIT_TAB");}if(G.length||F!==""||J){var W=[];if(F!==""){W.push(E+"-count");}if(G.length){W.push(E+"-text");}if(J){W.push(E+"-icon");}if(S){W.push(E+"-iconColor");}z.labelledby=W.join(" ");}if(V!==undefined&&w!==undefined){Object.assign(z,{posinset:V+1,setsize:w});}i.openStart("div",this).accessibilityState(z).class("sapMITBItem");if(!F){i.class("sapMITBItemNoCount");}if(M){i.class("sapMITBHorizontal");}else{i.class("sapMITBVertical");}if(Q){i.class("sapMITBAll");}else{i.class("sapMITBFilter");}if(!Q&&L){i.class("sapMITBFilter"+K);}if(x._isUnselectable(this)){i.class("sapMITHUnselectable");}if(this.getItems().length>0){i.class("sapMITBFilterWithItems");}if(!L){i.class("sapMITBDisabled").attr("aria-disabled",true);}i.attr("aria-selected",false);var X=this.getTooltip_AsString();if(X){i.attr("title",X);}if(this._isOverflow()||this.getItems().length){i.attr("aria-haspopup","menu");}i.openEnd();i.openStart("div").class("sapMITBFilterWrapper").openEnd();if(!O){i.openStart("div",E+"-tab").class("sapMITBTab").openEnd();if(!Q||!J){if(S){i.openStart("div",E+"-iconColor").style("display","none").openEnd().text(v.getText("ICONTABBAR_ICONCOLOR_"+K.toUpperCase())).close("div");}var Y=["sapMITBFilterIcon","sapMITBBadgeHolder"];if(L){Y.push("sapMITBFilter"+K);}i.renderControl(this._getImageControl(Y,x,u._aAllIconColors));}if(!Q&&!J&&!N){i.openStart("span").class("sapMITBFilterNoIcon").openEnd().close("span");}if(M&&!Q){i.close("div");i.openStart("div").class("sapMITBHorizontalWrapper").openEnd();}i.openStart("span",E+"-count").class("sapMITBCount");if(Q||(!J&&!G.length)){i.class("sapMITBBadgeHolder");}i.openEnd();if(F===""&&M){i.unsafeHtml("&nbsp;");}else{i.text(F);}i.close("span");if(!M){i.close("div");}}if(G.length){i.openStart("div",E+"-text").class("sapMITBText");if(!J&&!Q){i.class("sapMITBBadgeHolder");}if(H&&y.getUpperCase()){i.class("sapMITBTextUpperCase");}i.openEnd();i.openStart("span").class("sapMITHTextContent").attr("dir",U!==k.Inherit?U.toLowerCase():"auto");i.openEnd().text(x._getDisplayText(this)).close("span");if(this._isOverflow()||this.getItems().length&&x._isUnselectable(this)){i.openStart("span",this.getId()+"-expandButton").class("sapMITHShowSubItemsIcon").openEnd();i.icon(b.getIconURI("slim-arrow-down"),null,{"title":null,"aria-hidden":true});i.close("span");}i.close("div");}if(!O&&M){i.close("div");}i.openStart("div").class("sapMITBContentArrow").openEnd().close("div");i.close("div");if(this.getItems().length&&!x._isUnselectable(this)){i.openStart("span").accessibilityState({role:"separator"}).openEnd().close("span");i.renderControl(this._getExpandButton());}i.renderControl(this.getAggregation("_expandButtonBadge"));if(this.getItems().length){this._updateExpandButtonBadge();}i.close("div");};u.prototype.renderInSelectList=function(i,S,w,x,y){if(this._invisibleText){this._invisibleText.destroy();this._invisibleText=null;}if(!this.getVisible()){return;}var z=true,E=S._bIconOnly,F=S._oIconTabHeader,G=this.getIconColor(),H=this.getEnabled();if(F){z=F._bTextOnly;}i.openStart("li",this).class("sapMITBSelectItem").attr("tabindex","-1").attr("role","menuitem");if(y){i.style("padding-left",y+"rem");}if(w!==undefined&&x!==undefined){i.attr("aria-posinset",w+1);i.attr("aria-setsize",x);i.attr("aria-level",this._getNestedLevel());}var J=this.getTooltip_AsString();if(J){i.attr("title",J);}if(F._isUnselectable(this)){i.class("sapMITHUnselectable");}if(!H){i.class("sapMITBDisabled").attr("aria-disabled",true);}if(S.getSelectedItem()==this){i.class("sapMITBSelectItemSelected");i.attr("aria-selected",true);}if(H){i.class("sapMITBFilter"+G);}var K=this.getId(),L=H&&(G=="Positive"||G=="Critical"||G=="Negative"||G=="Neutral"),M=[];if(!E){M.push(K+"-text");}if(!z&&this.getIcon()){M.push(K+"-icon");}if(L){this._invisibleText=new e({text:v.getText('ICONTABBAR_ICONCOLOR_'+G.toUpperCase())});M.push(this._invisibleText.getId());}i.accessibilityState({labelledby:M.join(" ")}).openEnd();if(this._invisibleText){i.renderControl(this._invisibleText);}if(!z){this._renderIcon(i,E);}if(!E){this._renderText(i);}i.close("li");};u.prototype._onAfterParentRendering=function(){this._renderBadge();d.getInstance();};u.prototype._renderIcon=function(i,w){var x=this.getIcon();if(x){var y=b.getIconInfo(x),z=["sapMITBSelectItemIcon"];if(y&&!y.suppressMirroring){z.push("sapUiIconMirrorInRTL");}if(w){z.push("sapMITBBadgeHolder");}i.icon(x,z,{id:this.getId()+"-icon","aria-hidden":true});}else{i.openStart("span").class("sapUiIcon").openEnd().close("span");}};u.prototype._renderText=function(i){var w=this.getText(),x=this.getCount(),y=C.getConfiguration().getRTL(),z=this.getTextDirection();i.openStart("span",this.getId()+"-text").attr("dir",z!==k.Inherit?z.toLowerCase():"auto").class("sapMText").class("sapMTextNoWrap").class("sapMITBText").class("sapMITBBadgeHolder");var E=R.getTextAlign(T.Begin,z);if(E){i.style("text-align",E);}if(x){if(y){w='('+x+') '+w;}else{w+=' ('+x+')';}}i.openEnd().text(w).close("span");};u.prototype._getSelectList=function(){if(!this._oSelectList){this._oSelectList=new h({selectionChange:function(E){var i=E.getParameter("selectedItem");this._oIconTabHeader.setSelectedItem(i._getRealTab());this._oTabFilter._closePopover();}});this._oSelectList._oIconTabHeader=this.getParent();this._oSelectList._oTabFilter=this;this._oSelectList._bIsOverflow=this._isOverflow;}return this._oSelectList;};u.prototype._prepareDragEventDelegate=function(){if(this.getEnabled()){this.addEventDelegate(this._oDragEventDelegate,this);}else{this.removeEventDelegate(this._oDragEventDelegate);}};u.prototype._getExpandButton=function(){this._oExpandButton=this.getAggregation("_expandButton");if(!this._oExpandButton){this._oExpandButton=new A(this.getId()+"-expandButton",{type:m.Transparent,icon:b.getIconURI("slim-arrow-down"),tooltip:v.getText("ICONTABHEADER_OVERFLOW_MORE"),tabIndex:"-1",press:this._expandButtonPress.bind(this)}).addStyleClass("sapMITBFilterExpandBtn");this.setAggregation("_expandButton",this._oExpandButton);}return this._oExpandButton;};u.prototype._updateExpandButtonBadge=function(){var E=this.getAggregation("_expandButtonBadge"),H=E.getBadgeCustomData()&&E.getBadgeCustomData().getVisible(),i=this._hasChildWithBadge();if(i&&!H){E.addCustomData(new B({visible:true}));}else if(!i&&H){E.getBadgeCustomData().setVisible(false);}};u.prototype._hasChildWithBadge=function(){var i=this._isOverflow()?this._getIconTabHeader()._getItemsForOverflow():this._getAllSubItems();return i.some(function(w){return w.isA("sap.m.IBadge")&&w.getBadgeCustomData()&&w.getBadgeCustomData().getVisible();});};u.prototype._expandButtonPress=function(){if(!this.getEnabled()){return;}this.$().trigger("focus");if(!this._oPopover){this._oPopover=new g({showArrow:false,showHeader:false,offsetY:0,offsetX:0,placement:P.VerticalPreferredBottom}).addStyleClass("sapMITBFilterPopover");this._oPopover.attachBeforeClose(function(){this._getSelectList().destroyItems();},this);if(D.system.phone){this._oPopover._oControl.addButton(this._createPopoverCloseButton());}this.addDependent(this._oPopover);this._oPopover._oControl._adaptPositionParams=function(){var i=this.$().parents().hasClass("sapUiSizeCompact");this._arrowOffset=0;if(i){this._offsets=["0 0","0 0","0 4","0 0"];}else{this._offsets=["0 0","0 0","0 5","0 0"];}this._atPositions=["end top","end top","end bottom","begin top"];this._myPositions=["end bottom","begin top","end top","end top"];};}var H=this._setSelectListItems();var S=this._getSelectList();this._oPopover.removeAllContent();if(this.getItems().length||this._isOverflow()){this._oPopover.addContent(S);this._oPopover.setInitialFocus(H?S.getSelectedItem():S.getVisibleTabFilters()[0]);this._oPopover.openBy(this);}};u.prototype._getAllSubItems=function(){var i=[];this._getRealTab().getItems().forEach(function(w){if(w.isA("sap.m.IconTabFilter")){i=i.concat(w,w._getAllSubItems());}else{i=i.concat(w);}});return i;};u.prototype._getAllSubFilters=function(){return this._getAllSubItems().filter(function(i){return i.isA("sap.m.IconTabFilter");});};u.prototype._getAllSubFiltersDomRefs=function(){return this._getAllSubFilters().filter(function(S){return Boolean(S._getRealTab().getDomRef());}).map(function(S){return S._getRealTab().getDomRef();});};u.prototype._getFirstAvailableSubFilter=function(){var w=this._getAllSubFilters();for(var i=0;i<w.length;i++){var x=w[i];if(x.getContent().length&&x.getVisible()){return x;}}return this;};u.prototype._isParentOf=function(w){var x=this._getAllSubFilters();for(var i=0;i<x.length;i++){if(x[i]._getRealTab()===w){return true;}}return false;};u.prototype._createPopoverCloseButton=function(){return new f({text:v.getText("SELECT_CANCEL_BUTTON"),press:this._closePopover.bind(this)});};u.prototype._closePopover=function(){if(this._oPopover){this._oPopover.close();this._oPopover.removeAllContent();}if(this._isOverflow()&&this.getParent().oSelectedItem){(this.getParent()._oSelectedRootItem||this.getParent().oSelectedItem._getRootTab()).$().focus();}};u.prototype._handleOnDragOver=function(E){if(this._isDropPossible(E)){this.getDomRef().classList.add("sapMITHDragOver");E.preventDefault();}};u.prototype._handleOnLongDragOver=function(E){if(this._isDropPossible(E)){if(this._oPopover&&this._oPopover.isOpen()){return;}this._expandButtonPress();}};u.prototype._handleOnDrop=function(){this.getDomRef().classList.remove("sapMITHDragOver");};u.prototype._handleOnDragLeave=function(){this.getDomRef().classList.remove("sapMITHDragOver");};u.prototype._isDropPossible=function(E){var i=this._getIconTabHeader(),w=E.dragSession.getDragControl()._getRealTab(),S=i.oSelectedItem;if(i!==w._getIconTabHeader()){return false;}if(w===this||w._isParentOf(this)){return false;}if(!this._isOverflow()&&!i.getMaxNestingLevel()){return false;}if(this._isOverflow()&&S&&(S===w||S._getRootTab()===w)){return false;}return true;};u.prototype._setSelectListItems=function(){var w=this.getParent(),S=this._getSelectList(),x=this._getAllSubItems(),y=w.oSelectedItem,H=false,z,L,E,i,F;if(this._isOverflow()){x=w._getItemsForOverflow(this._bIsStartOverflow);}S.destroyItems();S.setSelectedItem(null);for(i=0;i<x.length;i++){z=x[i];L=z.clone(undefined,undefined,{cloneChildren:false,cloneBindings:true});z._oCloneInList=L;E=z.getCustomData();for(F=0;F<E.length;F++){L.addCustomData(E[F].clone());}L._oRealItem=z;S.addItem(L);if(z.isA("sap.m.IconTabSeparator")){continue;}if(L._getRealTab()===y){S.setSelectedItem(L);H=true;continue;}if(L._getRealTab()._isParentOf(y)){S.setSelectedItem(y._getRealTab());H=true;}}return H;};u.prototype._isOverflow=function(){return this._bIsOverflow||this._bIsStartOverflow;};u.prototype._getIconTabHeader=function(){return this._getRootTab().getParent();};u.prototype.onsapdown=function(E){if(!this.getEnabled()){return;}if(this._isOverflow()||((this._getNestedLevel()===1&&this._getRealTab()===this)&&this._getRealTab().getItems().length!==0)){E.stopImmediatePropagation();this._expandButtonPress();}};u.prototype._startBadgeHiding=function(){if(this._iHideBadgeTimeout){return;}this._iHideBadgeTimeout=setTimeout(this._hideBadge.bind(this),s);if(this._getRootTab()!==this){this._getRootTab()._updateExpandButtonBadge();}};u.prototype._hideBadge=function(){var i=this.getBadgeCustomData();if(!i){return;}i.setVisible(false);if(this._getRootTab()!==this){this._getRootTab()._updateExpandButtonBadge();}if(this._oCloneInList&&!this._oCloneInList.bIsDestroyed&&this._oCloneInList.getBadgeCustomData()){this._oCloneInList.getBadgeCustomData().setVisible(false);this._oCloneInList=null;}if(this._isInOverflow()){this._getIconTabHeader()._getOverflow()._updateExpandButtonBadge();}if(this._isInStartOverflow()){this._getIconTabHeader()._getStartOverflow()._updateExpandButtonBadge();}this._iHideBadgeTimeout=null;};u.prototype._isInOverflow=function(){return!this._bIsOverflow&&this._getIconTabHeader()._getItemsInStrip().indexOf(this._getRealTab())===-1;};u.prototype._isInStartOverflow=function(){return!this._bIsStartOverflow&&this._getIconTabHeader()._getItemsInStrip().indexOf(this._getRealTab())===-1;};u.prototype.onBadgeUpdate=function(V,S,i){var w=this.getDomRef(),x=this._getIconTabHeader(),y,z,E,F,O,G,H,J;if(!x){return;}if(w){E=w.getAttribute("aria-labelledby")||"";switch(S){case q.Appear:E=i+" "+E;break;case q.Disappear:E=E.replace(i,"").trim();break;}w.setAttribute("aria-labelledby",E);}if(!x._isRendered()){return;}y=this._getRootTab();if(y._isInOverflow()){O=this._getIconTabHeader()._getOverflow();O._updateExpandButtonBadge();}if(y._isInStartOverflow()){G=this._getIconTabHeader()._getStartOverflow();G._updateExpandButtonBadge();}else if(y!==this){y._updateExpandButtonBadge();}if(S!==q.Appear){return;}this._enableMotion();if((this._isInOverflow()||this._isInStartOverflow())&&this._oCloneInList){this._oCloneInList.addCustomData(new B());}z=d.getInstance();F=this.getText();if(y._isInOverflow()){H="ICONTABFILTER_SUB_ITEM_BADGE";J=[F,O.getText()];}if(y._isInStartOverflow()){H="ICONTABFILTER_SUB_ITEM_BADGE";J=[F,G.getText()];}else{if(y!==this){H="ICONTABFILTER_SUB_ITEM_BADGE";J=[F,y.getText()];}else{H="ICONTABFILTER_BADGE_MSG";J=F;}}z.announce(v.getText(H,J),t.Assertive);};u.prototype.getAriaLabelBadgeText=function(){return v.getText("ICONTABFILTER_BADGE");};u.prototype._enableMotion=function(){if(this._getRealTab()._isInOverflow()||this._getRealTab()._isInStartOverflow()){if(this._oCloneInList&&this._oCloneInList.getDomRef()){this._oCloneInList.getDomRef().classList.add("sapMITBFilterBadgeMotion");}}else if(this.getDomRef()){this.getDomRef().classList.add("sapMITBFilterBadgeMotion");}};return u;});
