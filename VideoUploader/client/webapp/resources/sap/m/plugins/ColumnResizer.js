/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./PluginBase","sap/ui/core/Core","sap/ui/core/InvisibleText","sap/ui/Device","sap/ui/thirdparty/jquery","sap/ui/dom/jquery/control","sap/ui/dom/jquery/Aria"],function(P,C,I,D,q){"use strict";var a=P.extend("sap.m.plugins.ColumnResizer",{metadata:{library:"sap.m",properties:{},events:{columnResize:{allowPreventDefault:true,parameters:{column:{type:"sap.ui.core.Element"},width:{type:"sap.ui.core.CSSSize"}}}}}});var s={};var r=false;var b="sapMPluginsColumnResizer";var R=C.getConfiguration().getRTL();var B=R?"right":"left";var e=R?"left":"right";var d=R?-1:1;a.getPlugin=P.getPlugin;a.prototype.init=function(){this._iHoveredColumnIndex=-1;this._aPositions=[];this._oHandle=null;};a.prototype.onActivate=function(c){c.addEventDelegate(this,this);if(c.isActive()){this.onAfterRendering();}};a.prototype.onDeactivate=function(c){c.removeEventDelegate(this,this);this.onBeforeRendering();this._oHandle=null;};a.prototype.onBeforeRendering=function(){if(this._$Container){this._$Container.removeClass(b+"Container").off("."+b);this._$Container.find(this.getConfig("resizable")).removeClass(b+"Resizable");this._updateAriaDescribedBy("remove");}};a.prototype.onAfterRendering=function(){this._$Container=this.getControl().$(this.getConfig("container"));D.system.desktop&&this._$Container.on("mousemove."+b,this._onmousemove.bind(this));this._$Container.addClass(b+"Container").on("mouseleave."+b,this._onmouseleave.bind(this));this._aResizables=this._$Container.find(this.getConfig("resizable")).addClass(b+"Resizable").get();this._updateAriaDescribedBy("add");this._invalidatePositions();};a.prototype._updateAriaDescribedBy=function(A){this._aResizables&&this._aResizables.forEach(function(o){var c=q(o).control(0,true);var f=c&&c.getFocusDomRef();q(f)[A+"AriaDescribedBy"](I.getStaticId("sap.m","COLUMNRESIZER_RESIZABLE"));});};a.prototype.ontouchstart=function(E){if(this.getConfig("allowTouchResizing")&&q(E.target).closest(this._aResizables)[0]){this._onmousemove(E);}else if(this._iHoveredColumnIndex==-1&&this._oHandle&&this._oHandle.style[B]){this._onmousemove(E);if(this._iHoveredColumnIndex==-1){this._oHandle.style[B]="";this._oAlternateHandle.style[B]="";}}r=(this._iHoveredColumnIndex>-1);if(!r){return;}this._startResizeSession(this._iHoveredColumnIndex);s.iTouchStartX=E.targetTouches[0].clientX;s.fHandleX=parseFloat(this._oHandle.style[B]);this._$Container.addClass(b+"Resizing");q(document).on("touchend."+b+" mouseup."+b,this._ontouchend.bind(this));};a.prototype.ontouchmove=function(E){if(!r){return;}this._setSessionDistanceX((E.targetTouches[0].clientX-s.iTouchStartX));this._oHandle.style[B]=s.fHandleX+s.iDistanceX+"px";};a.prototype._onmousemove=function(E){if(r){return;}this._setPositions();var c=E.targetTouches?E.targetTouches[0].clientX:E.clientX;var h=this._getHoveredColumnIndex(c);this._displayHandle(h);};a.prototype._onmouseleave=function(){this._invalidatePositions();};a.prototype._ontouchend=function(){this._setColumnWidth();this._cancelResizing(true);};a.prototype.onsapescape=function(){if(r){this._cancelResizing();}};a.prototype.onsaprightmodifiers=function(E){this._onLeftRightModifiersKeyDown(E,16);};a.prototype.onsapleftmodifiers=function(E){this._onLeftRightModifiersKeyDown(E,-16);};a.prototype.ondblclick=function(E){var c=E.clientX,h=this._getHoveredColumnIndex(c);if(h==-1){return;}this._startResizeSession(h);this._setSessionDistanceX(this._calculateAutoColumnDistanceX());this._setColumnWidth();this._endResizeSession();};a.prototype._getHoveredColumnIndex=function(c){return this._aPositions.findIndex(function(p){return Math.abs(p-c)<=(this._oAlternateHandle||window.matchMedia("(hover:none)").matches?20:3);},this);};a.prototype._calculateAutoColumnDistanceX=function(){var c=this.getConfig("columnRelatedCells",this._$Container,s.oCurrentColumn.getId());if(!c||!c.length){return;}var h=q("<div></div>").addClass(b+"SizeDetector").addClass(this.getConfig("cellPaddingStyleClass"));var $=c.children().clone().removeAttr("id");this._$Container.append(h);var w=Math.round(h.append($)[0].getBoundingClientRect().width);var i=w-s.fCurrentColumnWidth;h.remove();return i;};a.prototype._invalidatePositions=function(){window.setTimeout(function(){this._bPositionsInvalid=true;}.bind(this));};a.prototype._displayHandle=function(c,m){if(this._iHoveredColumnIndex==c){return;}if(!this._oHandle){this._oHandle=document.createElement("div");this._oHandle.className=b+"Handle";if(m||window.matchMedia("(hover:none)").matches){var o=document.createElement("div");o.className=b+"HandleCircle";o.style.top=this._aResizables[c].offsetHeight-8+"px";this._oHandle.appendChild(o);this._oAlternateHandle=this._oHandle.cloneNode(true);}}if(!this._oHandle.parentNode){this._$Container.append(this._oHandle);if(m){this._$Container.append(this._oAlternateHandle);}}this._oHandle.style[B]=(c>-1)?(this._aPositions[c]-this._fContainerX)*d+"px":"";if(m){this._oAlternateHandle.style[B]=(--c>-1)?(this._aPositions[c]-this._fContainerX)*d+"px":"";}else{if(this._oAlternateHandle){this._oAlternateHandle.style[B]="";}this._iHoveredColumnIndex=c;}};a.prototype._cancelResizing=function(c){this._$Container.removeClass(b+"Resizing");if(s.iDistanceX||!c){this._oHandle.style[B]="";}else{setTimeout(function(){this._oHandle.style[B]="";}.bind(this),300);}this._iHoveredColumnIndex=-1;q(document).off("."+b);this._endResizeSession();r=false;};a.prototype._getColumnMinWidth=function(c){return c?48:0;};a.prototype._startResizeSession=function(i){s.$CurrentColumn=q(this._aResizables[i]);s.oCurrentColumn=s.$CurrentColumn.control(0,true);s.fCurrentColumnWidth=s.$CurrentColumn.width();s.iMaxDecrease=this._getColumnMinWidth(s.oCurrentColumn)-s.fCurrentColumnWidth;s.iEmptySpace=this.getConfig("emptySpace",this.getControl());if(s.iEmptySpace!=-1){s.$NextColumn=q(this._aResizables[i+1]);s.oNextColumn=s.$NextColumn.control(0,true);s.fNextColumnWidth=s.$NextColumn.width()||0;s.iMaxIncrease=s.iEmptySpace+s.fNextColumnWidth-this._getColumnMinWidth(s.oNextColumn);}else{s.iMaxIncrease=window.innerWidth;}};a.prototype._setSessionDistanceX=function(i){s.iDistanceX=((i>0)?Math.min(i,s.iMaxIncrease):Math.max(i,s.iMaxDecrease))*d;};a.prototype._setColumnWidth=function(){if(!s.iDistanceX){return;}var w=s.fCurrentColumnWidth+s.iDistanceX+"px";if(!this._fireColumnResize(s.oCurrentColumn,w)){return;}s.oCurrentColumn.setWidth(w);if(s.oNextColumn&&(s.iEmptySpace<3||s.iDistanceX>s.iEmptySpace)){w=s.fNextColumnWidth-s.iDistanceX+s.iEmptySpace+"px";if(this._fireColumnResize(s.oNextColumn,w)){s.oNextColumn.setWidth(w);}}this.getConfig("fixAutoWidthColumns")&&this._aResizables.forEach(function(o){var $=q(o),c=$.control(0,true),w=c.getWidth();if(w&&w.toLowerCase()!="auto"){return;}w=$.css("width");if(w&&this._fireColumnResize(c,w)){c.setWidth(w);}},this);};a.prototype._fireColumnResize=function(c,w){return this.fireColumnResize({column:c,width:w});};a.prototype._onLeftRightModifiersKeyDown=function(E,i){if(!E.shiftKey){return;}var o=q(E.target).closest(this._aResizables)[0],c=this._aResizables.indexOf(o);if(c===-1){return;}this._startResizeSession(c);this._setSessionDistanceX(i);this._setColumnWidth();this._endResizeSession();};a.prototype._endResizeSession=function(){s={};};a.prototype._setPositions=function(){if(!this._bPositionsInvalid){return this._aPositions;}this._bPositionsInvalid=false;this._fContainerX=this._$Container[0].getBoundingClientRect()[B];this._aPositions=this._aResizables.map(function(o,i,p){return o.getBoundingClientRect()[e]-(++i==p.length?1.25*d:0);},this);};a.prototype.startResizing=function(o){var c=this._aResizables.indexOf(o);this._setPositions();this._displayHandle(c,true);};P.setConfigs({"sap.m.Table":{container:"listUl",resizable:".sapMListTblHeaderCell:not([aria-hidden=true])",focusable:".sapMColumnHeaderFocusable",cellPaddingStyleClass:"sapMListTblCell",fixAutoWidthColumns:true,onActivate:function(t){this._vOrigFixedLayout=t.getFixedLayout();if(!t.bActiveHeaders){t.bFocusableHeaders=true;this.allowTouchResizing=window.matchMedia("(hover:none)").matches;}t.setFixedLayout("Strict");},onDeactivate:function(t){t.bFocusableHeaders=false;t.setFixedLayout(this._vOrigFixedLayout);if(this._vOrigFixedLayout=="Strict"){t.rerender();}delete this._vOrigFixedLayout;delete this.allowTouchResizing;},emptySpace:function(t){var o=t.getDomRef("tblHeadDummyCell");return o?o.clientWidth:0;},columnRelatedCells:function($,c){return $.find(".sapMListTblCell[data-sap-ui-column='"+c+"']");}}},a);return a;});
