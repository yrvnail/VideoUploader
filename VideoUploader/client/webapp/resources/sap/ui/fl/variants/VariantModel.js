/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/each","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/BusyIndicator","sap/ui/fl/apply/_internal/changes/Reverter","sap/ui/fl/apply/_internal/controlVariants/URLHandler","sap/ui/fl/apply/_internal/flexState/controlVariants/Switcher","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/changeHandler/Base","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/registry/Settings","sap/ui/model/json/JSONModel"],function(_,e,i,a,m,O,L,J,B,R,U,S,V,b,c,C,d,f,g,h,j){"use strict";function k(E,P){return o(function(x,y){var M=y.model;var z=y.vmReference;var A=false;var T=x.key;var D=x.key;return Promise.resolve().then(function(){if(O.get([z,"currentVariant"],M.oData)&&M.oData[z].currentVariant!==M.oData[z].originalCurrentVariant){D=M.oData[z].originalCurrentVariant;A=true;return M.updateCurrentVariant({variantManagementReference:z,newVariantReference:T,appComponent:M.oAppComponent,internallyCalled:true});}}).then(function(){if(O.get([z,"modified"],M.oData)===true){var F=V.getControlChangesForVariant({reference:M.sFlexReference,vmReference:z,vReference:D,changeInstance:true});return l({changes:F,vmReference:z,vReference:D,revert:!A,model:M}).then(function(){M.oData[z].originalCurrentVariant=T;M.oData[z].modified=false;M.checkUpdate(true);});}}).then(function(){if(!A){M._callVariantSwitchListeners(z,M.oData[z].currentVariant);}});}.bind(null,E.getParameters(),P),P.model,P.vmReference);}function l(P){var x=P.model._getDirtyChangesFromVariantChanges(P.changes);return Promise.resolve().then(function(){if(P.revert){return R.revertMultipleChanges(x,{appComponent:P.model.oAppComponent,modifier:J,flexController:P.model.oFlexController});}}).then(function(){x.forEach(function(y){V.removeChangeFromVariant({reference:P.model.sFlexReference,change:y,vmReference:P.vmReference,vReference:P.vReference});P.model.oFlexController.deleteChange(y,P.model.oAppComponent);});});}function n(M,x,y){if(y||M.oData[x]){M.oData[x].variantBusy=y;}M.checkUpdate();}function o(x,M,y){M._oVariantSwitchPromise=M._oVariantSwitchPromise.catch(function(){}).then(n.bind(null,M,y,true)).then(x).then(n.bind(null,M,y,false)).catch(function(E){n(M,y,false);throw E;});M.oFlexController.setVariantSwitchPromise(M._oVariantSwitchPromise);return M._oVariantSwitchPromise;}function r(P){return S.switchVariant(P).then(function(){delete this.oData[P.vmReference];}.bind(this)).catch(function(E){L.warning(E.message);});}function s(P,x){return S.switchVariant(P).then(function(){this.oData[P.vmReference].originalCurrentVariant=P.newVReference;this.oData[P.vmReference].currentVariant=P.newVReference;if(this.oData[P.vmReference].updateVariantInURL){U.updateVariantInURL({vmReference:P.vmReference,newVReference:P.newVReference,model:this});}this._callVariantSwitchListeners(P.vmReference,P.newVReference,undefined,x);this.checkUpdate();}.bind(this));}function u(x){h.getInstance().then(function(y){if(!y.isVariantPersonalizationEnabled()){x.remove=false;x.rename=false;x.change=false;}});}function p(x,y,D){var z=D?f.getCurrentLayer():d.USER;if((x.layer===z)&&(x.key!==y)){return true;}return false;}function w(x){return new Promise(function(y){if(x.getDomRef()){y();}else{x.addEventDelegate({onAfterRendering:function(){y();}});}});}var q=j.extend("sap.ui.fl.variants.VariantModel",{constructor:function(D,F,A,x){this.pSequentialImportCompleted=Promise.resolve();j.apply(this,arguments);this.bObserve=x;if(!F){F=sap.ui.requireSync("sap/ui/fl/FlexControllerFactory").createForControl(A);}this.oFlexController=F;this.oChangePersistence=this.oFlexController._oChangePersistence;this.sFlexReference=this.oChangePersistence.getComponentName();this.oAppComponent=A;this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.fl");this._oVariantSwitchPromise=Promise.resolve();this._oVariantAppliedListeners={};if(a(D)){try{D=V.fillVariantModel({reference:this.sFlexReference});}catch(E){L.error("Variants Map was not found: "+E.message);}}if(D&&typeof D==="object"){Object.keys(D).forEach(function(K){D[K].variants.forEach(function(y){if(!D[K].currentVariant&&(y.key===D[K].defaultVariant)){D[K].currentVariant=y.key;}y.originalTitle=y.title;y.originalFavorite=y.favorite;y.originalExecuteOnSelect=y.executeOnSelect;y.originalVisible=y.visible;});D[K].originalCurrentVariant=D[K].currentVariant;D[K].originalDefaultVariant=D[K].defaultVariant;});this.setData(D);}U.initialize({model:this});}});q.prototype.updateCurrentVariant=function(P){var x={vmReference:P.variantManagementReference,currentVReference:this.oData[P.variantManagementReference].originalCurrentVariant,newVReference:P.newVariantReference,flexController:this.oFlexController,appComponent:P.appComponent||this.oAppComponent,modifier:J,reference:this.sFlexReference};if(P.internallyCalled){return s.call(this,x,P.scenario);}return o(s.bind(this,x,P.scenario),this,P.variantManagementReference);};q.prototype.getCurrentVariantReference=function(x){return this.oData[x].currentVariant;};q.prototype.getVariantManagementReference=function(x){var y="";var I=-1;Object.keys(this.oData).some(function(K){return this.oData[K].variants.some(function(z,A){if(z.key===x){y=K;I=A;return true;}});}.bind(this));return{variantManagementReference:y,variantIndex:I};};q.prototype.getVariant=function(x,y){return V.getVariant({reference:this.sFlexReference,vmReference:y||this.getVariantManagementReference(x).variantManagementReference,vReference:x});};q.prototype.getVariantProperty=function(x,P){return this.getVariant(x).content.content[P];};function t(x){var y=V.getVariantChangesForVariant({vmReference:x,reference:this.sFlexReference});var z=this.oData[x].currentVariant;var D=this.oData[x].defaultVariant;if(this.oData[x]._executeOnSelectionForStandardDefault&&z===D&&z===x&&!y.setExecuteOnSelect){var A=V.getVariant({reference:this.sFlexReference,vmReference:x,vReference:x});A.content.content.executeOnSelect=true;this.oData[x].variants[0].originalExecuteOnSelect=true;this.oData[x].variants[0].executeOnSelect=true;return true;}}q.prototype.attachVariantApplied=function(P){var x=this.getVariantManagementReferenceForControl(sap.ui.getCore().byId(P.vmControlId));return this.waitForVMControlInit(x).then(function(x,P){if(!this._oVariantAppliedListeners[x]){this._oVariantAppliedListeners[x]={};}var I=t.call(this,x);if(P.callAfterInitialVariant||I){var y={appComponent:this.oAppComponent,reference:this.sFlexReference,vmReference:x,flexController:this.oFlexController};V.waitForInitialVariantChanges(y).then(function(){var z=V.getCurrentVariantReference({vmReference:x,reference:this.sFlexReference});this._callVariantSwitchListeners(x,z,P.callback);}.bind(this));}return w(P.control).then(function(){if(b.getRelevantVariantManagementControlId(P.control,this.getVariantManagementControlIds())===P.vmControlId){this.oData[x].showExecuteOnSelection=true;this.checkUpdate(true);this._oVariantAppliedListeners[x][P.control.getId()]=P.callback;}else{L.error("Error in attachVariantApplied: The passed VariantManagement ID does not match the responsible VariantManagement control");}}.bind(this));}.bind(this,x,P));};q.prototype._callVariantSwitchListeners=function(x,N,y,z){if(this._oVariantAppliedListeners[x]){var A;this.oData[x].variants.some(function(D){if(D.key===N){A=m({},D);return true;}});if(z){A.createScenario=z;}if(y){y(A);}else{e(this._oVariantAppliedListeners[x],function(D,y){y(A);});}}};q.prototype.detachVariantApplied=function(x,y){var z=this.getVariantManagementReferenceForControl(sap.ui.getCore().byId(x));if(this._oVariantAppliedListeners[z]){delete this._oVariantAppliedListeners[z][y];}};q.prototype.addChange=function(x){var y=x.getVariantReference();var z=this.getVariantManagementReference(y).variantManagementReference;if(x.getState()===C.states.NEW){this.oData[z].modified=true;}this.checkUpdate(true);return V.addChangeToVariant({reference:this.sFlexReference,change:x,vmReference:z,vReference:y});};q.prototype.removeChange=function(x){var y=x.getVariantReference();var z=this.getVariantManagementReference(y).variantManagementReference;var A=V.removeChangeFromVariant({reference:this.sFlexReference,change:x,vmReference:z,vReference:y});this.checkDirtyStateForControlModels([z]);return A;};q.prototype._getVariantTitleCount=function(N,x){var D=this.getData();return D[x].variants.reduce(function(y,z){if(N.toLowerCase()===z.title.toLowerCase()&&z.visible){y++;}return y;},0);};q.prototype._duplicateVariant=function(P){var N=P.newVariantReference;var x=P.sourceVariantReference;var y=P.variantManagementReference;var z=this.getVariant(x);var A=V.getControlChangesForVariant({vmReference:y,vReference:x,changeInstance:true,reference:this.sFlexReference}).map(function(H){return H.getDefinition();});var D={content:{},controlChanges:A,variantChanges:{}};var E=f.compareAgainstCurrentLayer(z.content.layer,!this._bDesignTimeMode?d.USER:"");Object.keys(z.content).forEach(function(K){if(K==="fileName"){D.content[K]=N;}else if(K==="variantReference"){if(E===0){D.content[K]=z.content["variantReference"];}else if(E===-1){D.content[K]=x;}}else if(K==="content"){D.content[K]=JSON.parse(JSON.stringify(z.content[K]));D.content.content.title=P.title;}else{D.content[K]=z.content[K];}});D.content["layer"]=P.layer;A=D.controlChanges.slice();var F={};var G;D.controlChanges=A.reduce(function(H,I){if(f.compareAgainstCurrentLayer(I.layer,!this._bDesignTimeMode?d.USER:"")===0){F=m({},I);F.variantReference=D.content.fileName;if(!F.support){F.support={};}F.support.sourceChangeFileName=I.fileName;F.packageName="$TMP";G=C.createInitialFileContent(F);H.push(new C(G));}return H;}.bind(this),[]);return D;};q.prototype.copyVariant=function(P){var D=this._duplicateVariant(P);D.generator=P.generator;var x={key:D.content.fileName,layer:P.layer,title:D.content.content.title,originalTitle:D.content.content.title,originalExecuteOnSelect:D.content.content.executeOnSelect,executeOnSelect:false,favorite:true,originalFavorite:true,rename:true,change:true,remove:true,visible:true,originalVisible:true};var y=b.createVariant({model:this,variantSpecificData:D});var z=[];[y].concat(y.getControlChanges()).forEach(function(A){z.push(this.oChangePersistence.addDirtyChange(A));}.bind(this));var I=V.addVariantToVariantManagement({variantData:m({},y.getDefinitionWithChanges(),{content:{content:{visible:x.visible,favorite:x.favorite}}}),reference:this.sFlexReference,vmReference:P.variantManagementReference});this.oData[P.variantManagementReference].variants.splice(I,0,x);return this.updateCurrentVariant({variantManagementReference:P.variantManagementReference,newVariantReference:y.getId(),appComponent:P.appComponent,internallyCalled:true,scenario:"saveAs"}).then(function(){return z;});};q.prototype.removeVariant=function(P){var x=this.oChangePersistence.getDirtyChanges().filter(function(y){return(y.getVariantReference&&y.getVariantReference()===P.variant.getId())||y.getId()===P.variant.getId();});return this.updateCurrentVariant({variantManagementReference:P.variantManagementReference,newVariantReference:P.sourceVariantReference,appComponent:P.component}).then(function(){var I=V.removeVariantFromVariantManagement({reference:this.sFlexReference,variant:P.variant,vmReference:P.variantManagementReference});this.oData[P.variantManagementReference].variants.splice(I,1);this.checkUpdate();x.forEach(function(y){this.oChangePersistence.deleteChange(y);}.bind(this));}.bind(this));};q.prototype.collectModelChanges=function(x,y){var D=this.getData()[x];var M=D.variants;var z=[];var P={};M.forEach(function(A){if(A.originalTitle!==A.title){P={variantReference:A.key,changeType:"setTitle",title:A.title,originalTitle:A.originalTitle,layer:y};z.push(P);}if(A.originalFavorite!==A.favorite){P={variantReference:A.key,changeType:"setFavorite",favorite:A.favorite,originalFavorite:A.originalFavorite,layer:y};z.push(P);}if(A.originalExecuteOnSelect!==A.executeOnSelect){P={variantReference:A.key,changeType:"setExecuteOnSelect",executeOnSelect:A.executeOnSelect,originalExecuteOnSelect:A.originalExecuteOnSelect,layer:y};z.push(P);}if(!A.visible&&A.originalVisible){P={variantReference:A.key,changeType:"setVisible",visible:false,layer:y};z.push(P);}});if(D.originalDefaultVariant!==D.defaultVariant){P={variantManagementReference:x,changeType:"setDefault",defaultVariant:D.defaultVariant,originalDefaultVariant:D.originalDefaultVariant,layer:y};z.push(P);}return z;};q.prototype.manageVariants=function(x,y,z,A){return new Promise(function(D){x.attachEventOnce("manage",{resolve:D,variantManagementReference:y,layer:z},this.fnManageClickRta,this);x.openManagementDialog(true,A);}.bind(this));};q.prototype.setVariantProperties=function(x,P,A){var y=-1;var z;var D=null;var E=this.getData();if(P.variantReference){y=this.getVariantManagementReference(P.variantReference).variantIndex;z=E[x].variants[y];}var N={};var F={};switch(P.changeType){case"setTitle":F.title=P.title;z.title=P.title;z.originalTitle=z.title;break;case"setFavorite":F.favorite=P.favorite;z.favorite=P.favorite;z.originalFavorite=z.favorite;break;case"setExecuteOnSelect":F.executeOnSelect=P.executeOnSelect;if(z){z.executeOnSelect=P.executeOnSelect;z.originalExecuteOnSelect=z.executeOnSelect;}break;case"setVisible":F.visible=P.visible;F.createdByReset=false;z.visible=P.visible;z.originalVisible=z.visible;break;case"setDefault":F.defaultVariant=P.defaultVariant;E[x].defaultVariant=P.defaultVariant;E[x].originalDefaultVariant=E[x].defaultVariant;var H=U.getStoredHashParams({model:this});if(H){if(E[x].defaultVariant!==E[x].currentVariant&&H.indexOf(E[x].currentVariant)===-1){U.update({parameters:H.concat(E[x].currentVariant),updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}else if(E[x].defaultVariant===E[x].currentVariant&&H.indexOf(E[x].currentVariant)>-1){H.splice(H.indexOf(E[x].currentVariant),1);U.update({parameters:H,updateURL:!this._bDesignTimeMode,updateHashEntry:true,model:this});}}if(!A&&E[x].currentVariant!==P.defaultVariant){this.updateCurrentVariant({variantManagementReference:x,newVariantReference:P.defaultVariant,appComponent:P.appComponent});}break;default:break;}var G=V.getContent(this.sFlexReference);if(y>-1){var I=V.setVariantData({variantData:F,vmReference:x,previousIndex:y,reference:this.sFlexReference});E[x].variants.splice(y,1);E[x].variants.splice(I,0,z);}else if(G[x]){G[x].defaultVariant=P.defaultVariant;}var K={vmReference:x,add:A,reference:this.sFlexReference};if(A===true){N.changeType=P.changeType;N.layer=P.layer;N.generator=P.generator;if(P.changeType==="setDefault"){N.fileType="ctrl_variant_management_change";N.selector=J.getSelector(x,P.appComponent);}else{if(P.changeType==="setTitle"){c.setTextInChange(N,"title",P.title,"XFLD");}N.fileType="ctrl_variant_change";N.selector=J.getSelector(P.variantReference,P.appComponent);}D=this.oFlexController.createBaseChange(N,P.appComponent);D.setContent(F);K.changeContent=D.getDefinition();V.updateChangesForVariantManagementInMap(K);this.oChangePersistence.addDirtyChange(D);}else if(P.change){K.changeContent=P.change.getDefinition();V.updateChangesForVariantManagementInMap(K);this.oChangePersistence.deleteChange(P.change);}this.setData(E);this.checkUpdate(true);return D;};q.prototype._ensureStandardVariantExists=function(x){var D=this.getData();var y=D[x]||{};var z=_(y,["initPromise"]);if(!D[x]||a(z)){D[x]=m(y,{currentVariant:x,originalCurrentVariant:x,defaultVariant:x,originalDefaultVariant:x,variants:[{key:x,title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),originalTitle:this._oResourceBundle.getText("STANDARD_VARIANT_ORIGINAL_TITLE"),favorite:true,originalFavorite:true,executeOnSelect:false,originalExecuteOnSelect:false,visible:true,originalVisible:true,author:b.DEFAULT_AUTHOR}]});this.setData(D);var A={};A[x]={defaultVariant:x,variantManagementChanges:{},variants:[{content:{fileName:x,fileType:"ctrl_variant",variantManagementReference:x,variantReference:"",support:{user:b.DEFAULT_AUTHOR},content:{title:this._oResourceBundle.getText("STANDARD_VARIANT_TITLE"),favorite:true,visible:true,executeOnSelect:false}},controlChanges:[],variantChanges:{}}]};try{V.addFakeStandardVariant(this.sFlexReference,A);}catch(E){L.error("Variants Map was not found: "+E.message);}}};q.prototype.setModelPropertiesForControl=function(x,D,y){this.oData[x].modified=false;this.oData[x].showFavorites=true;var z=this._bDesignTimeMode;if(z!==D){this._bDesignTimeMode=D;if(D){U.clearAllVariantURLParameters({model:this});}else if(z){U.update({parameters:U.getStoredHashParams({model:this}),updateURL:true,updateHashEntry:false,model:this});}}if(!(typeof this.fnManageClick==="function"&&typeof this.fnManageClickRta==="function")){this._initializeManageVariantsEvents();}y.detachManage(this.fnManageClick,this);if(D&&this.oData[x]._isEditable){this.oData[x].variantsEditable=false;this.oData[x].variants.forEach(function(A){A.rename=true;A.change=true;A.remove=p(A,x,D);});}else if(this.oData[x]._isEditable){y.attachManage({variantManagementReference:x},this.fnManageClick,this);this.oData[x].variantsEditable=true;this.oData[x].variants.forEach(function(A){A.remove=p(A,x,D);if(A.layer===d.USER){A.rename=true;A.change=true;u(A);}else{A.rename=false;A.change=false;}});}else{this.oData[x].variantsEditable=false;this.oData[x].variants.forEach(function(A){A.remove=false;A.rename=false;A.change=false;});}};q.prototype._initializeManageVariantsEvents=function(){this.fnManageClickRta=function(E,D){var x=this.collectModelChanges(D.variantManagementReference,D.layer);D.resolve(x);};this.fnManageClick=function(E,D){if(!this.oFlexController||!V.getContent(this.sFlexReference)){return;}var x=this.collectModelChanges(D.variantManagementReference,d.USER);var y=[];x.forEach(function(z){z.appComponent=this.oAppComponent;y.push(this.setVariantProperties(D.variantManagementReference,z,true));}.bind(this));this.oChangePersistence.saveDirtyChanges(this.oAppComponent,false,y);};};function v(F,x,y,A){if(!this._bDesignTimeMode){return F.saveSequenceOfDirtyChanges(x,A).then(function(z){if(z){var D=z.response[0];this.oData[y].variants.forEach(function(E){if(E.key===D.fileName){E.author=D.support.user;}});}}.bind(this));}return Promise.resolve();}q.prototype._handleSaveEvent=function(E){if(!this._bDesignTimeMode){var x=E.getSource();var P=E.getParameters();return this._handleSave(x,P);}return Promise.resolve();};q.prototype._handleSave=function(x,P){var A=g.getAppComponentForControl(x);var y=this.getLocalId(x.getId(),A);var N;return o(function(z,A,P){var D=P.def;var E=P.execute;var F=this.getCurrentVariantReference(z);var G=V.getControlChangesForVariant({reference:this.sFlexReference,vmReference:z,vReference:F,changeInstance:true});if(P["overwrite"]){return this.oFlexController.saveSequenceOfDirtyChanges(this._getDirtyChangesFromVariantChanges(G),A);}var H=P.layer||d.USER;var I=P.newVariantReference||g.createDefaultFileName();var K={variantManagementReference:z,appComponent:A,layer:H,title:P["name"],sourceVariantReference:F,newVariantReference:I,generator:P.generator};return this.copyVariant(K).then(function(M){if(D){var Q={changeType:"setDefault",defaultVariant:I,originalDefaultVariant:this.oData[z].defaultVariant,appComponent:A,layer:H,variantManagementReference:z};var T=this.setVariantProperties(z,Q,true);M.push(T);}if(E){var W={changeType:"setExecuteOnSelect",executeOnSelect:true,variantReference:I,appComponent:A,layer:H,variantManagementReference:z};var X=this.setVariantProperties(z,W,true);M.push(X);}N=M;return l({changes:G,vmReference:z,vReference:F,model:this}).then(v.bind(this,this.oFlexController,M,z,A));}.bind(this));}.bind(this,y,A,P),this,y).then(function(){this.oData[y].modified=false;this.checkUpdate(true);return N;}.bind(this));};q.prototype.getLocalId=function(I,A){return J.getSelector(I,A).id;};q.prototype.getVariantManagementReferenceForControl=function(x){var y=x.getId();var A=g.getAppComponentForControl(x);return(A&&A.getLocalId(y))||y;};q.prototype.switchToDefaultForVariantManagement=function(x){if(this.oData[x].currentVariant!==this.oData[x].defaultVariant){B.show(200);this.updateCurrentVariant({variantManagementReference:x,newVariantReference:this.oData[x].defaultVariant}).then(function(){B.hide();});}};q.prototype.switchToDefaultForVariant=function(x){Object.keys(this.oData).forEach(function(y){if(!x||this.oData[y].currentVariant===x){this.switchToDefaultForVariantManagement(y);}}.bind(this));};q.prototype.registerToModel=function(x){var y=this.getVariantManagementReferenceForControl(x);this._ensureStandardVariantExists(y);this.oData[y]._isEditable=x.getEditable();this.oData[y]._executeOnSelectionForStandardDefault=x.getExecuteOnSelectionForStandardDefault();this.oData[y].showExecuteOnSelection=false;x.attachEvent("select",{vmReference:y,model:this},k);x.attachSave(this._handleSaveEvent,this);this.setModelPropertiesForControl(y,false,x);var z=x.getUpdateVariantInURL();this.oData[y].updateVariantInURL=z;U.registerControl({vmReference:y,updateURL:!!z,model:this});U.handleModelContextChange({model:this,vmControl:x});if(this.oData[y].initPromise){this.oData[y].initPromise.resolveFunction();delete this.oData[y].initPromise;}this.oData[y].init=true;};q.prototype.waitForVMControlInit=function(x){if(!this.oData[x]){this.oData[x]={};}else if(this.oData[x].init){return Promise.resolve();}this.oData[x].initPromise={};this.oData[x].initPromise.promise=new Promise(function(y){this.oData[x].initPromise.resolveFunction=y;}.bind(this));return this.oData[x].initPromise.promise;};q.prototype._getDirtyChangesFromVariantChanges=function(x){var y=x.map(function(z){return z.getDefinition().fileName;});return this.oChangePersistence.getDirtyChanges().filter(function(z){return i(y,z.getId())&&!z.assignedToVariant;});};q.prototype.checkDirtyStateForControlModels=function(x){x.forEach(function(y){var z=this.oData[y];var A=this.getCurrentVariantReference(y);var D=V.getControlChangesForVariant({reference:this.sFlexReference,vmReference:y,vReference:A,changeInstance:true});var E=this._getDirtyChangesFromVariantChanges(D);z.modified=E.length>0;}.bind(this));this.checkUpdate(true);};q.prototype.getCurrentControlVariantIds=function(){return Object.keys(this.oData||{}).reduce(function(x,y){return x.concat([this.oData[y].currentVariant]);}.bind(this),[]);};q.prototype.getVariantManagementControlIds=function(){var x;return Object.keys(this.oData||{}).reduce(function(y,z){if(this.oAppComponent.byId(z)){x=this.oAppComponent.createId(z);}else{x=z;}y.push(x);return y;}.bind(this),[]);};q.prototype.resetMap=function(x){var y=Object.keys(this.oData);y.forEach(function(z){var P={vmReference:z,currentVReference:this.oData[z].currentVariant||this.oData[z].defaultVariant,newVReference:true,appComponent:this.oAppComponent,flexController:this.oFlexController,modifier:J,reference:this.sFlexReference};return o(r.bind(this,P),this,z);}.bind(this));return this._oVariantSwitchPromise.then(function(){V.clearFakedStandardVariants(this.sFlexReference);V.resetContent(this.sFlexReference);if(!x){U.initialize({model:this});U.update({parameters:[],updateHashEntry:true,model:this});}}.bind(this));};return q;});
