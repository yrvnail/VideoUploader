/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/fl/write/_internal/Storage","sap/ui/fl/Layer","sap/m/MessageStrip","sap/ui/core/MessageType","sap/base/util/restricted/_isEqual"],function(C,F,W,L,M,a,_){"use strict";function b(m){var d={layer:L.CUSTOMER,type:"role"};return Object.assign({},d,m);}function c(s){var p={layer:L.CUSTOMER,flexObjects:s};return W.loadContextDescriptions(p).then(function(r){if(r.role&&r.role.length===s.role.length){this.oSelectedContextsModel.setProperty("/selected",r.role);}}.bind(this));}function l(){return F.load({id:this.getView().getId(),name:"sap.ui.fl.variants.context.view.fragment.AddContextDialog",controller:this}).then(function(d){this.getView().addDependent(d);d._oList.attachUpdateStarted(this._updateStartedHandler.bind(this));d._oList.attachSelectionChange(this._onSelectionChange.bind(this));return d;}.bind(this));}function g(m,p){return W.getContexts(b(m)).then(function(r){if(p){r.values=p.concat(r.values);}this.oContextsModel.setData(r);this.oContextsModel.refresh(true);}.bind(this));}function i(I){return{id:I.getTitle(),description:I.getDescription()};}return C.extend("sap.ui.fl.variants.context.controller.ContextVisibility",{onInit:function(){this.oSelectedContextsModel=this.getView().getModel("selectedContexts");this.oContextsModel=this.getView().getModel("contexts");this.oI18n=this.getView().getModel("i18n").getResourceBundle();},onBeforeRendering:function(){this.oSelectedContextsModel.refresh(true);var s=this.getOwnerComponent().getSelectedContexts();var h=s.role.length>0;this.byId("selectedContextsList").setVisible(h);if(h){return c.call(this,s);}return Promise.resolve();},_onSelectionChange:function(e){var s=i(e.getParameter("listItem"));if(e.getParameter("selected")===true){this.oCurrentSelection.push(s);}else{this.oCurrentSelection=this.oCurrentSelection.filter(function(I){return!_(I,s);});}},isSelected:function(I,s){return s.some(function(S){return S.id===I.id;});},formatSelectedIndex:function(s){return s.length===0?0:1;},formatTooltip:function(d){if(!this.oI18n){this.oI18n=this.getView().getModel("i18n").getResourceBundle();}return d.length===0?this.oI18n.getText("NO_DESCRIPTION"):d;},onSelectRestrictedRadioButton:function(e){e.getSource().setSelected(true);var f=e.getParameters()&&e.getParameters().selected;this.byId("selectedContextsList").setVisible(f);},onSelectPublicRadioButton:function(){this.oSelectedContextsModel.setProperty("/selected",[]);this.showErrorMessage(false);},_appendDataFromBackend:function(){var r=this.oContextsModel.getProperty("/values");if(this.oContextsModel.getProperty("/lastHitReached")===false){var m={$skip:r.length};return g.call(this,m,r);}return Promise.resolve(r);},_updateStartedHandler:function(e){if(e.getParameter&&e.getParameter("reason")==="Growing"){return this._appendDataFromBackend();}return Promise.resolve();},_addContexts:function(d){d.clearSelection();this.oCurrentSelection=this.oSelectedContextsModel.getProperty("/selected")||[];return g.call(this,{}).then(function(){return d.open();});},onAddContextsHandler:function(){if(!this._oDialog){this._oDialog=l.call(this);}return this._oDialog.then(function(d){return this._addContexts(d);}.bind(this));},onSearch:function(e){e.getSource().clearSelection();var m={$filter:e.getParameter("value")};return g.call(this,m);},onSelectContexts:function(){this.oSelectedContextsModel.setProperty("/selected",this.oCurrentSelection);this.oCurrentSelection=[];this.showErrorMessage(false);},onDeleteContext:function(e){var I=this.oSelectedContextsModel.getProperty("/selected");var t=e.getParameter("listItem");var n=I.filter(function(d){return d.id!==t.getTitle();});this.oSelectedContextsModel.setProperty("/selected",n);var o=e.getSource();o.attachEventOnce("updateFinished",o.focus,o);},removeAll:function(){this.oSelectedContextsModel.setProperty("/selected",[]);},showErrorMessage:function(s){var e=this.getView().getId()+"--noSelectedRolesError";var E=sap.ui.getCore().byId(e);if(E){E.destroy();}if(s){E=new M(e,{text:this.oI18n.getText("SELECTED_ROLES_ERROR"),type:a.Error,showIcon:true});this.byId("visibilityPanel").insertContent(E,1);}},isRemoveAllEnabled:function(s){return s.length!==0;}});});
