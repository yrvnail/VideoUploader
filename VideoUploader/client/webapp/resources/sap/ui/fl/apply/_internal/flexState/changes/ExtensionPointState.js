/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/ChangePersistenceFactory","sap/base/util/restricted/_omit","sap/base/util/merge","sap/base/Log"],function(C,a,_,m,L){"use strict";var E={};function i(c,p,o){if(o.getSelector().name!==p.extensionPointName){return false;}return c.changesHavingCorrectViewPrefix(p,o);}function b(c,e){if(e.fragmentId){var o=c.getExtensionPointInfo&&c.getExtensionPointInfo();if(o){return e.fragmentId!==o.fragmentId;}return true;}return false;}function r(c,e,o){var s=c.getSelector();if(e.closestAggregationBindingCarrier&&e.closestAggregationBinding){s=m(s,{id:e.closestAggregationBindingCarrier,idIsLocal:false});var d=c.getDefinition();var O={id:e.targetControl.getId(),idIsLocal:false};if(!d.dependentSelector){d.dependentSelector={};}if(o){c.originalSelectorToBeAdjusted=O;}else{d.dependentSelector.originalSelector=O;}d.content.boundAggregation=e.closestAggregationBinding;}else{s=m(s,{id:e.targetControl.getId(),idIsLocal:false});}c.setSelector(s);}E.getChangesForExtensionPoint=function(c,p){if(!p.extensionPointName){L.error("Missing name from extension point info!");return Promise.resolve([]);}return c.getChangesForComponent().then(function(d){return d.filter(i.bind(this,c,p));});};E.enhanceExtensionPointChanges=function(p,e){p.extensionPointName=e.name;var c=a.getChangePersistenceForControl(e.targetControl);return E.getChangesForExtensionPoint(c,p).then(function(d){var P=[];d.forEach(function(o){if(o.isInInitialState()&&!(o.getExtensionPointInfo&&o.getExtensionPointInfo())){o.setExtensionPointInfo(e);r(o,e,false);if(c.isChangeMapCreated()){c.addChangeAndUpdateDependencies(p.appComponent,o);}}else if(b(o,e)){var f=o.getDefinition();var g=_(f,["dependentSelector","fileName","selector","content"]);Object.keys(f.content).forEach(function(k){g[k]=f.content[k];});g.support.sourceChangeFileName=f.fileName||"";P.push(C.create({changeSpecificData:g,selector:{view:e.view,name:e.name}}).then(function(R){r(R,e,true);R.setExtensionPointInfo(e);R.setModuleName(f.moduleName);R.getDefinition().creation=f.creation;c.addChangeAndUpdateDependencies(p.appComponent,R,o);}));}});return Promise.all(P).then(function(){return d;});});};return E;});
