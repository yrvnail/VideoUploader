/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/Log","sap/ui/core/Element","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/changes/FlexCustomData","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/Utils"],function(L,E,J,F,U,D,a){"use strict";var l=new a.FakePromise();function _(C,p){var s=C.getSelector&&C.getSelector();if(!s||(!s.id&&!s.name)){throw Error("No selector in change found or no selector ID.");}var o=p.modifier.bySelector(s,p.appComponent,p.view);if(!o){throw Error("A flexibility change tries to change a nonexistent control.");}var i=C.getDependentControlSelectorList();i.forEach(function(j){var k=p.modifier.bySelector(j,p.appComponent,p.view);if(!k){throw Error("A dependent selector control of the flexibility change is not available.");}});return o;}function b(C,o,m,i,p){var x=f(p);var j=U.getControlIfTemplateAffected(o,C,p);var I=F.hasChangeApplyFinishedCustomData(j.control,o,p.modifier);var k=o.isApplyProcessFinished();if(k&&!I){if(!x){var n=U.checkIfDependencyIsStillValid.bind(null,p.appComponent,p.modifier,m);i._oChangePersistence.copyDependenciesFromInitialChangesMap(o,n,p.appComponent);}o.setInitialApplyState();}else if(!k&&I){o.markFinished();}}function c(C,p){var s;if(f(p)&&C.getDefinition().jsOnly){s="Change cannot be applied in XML. Retrying in JS.";}if(s){C.setInitialApplyState();throw Error(s);}}function d(C,m,i,p){if(i instanceof E){m.control=i;}if(m.control){p.modifier.updateAggregation(m.originalControl,C.getContent().boundAggregation);}F.addAppliedCustomData(m.control,C,p,f(p));var r={success:true};C.markFinished(r);return r;}function e(o,C,m,p){var x=f(p);var r={success:false,error:o};var s=C.getId();var i="Change ''{0}'' could not be applied.";var j=o instanceof Error;var k=F.getCustomDataIdentifier(false,j,x);switch(k){case F.notApplicableChangesCustomDataKey:a.formatAndLogMessage("info",[i,o.message],[s]);break;case F.failedChangesCustomDataKeyXml:a.formatAndLogMessage("warning",[i,"Merge error detected while processing the XML tree."],[s],o.stack);break;case F.failedChangesCustomDataKeyJs:a.formatAndLogMessage("error",[i,"Merge error detected while processing the JS control tree."],[s],o.stack);break;}F.addFailedCustomData(m.control,C,p,k);if(x){C.setInitialApplyState();}else{C.markFinished(r);}return r;}function f(p){return p.modifier.targets==="xmlTree";}function g(o,C){var i=C.getDefinition();var s=i.changeType;var t=i.selector.id;var j=i.namespace+i.fileName+"."+i.fileType;var w="A flexibility change could not be applied.";w+="\nThe displayed UI might not be displayed as intedend.";if(o.message){w+="\n   occurred error message: '"+o.message+"'";}w+="\n   type of change: '"+s+"'";w+="\n   LRep location of the change: "+j;w+="\n   id of targeted control: '"+t+"'.";L.warning(w,undefined,"sap.ui.fl.apply._internal.changes.Applier");}function h(C,o,i){var p={appComponent:i,modifier:J};var j=J.bySelector(C.originalSelectorToBeAdjusted,i);var k=o.getBindingInfo(C.getContent().boundAggregation).template;if(j.getParent()){var s=[];var t=j;do{s.push({aggregation:t.sParentAggregationName,index:t.getParent().getAggregation(t.sParentAggregationName).indexOf(t)});t=t.getParent();}while(t.getParent());s.reverse();s.forEach(function(I){k=k.getAggregation(I.aggregation)[I.index];});}C.addDependentControl(k,"originalSelector",p);}var A={addPreConditionForInitialChangeApplying:function(p){l=l.then(function(){return p;});},applyChangeOnControl:function(C,o,p){var m=U.getControlIfTemplateAffected(C,o,p);return U.getChangeHandler(C,m,p).then(function(i){c(C,p);return i;}).then(function(i){if(C.hasApplyProcessStarted()){return C.addPromiseForApplyProcessing().then(function(r){C.markFinished();return r;});}else if(!C.isApplyProcessFinished()){return new a.FakePromise().then(function(){C.startApplying();return i.applyChange(C,m.control,p);}).then(function(I){return d(C,m,I,p);}).catch(function(j){return e(j,C,m,p);});}var r={success:true};C.markFinished(r);return r;}).catch(function(i){return{success:false,error:i};});},applyAllChangesForControl:function(G,o,i,C){var m=G();var s=C.getId();var j=m.mChanges[s]||[];var p={modifier:J,appComponent:o,view:a.getViewForControl(C)};j.forEach(function(k){b(C,k,m,i,p);if(!k.isApplyProcessFinished()&&!k._ignoreOnce){k.setQueuedForApply();}});l=l.then(function(C,p){var P=[];var s=C.getId();var j=m.mChanges[s]||[];var k;if(m.mControlsWithDependencies[s]){D.removeControlsDependencies(m,s);k=true;}j.forEach(function(n){if(n.originalSelectorToBeAdjusted){h(n,C,o);delete n.originalSelectorToBeAdjusted;}if(n._ignoreOnce){delete n._ignoreOnce;}else if(n.isApplyProcessFinished()){D.resolveDependenciesForChange(m,n.getId(),s);}else if(!m.mDependencies[n.getId()]){P.push(function(){return A.applyChangeOnControl(n,C,p).then(function(){D.resolveDependenciesForChange(m,n.getId(),s);});});}else{var q=A.applyChangeOnControl.bind(A,n,C,p);D.addChangeApplyCallbackToDependency(m,n.getId(),q);}});if(j.length||k){return a.execPromiseQueueSequentially(P).then(function(){return D.processDependentQueue(m,o,s);});}}.bind(null,C,p));return l;},applyAllChangesForXMLView:function(p,C){if(!Array.isArray(C)){var s="No list of changes was passed for processing the flexibility on view: "+p.view+".";L.error(s,undefined,"sap.ui.fl.apply._internal.changes.Applier");C=[];}return C.reduce(function(P,o){return P.then(function(){var i=_(o,p);o.setQueuedForApply();b(i,o,undefined,undefined,p);if(!o.isApplyProcessFinished()){return A.applyChangeOnControl(o,i,p);}return{success:true};}).then(function(r){if(!r.success){throw Error(r.error);}}).catch(function(i){g(i,o);});},new a.FakePromise()).then(function(){return p.view;});}};return A;});
