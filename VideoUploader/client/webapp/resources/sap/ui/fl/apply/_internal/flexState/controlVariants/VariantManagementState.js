/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/restricted/_pick","sap/base/util/includes","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/ObjectPath","sap/base/util/each","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/fl/apply/_internal/controlVariants/Utils","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/Change","sap/ui/fl/LayerUtils","sap/ui/fl/Utils","sap/ui/fl/Variant"],function(_,a,i,b,m,O,e,L,J,V,F,C,c,U,d){"use strict";var f={};var g={};function h(p){var r=[];if(p.variantData.content.variantReference){r=f.getControlChangesForVariant(Object.assign(p,{vReference:p.variantData.content.variantReference,changeInstance:true}));return r.filter(function(R){return c.compareAgainstCurrentLayer(R.getDefinition().layer,p.variantData.content.layer)===-1;});}return r;}function j(p){var v=f.getContent(p.reference);var q=O.get([p.vmReference,"variants"],v);return q||[];}function k(v,p,A){var s=p.changeType;if(!v){v={};}if(!v[s]){v[s]=[];}if(A){v[s].push(p);return true;}return v[s].some(function(E,I){if(E.fileName===p.fileName){v[s].splice(I,1);return true;}});}function l(p,q){var s=o(p);q[s].push(p);}function n(p,q){var s=o(p);var r=-1;q[s].some(function(E,I){if(E.fileName===p.fileName){r=I;return true;}});if(r>-1){q[s].splice(r,1);}}function o(p){switch(p.fileType){case"change":return"variantDependentControlChanges";case"ctrl_variant":return"variants";case"ctrl_variant_change":return"variantChanges";case"ctrl_variant_management_change":return"variantManagementChanges";default:}}f.getContent=function(r){var v=F.getVariantsState(r);e(g[r],function(s,p){if(!v[s]){v[s]=p;}});return v;};f.addFakeStandardVariant=function(r,s){var v=f.getContent(r);if(!v[Object.keys(s)[0]]){m(v,s);g[r]=g[r]||{};m(g[r],s);}else{L.error("Error in VariantManagementState.addFakeStandardVariant: Variant already in map");}};f.clearFakedStandardVariants=function(r){delete g[r];};f.resetContent=function(r){F.clearFilteredResponse(r);};f.getControlChangesForVariant=function(p){var r=[];var v=f.getVariant(p);if(v){r=v.controlChanges;if(!p.changeInstance){r=r.map(function(q){return q.getDefinition();});}}return r;};f.getVariantChangesForVariant=function(p){var v=f.getVariant(p);return v&&v.variantChanges||{};};f.getVariant=function(p){var v;var q=f.getContent(p.reference);p.vReference=p.vReference||q[p.vmReference].defaultVariant;var r=j(p);r.some(function(s){if(s.content.fileName===p.vReference){v=s;return true;}});return v;};f.getCurrentVariantReference=function(p){var v=f.getContent(p.reference);var q=v[p.vmReference];return q.currentVariant||q.defaultVariant;};f.getVariantManagementReferences=function(r){var v=f.getContent(r);return Object.keys(v);};f.addVariantToVariantManagement=function(p){var v=f.getContent(p.reference);var q=v[p.vmReference].variants.slice().splice(1);var I=V.getIndexToSortVariant(q,p.variantData);if(p.variantData.content.variantReference){var r=h(p);p.variantData.controlChanges=r.concat(p.variantData.controlChanges);}v[p.vmReference].variants.splice(I+1,0,p.variantData);return I+1;};f.removeVariantFromVariantManagement=function(p){var I;var v=f.getContent(p.reference);var q=v[p.vmReference].variants.some(function(r,s){var t=new d(r);if(t.getId()===p.variant.getId()){I=s;return true;}});if(q){v[p.vmReference].variants.splice(I,1);}return I;};f.setVariantData=function(p){var v=f.getContent(p.reference);var q=v[p.vmReference].variants;var r=q[p.previousIndex];Object.keys(p.variantData).forEach(function(P){if(r.content.content[P]){r.content.content[P]=p.variantData[P];}});if(r.content.fileName!==p.vmReference){q.splice(p.previousIndex,1);var s=V.getIndexToSortVariant(q.slice(1),r);q.splice(s+1,0,r);return s+1;}q.splice(p.previousIndex,1,r);return p.previousIndex;};f.addChangeToVariant=function(p){var E=f.getControlChangesForVariant(Object.assign(p,{changeInstance:true}));var q=E.map(function(r){return r.getDefinition().fileName;});if(!i(q,p.change.getDefinition().fileName)){var v=f.getVariant(p);v.controlChanges=E.concat([p.change]);return true;}return false;};f.removeChangeFromVariant=function(p){var q=f.getControlChangesForVariant(Object.assign(p,{changeInstance:true}));var v=f.getVariant(p);var r=false;if(v){v.controlChanges=q.filter(function(s){if(!r&&s.getId()===p.change.getId()){r=true;return false;}return true;});}return r;};f.getInitialChanges=function(p){var v=f.getContent(p.reference);return Object.keys(v).reduce(function(I,s){if((p.vmReference&&p.vmReference===s)||!p.vmReference){var q=v[s].currentVariant?"currentVariant":"defaultVariant";var A={vmReference:s,vReference:v[s][q],reference:p.reference,changeInstance:p.changeInstance};return I.concat(f.getControlChangesForVariant(Object.assign({},p,A)));}return I;},[]);};f.fillVariantModel=function(p){var v=f.getContent(p.reference);return Object.keys(v).reduce(function(q,s){q[s]={defaultVariant:v[s].defaultVariant,variants:[]};if(v[s].currentVariant){q[s].currentVariant=v[s].currentVariant;}j(Object.assign(p,{vmReference:s})).forEach(function(r,t){q[s].variants[t]=JSON.parse(JSON.stringify({key:r.content.fileName,title:r.content.content.title,layer:r.content.layer,favorite:r.content.content.favorite,executeOnSelect:r.content.content.executeOnSelect,visible:r.content.content.visible,author:O.get("content.support.user",r)}));});return q;},{});};f.updateChangesForVariantManagementInMap=function(p){var v=f.getContent(p.reference);var q=v[p.vmReference];if(p.changeContent.fileType==="ctrl_variant_change"){q.variants.some(function(r){if(r.content.fileName===p.changeContent.selector.id){k(r.variantChanges,p.changeContent,p.add);}});}else if(p.changeContent.fileType==="ctrl_variant_management_change"){k(q.variantManagementChanges,p.changeContent,p.add);}};f.setCurrentVariant=function(p){var v=f.getContent(p.reference);if(O.get([p.vmReference],v)){v[p.vmReference].currentVariant=p.newVReference;}};f.updateVariantsState=function(p){var v=f.getContent(p.reference);if(b(v)){L.error("Variant state is not initialized yet");return;}var q=F.getFlexObjectsFromStorageResponse(p.reference);if(p.changeToBeAddedOrDeleted){switch(p.changeToBeAddedOrDeleted.getPendingAction()){case"NEW":l(p.changeToBeAddedOrDeleted.getDefinition(),q);break;case"DELETE":n(p.changeToBeAddedOrDeleted.getDefinition(),q);break;default:}}};f.waitForInitialVariantChanges=function(p){var q=f.getInitialChanges({vmReference:p.vmReference,reference:p.reference,changeInstance:true});var s=q.reduce(function(t,u){if(U.indexOfObject(t,u.getSelector())===-1){t.push(u.getSelector());}return t;},[]);var r=[];s.map(function(S){var t=J.bySelector(S,p.appComponent);if(t){r.push(t);}});return p.flexController.waitForChangesToBeApplied(r);};return f;});
