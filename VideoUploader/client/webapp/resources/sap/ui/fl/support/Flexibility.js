/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/support/Plugin","sap/ui/core/support/Support","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/model/json/JSONModel","sap/ui/fl/FlexController","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/Utils","sap/ui/fl/support/apps/uiFlexibilityDiagnostics/helper/Extractor","sap/ui/core/mvc/XMLView"],function(q,P,S,J,a,F,C,U,E,X){"use strict";var b=P.extend("sap.ui.fl.support.Flexibility",{constructor:function(s){P.apply(this,["sapUiSupportFlexibility","Flexibility",s]);this._oStub=s;if(this.runsAsToolPlugin()){this._aEventIds=[this.getId()+"SetApps",this.getId()+"SetChangesMaps"];}else{this._aEventIds=[this.getId()+"GetApps",this.getId()+"GetChangesMaps"];}}});b.prototype.sDelimiter=";";b.prototype.init=function(s){P.prototype.init.apply(this,arguments);var p="<div class='sapUiSmallMargin'>The applications listed below have been handled by the sap.ui.fl library in this session.</div>"+"<div class='sapUiSmallMarginBegin'>You can download a file containing the data that has been applied to an application as well as "+"relevant runtime information, and then upload this file to the UI Flexibility Diagnostics application for further investigation.</div>"+"<div class='sapUiSmallMarginBegin'>The UI Flexibility Diagnostics application displays graphs and is only available with SAPUI5.</div>";if(s.isToolStub()){this.addStylesheet("sap/ui/fl/support/flexibility");this.oChangesModel=new a();this.oAppModel=new a();this.oToolSettings=new a({hideDependingChanges:false,panelInfoText:p});this.oChangeDetails=new a();this._renderToolPlugin([]);S.getStub().sendEvent(this.getId()+"GetApps",{});}else{this.onsapUiSupportFlexibilityGetApps();}};b.prototype._renderToolPlugin=function(){var _=function(){var r=sap.ui.getCore().createRenderManager();r.write("<div id='"+this.getId()+"-FlexCacheArea' class='sapUiSizeCompact'></div>");r.flush(this.$().get(0));r.destroy();}.bind(this);var c=function(){this.oViewPromise=X.create({viewName:"sap.ui.fl.support.diagnostics.Flexibility",viewData:{plugin:this}}).then(function(v){this.oView=v;this.oView.placeAt(this.getId()+"-FlexCacheArea");this.oView.setModel(this.oAppModel,"flexApps");this.oView.setModel(this.oToolSettings,"flexToolSettings");this.oView.setModel(this.oChangesModel,"flexChanges");this.oView.setModel(this.oChangeDetails,"flexChangeDetails");}.bind(this));}.bind(this);_();c();};b.prototype.onRefresh=function(){S.getStub().sendEvent(this.getId()+"GetApps",{});};b.prototype.onsapUiSupportFlexibilityGetApps=function(){var A=[];if(C._instanceCache){q.each(C._instanceCache,function(r,c){A.push({key:r,text:r,data:E.extractData(c)});});}this._oStub.sendEvent(this.getId()+"SetApps",A);};b.prototype.onsapUiSupportFlexibilityGetChangesMaps=function(e){var A=e.mParameters.appKey;var c=A.split(this.sDelimiter);var s=c[0];this._getChangesMapForApp(s);};b.prototype.onsapUiSupportFlexibilitySetApps=function(e){var A=e.getParameters();this.oAppModel.setData(A);};b.prototype.onsapUiSupportFlexibilitySetChangesMaps=function(e){var c=e.getParameters();this.oChangesModel.setData(c);this.oView.byId("Tree").expandToLevel(1000);};b.prototype.exit=function(){P.prototype.exit.apply(this,arguments);};b.prototype._getChangesMapForApp=function(A){function _(m,s){h[s]=[];var j=i[s];var k=sap.ui.getCore().byId(s);var l=[];var n=[];var p=[];if(k){if(k.data(F.appliedChangesCustomDataKey)){l=k.data(F.appliedChangesCustomDataKey).split(",");}if(k.data(F.failedChangesCustomDataKeyJs)){n=k.data(F.failedChangesCustomDataKeyJs).split(",");}if(k.data(F.failedChangesCustomDataKeyXml)){p=k.data(F.failedChangesCustomDataKeyXml).split(",");}}h[s]=j.map(c.bind(this,k,l,n,p,m));}function c(j,k,l,n,m,p){var r={id:p.getId(),changeType:p.getChangeType(),selector:p.getSelector(),controlPresent:!!j,indexInAppliedChanges:undefined,indexOfFirstFailing:undefined,dependentControls:[],dependentChanges:[],someDirectDependingChangesFailed:false,someDirectDependingChangesNotApplied:false,isInSubTree:false};var s=l.concat(n);if(r.controlPresent&&k.indexOf(p.getId())>-1){r.indexInAppliedChanges=k.indexOf(p.getId());}if(r.controlPresent&&l.indexOf(p.getId())>-1){r.modifier="JS";r.indexOfFirstFailing=s.indexOf(p.getId());}if(r.controlPresent&&n.indexOf(p.getId())>-1){r.modifier="XML";r.indexOfFirstFailing=s.indexOf(p.getId());}if(p._aDependentSelectorList){var u=E.getAppComponentInstance(A);r.dependentControls=p._aDependentSelectorList.map(function(v){return{id:v.id,controlPresent:J.bySelector(v,u)};});}m[p.getId()]=r;return r;}function d(j,k,l){var n=l.dependencies;if(n.indexOf(j.id)!==-1){var s=JSON.stringify(m[k].selector)===JSON.stringify(j.selector);j.isInSubTree=j.isInSubTree||s;}}function e(s,j){j.forEach(function(k){q.each(D,d.bind(this,k));k.allDependendingControlsPresent=k.dependentControls.every(function(l){return l.controlPresent;});if(D[k.id]&&D[k.id].dependencies){D[k.id].dependencies.forEach(function(l){var n=m[l];var p=n.indexInAppliedChanges===undefined;n=m[l];k.someDirectDependingChangesNotApplied=k.someDirectDependingChangesNotApplied||p;var r=n.indexOfFirstFailing===undefined;var u=r&&p;k.someDirectDependingChangesFailed=k.someDirectDependingChangesFailed||r;k.someDirectDependingChangesNotSuccessfulApplied=k.someDirectDependingChangesNotSuccessfulApplied||u;k.dependentChanges.push(n);});}k.isApplicable=!k.someDirectDependingChangesNotApplied&&k.controlPresent&&k.allDependendingControlsPresent&&!k.someDirectDependingChangesNotApplied;k.isPossibleRootCause=k.isApplicable&&k.indexInAppliedChanges===undefined;});}function f(j){j=j.filter(function(k){return!j.some(function(l){return l.dependentChanges.some(function(n){return n.id===k.id;});});});return j.map(function(k){return{id:k.id,text:k.changeType,nodes:k.dependentChanges?f(k.dependentChanges):[]};});}function g(s,j){t.push({text:s,nodes:f(j)});}var m={};var h={};var t=[];var o=C.getChangePersistenceForComponent(A);var i=o._mChanges.mChanges;var D=o._mChangesInitial.mDependencies;Object.keys(i).forEach(_.bind(this,m));q.each(h,e);q.each(h,g);this._oStub.sendEvent(this.getId()+"SetChangesMaps",{changes:m,tree:t});};return b;});
