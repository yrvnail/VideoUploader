/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/LayerUtils","sap/ui/fl/Layer","sap/ui/fl/Utils","sap/ui/fl/apply/_internal/flexState/ManifestUtils","sap/ui/fl/write/api/VersionsAPI","sap/ui/fl/write/api/FeaturesAPI","sap/ui/fl/write/api/PersistenceWriteAPI","sap/base/util/UriParameters"],function(L,a,U,M,V,F,P){"use strict";function i(o){var u=!!U.getParameter(sap.ui.fl.Versions.UrlParameter);if(u){return Promise.resolve(false);}return F.isVersioningEnabled(o.layer).then(function(v){return v&&V.isDraftAvailable({selector:o.selector,layer:o.layer});});}function b(o){var u=this.hasMaxLayerParameterWithValue({value:o.layer});var d=o.layer===a.USER;if(d||u){return Promise.resolve(false);}return P.hasHigherLayerChanges({selector:o.selector,ignoreMaxLayerParameter:o.ignoreMaxLayerParameter,upToLayer:o.layer,includeCtrlVariants:o.includeCtrlVariants,includeDirtyChanges:true});}function c(o){var C=g(o.selector);if(C!==null){return false;}var p={selector:o.selector,layer:o.layer};return P.getResetAndPublishInfo(p).then(function(d){s(d,o.selector);return!d.allContextsProvided;});}function g(C){var f=M.getFlexReferenceForControl(C);var p=f||"true";var o=JSON.parse(window.sessionStorage.getItem("sap.ui.fl.info."+p));return o&&!o.allContextsProvided;}function s(I,C){var f=M.getFlexReferenceForControl(C);var p=f||"true";window.sessionStorage.setItem("sap.ui.fl.info."+p,JSON.stringify(I));}function r(C){var f=M.getFlexReferenceForControl(C);var p=f||"true";window.sessionStorage.removeItem("sap.ui.fl.info."+p);}var R={getReloadReasonsForStart:function(o){return Promise.all([b.call(this,o),i(o),c(o)]).then(function(d){o.hasHigherLayerChanges=d[0];o.isDraftAvailable=d[1];o.allContexts=d[2];return o;});},hasVersionParameterWithValue:function(p){return U.hasParameterAndValue(sap.ui.fl.Versions.UrlParameter,p.value);},hasMaxLayerParameterWithValue:function(p){var d=L.FL_MAX_LAYER_PARAM;return U.hasParameterAndValue(d,p.value);},handleUrlParametersForStandalone:function(o){if(o.hasHigherLayerChanges){o.parameters=U.handleUrlParameters(o.parameters,L.FL_MAX_LAYER_PARAM,o.layer);}var v=new RegExp("\&*"+sap.ui.fl.Versions.UrlParameter+"=-?\\d*\&?","g");o.parameters=o.parameters.replace(v,"");if(o.isDraftAvailable&&!o.onExit){o.parameters=U.handleUrlParameters(o.parameters,sap.ui.fl.Versions.UrlParameter,sap.ui.fl.Versions.Draft);}if(o.versionSwitch){o.parameters=U.handleUrlParameters(o.parameters,sap.ui.fl.Versions.UrlParameter,o.version);}if(o.parameters==="?"){o.parameters="";}return o.parameters;},handleParametersOnStart:function(o){var p=U.getParsedURLHash();p.params=p.params||{};if(o.hasHigherLayerChanges){p.params[L.FL_MAX_LAYER_PARAM]=[o.layer];}if(o.isDraftAvailable){p.params[sap.ui.fl.Versions.UrlParameter]=[sap.ui.fl.Versions.Draft];}return p;},initialDraftGotActivated:function(o){if(o.versioningEnabled){var u=this.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()});return!V.isDraftAvailable(o)&&u;}return false;},getReloadMethod:function(o){var d={NOT_NEEDED:"NO_RELOAD",RELOAD_PAGE:"HARD_RELOAD",VIA_HASH:"CROSS_APP_NAVIGATION"};o.reloadMethod=d.NOT_NEEDED;o.isDraftAvailable=o.isDraftAvailable||R.hasVersionParameterWithValue({value:sap.ui.fl.Versions.Draft.toString()});if(o.activeVersion>sap.ui.fl.Versions.Original){o.activeVersionNotSelected=o.activeVersion&&!R.hasVersionParameterWithValue({value:o.activeVersion.toString()});}o.hasHigherLayerChanges=R.hasMaxLayerParameterWithValue({value:o.layer});o.initialDraftGotActivated=R.initialDraftGotActivated(o);if(o.initialDraftGotActivated){o.isDraftAvailable=false;}o.allContexts=g(o.selector);if(o.changesNeedReload||o.isDraftAvailable||o.hasHigherLayerChanges||o.initialDraftGotActivated||o.activeVersionNotSelected||o.allContexts){o.reloadMethod=d.RELOAD_PAGE;if(!o.changesNeedReload&&U.getUshellContainer()){o.reloadMethod=d.VIA_HASH;}}r(o.selector);return o;}};return R;});
