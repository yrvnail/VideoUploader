/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/registry/Settings","sap/ui/fl/ChangePersistenceFactory","sap/ui/fl/write/_internal/Storage","sap/base/util/UriParameters","sap/ui/model/json/JSONModel","sap/ui/fl/Utils","sap/ui/model/BindingMode"],function(S,C,a,U,J,b,B){"use strict";var _={};var M=9;var c=M+1;function d(p,v,h){var i=g(h);var n=sap.ui.fl.Versions.Original;h.forEach(function(o){if(o.version===sap.ui.fl.Versions.Draft){o.type="draft";}else if(n===sap.ui.fl.Versions.Original){o.type="active";n=o.version;}else{o.type="inactive";}});var P=b.getParameter(sap.ui.fl.Versions.UrlParameter);var j;if(P){j=parseInt(P);}else if(h.length>0){j=h[0].version;}else{j=sap.ui.fl.Versions.Original;}var m=new J({versioningEnabled:v,versions:h,activeVersion:n,backendDraft:i,dirtyChanges:false,draftAvailable:i,activateEnabled:i,persistedVersion:j,displayedVersion:j});m.setDefaultBindingMode(B.OneWay);m.setSizeLimit(M);m.setDirtyChanges=function(D){m.setProperty("/dirtyChanges",D);m.updateDraftVersion();m.updateBindings(true);};m.updateDraftVersion=function(){var h=m.getProperty("/versions");var v=m.getProperty("/versioningEnabled");var D=m.getProperty("/dirtyChanges");var i=m.getProperty("/backendDraft");var k=v&&(D||i);m.setProperty("/draftAvailable",k);var l=D?sap.ui.fl.Versions.Draft:m.getProperty("/persistedVersion");m.setProperty("/displayedVersion",l);if(!g(h)&&k){h.splice(0,0,{version:sap.ui.fl.Versions.Draft,type:"draft"});}if(g(h)&&!k){h.shift();m.setProperty("/displayedVersion",m.getProperty("/persistedVersion"));}var A=m.getProperty("/displayedVersion")!==m.getProperty("/activeVersion");m.setProperty("/activateEnabled",A);};return m;}function e(p,D){var h=[];var i=D.changePersistences;i.forEach(function(o){h=o.getDirtyChanges().concat();h.forEach(function(j){o.deleteChange(j,true);});});return h.length>0;}function f(p){var D={dirtyChangesExist:false,changePersistences:[]};if(p.reference){var o=C.getChangePersistenceForComponent(p.reference);if(o.getDirtyChanges().length>0){D.dirtyChangesExist=true;D.changePersistences.push(o);}}if(p.nonNormalizedReference){var h=C.getChangePersistenceForComponent(p.nonNormalizedReference);if(h.getDirtyChanges().length>0){D.dirtyChangesExist=true;D.changePersistences.push(h);}}return D;}function g(v){return v.some(function(o){return o.version===sap.ui.fl.Versions.Draft;});}var V={};V.initialize=function(p){var r=p.reference;var l=p.layer;p.limit=c;return S.getInstance().then(function(s){var v=s.isVersioningEnabled(l);var h=v?a.versions.load(p):Promise.resolve([]);return h.then(function(i){_[r]=_[r]||{};_[r][l]=_[r][l]||{};_[r][l]=d(p,v,i);return _[r][l];});});};V.getVersionsModel=function(p){var r=p.reference;var l=p.layer;if(!_[r]||!_[r][l]){throw Error("Versions Model for reference '"+r+"' and layer '"+l+"' were not initialized.");}var D=f(p);if(D.dirtyChangesExist){_[r][l].updateDraftVersion(p);}return _[r][l];};V.clearInstances=function(){_={};};V.onAllChangesSaved=function(p){p.reference=b.normalizeReference(p.reference);var m=V.getVersionsModel(p);var v=m.getProperty("/versioningEnabled");var D=m.getProperty("/dirtyChanges");m.setProperty("/dirtyChanges",true);m.setProperty("/backendDraft",v&&D);m.updateDraftVersion();};V.activate=function(p){var m=V.getVersionsModel(p);var v=m.getProperty("/versions");var D=g(v);var s=m.getProperty("/displayedVersion");var A=m.getProperty("/activeVersion");var n=m.getProperty("/persistedVersion");if(s===A){return Promise.reject("Version is already active");}p.version=s;var h=[];if(m.getProperty("/dirtyChanges")){var o=f(p);var i=o.changePersistences;h=i.map(function(j){return j.saveDirtyChanges(p.appComponent,false,undefined,n);});}return Promise.all(h).then(a.versions.activate.bind(undefined,p)).then(function(j){v.forEach(function(k){k.type="inactive";});j.type="active";if(D){v.shift();}v.splice(0,0,j);m.setProperty("/backendDraft",false);m.setProperty("/dirtyChanges",false);m.setProperty("/draftAvailable",false);m.setProperty("/activateEnabled",false);m.setProperty("/activeVersion",j.version);m.setProperty("/displayedVersion",j.version);m.setProperty("/persistedVersion",j.version);m.updateBindings(true);});};V.discardDraft=function(p){var m=V.getVersionsModel(p);var v=m.getProperty("/versions");var D=f(p);var h=m.getProperty("/backendDraft");var o=h?a.versions.discardDraft(p):Promise.resolve();return o.then(function(){v.shift();m.setProperty("/backendDraft",false);m.setProperty("/dirtyChanges",false);m.setProperty("/draftAvailable",false);m.setProperty("/activateEnabled",false);m.setProperty("/displayedVersion",m.getProperty("/persistedVersion"));m.updateBindings(true);var i=e(p,D);return{backendChangesDiscarded:h,dirtyChangesDiscarded:i};});};return V;});
