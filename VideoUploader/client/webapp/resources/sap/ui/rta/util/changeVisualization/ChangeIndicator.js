/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/core/Control","sap/m/Text","sap/ui/core/format/DateFormat","sap/ui/core/Icon","sap/ui/events/KeyCodes","sap/base/strings/capitalize"],function(F,J,C,T,D,I,K,c){"use strict";var a=C.extend("sap.ui.rta.util.changeVisualization.ChangeIndicator",{metadata:{properties:{changes:{type:"array",defaultValue:[]},mode:{type:"string",defaultValue:"change"},posX:{type:"int"},posY:{type:"int"},overlayId:{type:"string"},selectorId:{type:"string"}},aggregations:{_popover:{type:"sap.m.Popover",multiple:false,visibility:"hidden"},_text:{type:"sap.m.Text",multiple:false,visibility:"hidden"},_icon:{type:"sap.ui.core.Icon",multiple:false,visibility:"hidden"}},events:{selectChange:{parameters:{changeId:{type:"string"}}},keyPress:{parameters:{originalEvent:{type:"object"}}}}},renderer:{apiVersion:2,render:function(r,o){r.openStart("div",o);r.class("sapUiRtaChangeIndicator");r.class("sapUiRtaChangeIndicator"+c(o.getMode()));if(o.getMode()==="change"&&o.getModel()&&!!o.getModel().getData().selectedChange){r.class("sapUiRtaChangeIndicatorChangeSolid");}r.style("width",o._getSize()+"px");r.style("height",o._getSize()+"px");r.openEnd();r.openStart("div");r.openEnd();r.renderControl(o.getAggregation("_icon"));r.renderControl(o.getAggregation("_text"));r.close("div");r.close("div");}},constructor:function(){this._oDetailModel=new J();this._oDetailModel.setDefaultBindingMode("OneWay");C.prototype.constructor.apply(this,arguments);}});a.prototype.init=function(){this.setAggregation("_text",new T({text:"{= (${changes} || []).length}",visible:"{= (${changes} || []).length > 1}"}).addStyleClass("sapUiRtaChangeIndicatorText"));this.setAggregation("_icon",new I({src:"sap-icon://display",visible:{path:"/selectedChange",formatter:function(s){return!!(s&&this.getChanges().some(function(o){return(o.id===s&&o.dependent===false);}));}.bind(this)}}).addStyleClass("sapUiRtaChangeIndicatorIcon"));this.attachBrowserEvent("click",this._onSelect,this);this.attachBrowserEvent("keydown",this._onKeyDown,this);};a.prototype.focus=function(){if(this.getDomRef()){C.prototype.focus.apply(this,arguments);this._bScheduledForFocus=false;}this._bScheduledForFocus=true;};a.prototype._getSize=function(){var o=document.getElementById(this.getOverlayId());var s=o.offsetHeight;return(s>50?50:s)-2;};a.prototype.onAfterRendering=function(){var o=document.getElementById(this.getOverlayId());o.appendChild(this.getDomRef());this.getDomRef().tabIndex=0;if(this._bScheduledForFocus){this.focus();}};a.prototype.exit=function(){var d=this.getDomRef();if(d){d.parentNode.removeChild(d);}this.detachBrowserEvent("click",this._onSelect,this);this.detachBrowserEvent("keydown",this._onKeyDown,this);};a.prototype.setChanges=function(b){this.setProperty("changes",b);this._oDetailModel.setData((b||[]).map(this._formatChangesModelItem.bind(this)));};a.prototype.setMode=function(m){this.setProperty("mode",m);this._oDetailModel.setData((this.getChanges()||[]).map(this._formatChangesModelItem.bind(this)));};a.prototype._onSelect=function(e){e.stopPropagation();if(!!this.getModel().getData().selectedChange&&!this.getChanges().some(function(o){return o.dependent;})){this.fireSelectChange({changeId:undefined});}else{this._openDetailPopover();}};a.prototype._onKeyDown=function(e){if(e.keyCode===K.ENTER){this._onSelect(e);}this.fireKeyPress({originalEvent:e});};a.prototype._formatChangesModelItem=function(o){var A=sap.ui.getCore().byId(o.affectedElementId);var O=sap.ui.getCore().byId(this.getOverlayId());var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var m=this.getMode();var s=o.commandName.charAt(0).toUpperCase()+o.commandName.slice(1);var e=O.getDesignTimeMetadata().getLabel(A);e=e&&"'"+e+"'";var b=("TXT_CHANGEVISUALIZATION_"+m.toUpperCase()+"_"+o.commandName.toUpperCase());var d=r.getText(b,e);var f=D.getDateTimeInstance().format(new Date(o.change.getCreation()));var E=(m==="change"&&(o.commandName==="move"||o.commandName==="split"));return{id:o.id,change:o,changeTitle:s,description:d,date:f,enableDetailButton:E};};a.prototype._openDetailPopover=function(){if(!this.getAggregation("_popover")){F.load({name:"sap.ui.rta.util.changeVisualization.ChangeIndicatorPopover",controller:this}).then(function(p){this.setAggregation("_popover",p);p.setModel(this._oDetailModel,"details");p.openBy(this);}.bind(this));}else{this.getAggregation("_popover").openBy(this);}};a.prototype._showDependentElements=function(e){this.getAggregation("_popover").close();var s=this.getChanges().length>1?e.getSource().getBindingContext("details").getObject().id:this.getChanges()[0].id;this.fireSelectChange({changeId:s});};return a;});
