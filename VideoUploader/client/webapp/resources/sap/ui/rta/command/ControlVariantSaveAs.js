/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/command/BaseCommand","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/rta/Utils","sap/ui/fl/Utils"],function(B,J,r,f){"use strict";var C=B.extend("sap.ui.rta.command.ControlVariantSaveAs",{metadata:{library:"sap.ui.rta",properties:{sourceVariantReference:{type:"string"},sourceDefaultVariant:{type:"string"},model:{type:"object"},newVariantParameters:{type:"object"}},associations:{},events:{}}});C.prototype.prepare=function(F){this.oVariantManagementControl=this.getElement();this.oAppComponent=f.getAppComponentForControl(this.oVariantManagementControl);this.sVariantManagementReference=J.getSelector(this.oVariantManagementControl,this.oAppComponent).id;this.oModel=this.getModel();this.setSourceDefaultVariant(this.oModel.getData()[this.sVariantManagementReference].defaultVariant);this.sLayer=F.layer;function s(e,a){var p=e.getParameters();this.setNewVariantParameters(p);this.oVariantManagementControl.detachSave(s,this);this.oVariantManagementControl.detachCancel(h,this);a.resolve(true);}function h(e,a){this.oVariantManagementControl.detachSave(s,this);this.oVariantManagementControl.detachCancel(h,this);a.resolve(false);}return new Promise(function(a){this.oVariantManagementControl.attachSave({resolve:a},s,this);this.oVariantManagementControl.attachCancel({resolve:a},h,this);this.oVariantManagementControl.openSaveAsDialogForKeyUser(r.getRtaStyleClassName());}.bind(this)).then(function(S){return S;});};C.prototype.getPreparedChange=function(){if(!this._aPreparedChanges){return undefined;}return this._aPreparedChanges;};C.prototype.execute=function(){var s=this.getSourceVariantReference();this._aControlChanges=this.oModel.getVariant(s,this.sVariantManagementReference).controlChanges;var p=this.getNewVariantParameters();p.layer=this.sLayer;p.newVariantReference=this.sNewVariantReference;p.generator=sap.ui.rta.GENERATOR_NAME;return this.oModel._handleSave(this.oVariantManagementControl,p).then(function(d){this._aPreparedChanges=d;this._oVariantChange=d[0];this.sNewVariantReference=this._oVariantChange.getDefinition().fileName;this._aPreparedChanges.forEach(function(c){if(c.getFileType()==="change"){c.assignedToVariant=true;}});this.getModel().checkDirtyStateForControlModels([this.sVariantManagementReference]);}.bind(this));};C.prototype.undo=function(){if(this._oVariantChange){this._aPreparedChanges.forEach(function(c){if(c.getFileType()==="ctrl_variant_management_change"){this.oModel.oFlexController.deleteChange(c,this.oAppComponent);}}.bind(this));var p={variant:this._oVariantChange,sourceVariantReference:this.getSourceVariantReference(),variantManagementReference:this.sVariantManagementReference,component:this.oAppComponent};return this.oModel.removeVariant(p,true).then(function(){this._aControlChanges.forEach(function(c){this.oModel.oFlexController.addPreparedChange(c,this.oAppComponent);var o=sap.ui.getCore().byId(J.getControlIdBySelector(c.getSelector(),this.oAppComponent));this.oModel.oFlexController.applyChange(c,o);}.bind(this));this.oModel.getData()[this.sVariantManagementReference].defaultVariant=this.getSourceDefaultVariant();this.oModel.getData()[this.sVariantManagementReference].originalDefaultVariant=this.getSourceDefaultVariant();this._aPreparedChanges=null;this._oVariantChange=null;this.getModel().checkUpdate(true);}.bind(this));}return Promise.resolve();};return C;});
