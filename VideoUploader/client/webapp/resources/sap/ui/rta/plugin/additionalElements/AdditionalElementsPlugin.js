/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_difference","sap/base/util/merge","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/dt/OverlayRegistry","sap/ui/dt/Util","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/fl/write/api/FieldExtensibility","sap/ui/fl/Utils","sap/ui/rta/plugin/Plugin","sap/ui/rta/Utils"],function(d,m,L,J,E,O,D,a,F,b,P,U){"use strict";function _(s,i,t){var u;var R=i;if(t){var v=["add.delegate","reveal","add.custom"].some(function(y){return t.isResponsibleElementActionAvailable(i,y);});if(v){R=t.getResponsibleElementOverlay(i);}}var w=R.getRelevantContainer(!s);var x=O.getOverlay(w);if(s){u=R.getParentElementOverlay();}else{u=R;}return{responsibleElementOverlay:R,relevantContainerOverlay:x,parentOverlay:u,relevantContainer:w,parent:u&&u.getElement()};}function c(i,C){return C.sParentAggregationName;}function e(i,s){var t=i.getElement();if(!t){return[];}var I=E.getAggregation(t,s).filter(function(C){var u=O.getOverlay(C);if(!this.hasStableId(u)){return false;}var R=i.getRelevantContainer(true);var v=O.getOverlay(R);var w=i;var x=false;do{x=!w.getElementVisibility();if(x){break;}if(w===v){break;}else{w=w.getParentElementOverlay();}}while(w);if(x){return true;}return u.getElementVisibility()===false;},this);return I;}function f(i){return(i["addViaDelegate"]&&i["addViaDelegate"].designTimeMetadata)||(i["addViaCustom"]&&i["addViaCustom"].designTimeMetadata);}var S=true;var g=false;function h(R,i,s,t,C){var N=[];var u;var v;if(i.addViaCustom||i.addViaDelegate){var w=i.aggregation;var x=f(i);u=x.getAggregationDescription(w,s);if(u){v=t?u.singular:u.plural;N.push(v);}}if(i.reveal){i.reveal.controlTypeNames.forEach(function(u){v=t?u.singular:u.plural;N.push(v);});}var y=N.reduce(function(z,B){if(z.indexOf(B)===-1){z.push(B);}return z;},[]);var T=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");if(y.length===1){v=y[0];}else if(C){v=C;}else{v=T.getText("MULTIPLE_CONTROL_NAME");}return T.getText(R,[v]);}function j(i,R){var s;i.reveal.elements.some(function(t){if(t.element.getId()===R.getId()){s=t;return false;}});return s;}function k(i,s){var R=s.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName();return i.aggregation===R;}function l(C,i,s,t){var v=s.changeType&&t.hasStableId(C);if(v&&C!==i.relevantContainerOverlay){v=t.hasStableId(i.relevantContainerOverlay);}return v;}function n(i,s,t,u){return i.reduce(function(v,w){return v.then(function(x){var C=w.changeOnRelevantContainer?s.relevantContainer:s.parent;var y=O.getOverlay(C);var V=l(y,s,w,t);if(V){w.element=C;return a.getDelegateForControl({control:s.relevantContainer,modifier:J,supportsDefault:w.supportsDefaultDelegate}).then(function(z){if(z&&z.names&&z.names.length){var R=a.getRequiredLibrariesForDefaultDelegate({delegateName:z.names,control:s.relevantContainer});if(d(R,u.filter(Boolean)).length===0){w.delegateInfo=z;x.push(w);}}return x;});}return x;});},Promise.resolve([]));}function o(i,s){return this.hasChangeHandler(i.changeType,i.element).then(function(H){if(H){return{aggregationName:i.aggregation,addPropertyActionData:{designTimeMetadata:s,action:i,delegateInfo:{payload:i.delegateInfo.payload||{},delegate:i.delegateInfo.instance,modelType:i.delegateInfo.modelType,requiredLibraries:i.delegateInfo.requiredLibraries}}};}});}function p(C,R){var i=C.getManifestEntry("/sap.ui5/dependencies/libs");return Object.keys(R).some(function(s){return!i[s];});}function q(){var i=[];var R=a.getKnownDefaultDelegateLibraries();R.forEach(function(s){var t=sap.ui.getCore().loadLibrary(s,{async:true}).then(function(){return Promise.resolve(s);}).catch(function(v){L.warning("Required library not available: ",v);return Promise.resolve();});i.push(t);});return Promise.all(i);}function r(C,i){return F.onControlSelected(C).then(function(){return Promise.all([U.isServiceUpToDate(C),F.isExtensibilityEnabled(C)]);}).then(function(R){var s=!!R[1];i._oCustomFieldButton.setVisible(s);if(s){return F.getExtensionData(C);}});}var A=P.extend("sap.ui.rta.plugin.additionalElements.AdditionalElementsPlugin",{metadata:{library:"sap.ui.rta",properties:{analyzer:"object",dialog:"object",commandFactory:"object"},associations:{},events:{}},getContextMenuTitle:function(i,s){var t=_(i,s,this);var u=this._getActionsOrUndef(i,s);return h("CTX_ADD_ELEMENTS",u,t.parent,S);},isAvailable:function(i,s){return s.every(function(t){return this._isEditableByPlugin(t,i);},this);},isEnabled:function(i,s){if(s.length>1){return false;}var t=this.getResponsibleElementOverlay(s[0]);var u;var I;if(i){u=t.getParentElementOverlay();if(u){I=true;}else{I=false;}}else{var v=this._getActionsOrUndef(i,t);if((!v.reveal||v.reveal.elements.length===0)&&!v.addViaCustom&&!v.addViaDelegate){I=false;}else{I=true;}}var C=this.getCachedElements(i);var w=C&&C.length>0;I=I&&(w||this.getDialog().getCustomFieldEnabled());return I;},registerElementOverlay:function(i){var M=i.getElement().getModel();if(M){var s=M.getMetaModel();if(s&&s.loaded){s.loaded().then(function(){this.evaluateEditable([i],{onRegistration:true});}.bind(this));}}P.prototype.registerElementOverlay.apply(this,arguments);},_getRevealActions:function(s,i){var t=_(s,i,this);var u=[t.parentOverlay];if(t.relevantContainer!==t.parent){u=E.findAllSiblingsInContainer(t.parent,t.relevantContainer).map(function(x){return O.getOverlay(x);}).filter(function(x){return x;});}var v;if(s){var w=t.responsibleElementOverlay.getParentAggregationOverlay();v=w?[t.responsibleElementOverlay.getParentAggregationOverlay().getAggregationName()]:[];}else{v=t.parentOverlay.getAggregationOverlays().filter(function(x){return!x.getDesignTimeMetadata().isIgnored(t.parent);}).map(function(x){return x.getAggregationName();});}return v.reduce(function(x,y){return x.then(function(R){return this._getRevealActionFromAggregations(u,R,y);}.bind(this));}.bind(this),Promise.resolve({}));},_getRevealActionFromAggregations:function(i,s,t){var I=i.reduce(function(v,w){return w?v.concat(e.call(this,w,t)):v;}.bind(this),[]);var u={elements:[],controlTypeNames:[]};var R=I.reduce(function(v,w){return v.then(function(x){return this._invisibleToReveal(x,w);}.bind(this));}.bind(this),Promise.resolve(u));return R.then(function(v){if(v.elements.length>0){s[t]={reveal:v};}return s;});},_invisibleToReveal:function(R,i){return Promise.resolve().then(function(){var s;var t;var u=false;var H=Promise.resolve();var v=O.getOverlay(i);if(v){s=v.getDesignTimeMetadata();t=s&&s.getAction("reveal",i);if(t&&t.changeType){var w=i;if(t.changeOnRelevantContainer){w=v.getRelevantContainer();}H=this.hasChangeHandler(t.changeType,w).then(function(x){if(x){if(t.changeOnRelevantContainer){var y=_(true,v);u=this.hasStableId(y.relevantContainerOverlay)&&this.hasStableId(y.parentOverlay);}else{u=true;}if(!t.getAggregationName){t.getAggregationName=c;}}}.bind(this));}}return H.then(function(){if(u){R.elements.push({element:i,designTimeMetadata:s,action:t});var N=s.getName(i);if(N){R.controlTypeNames.push(N);}}return R;});}.bind(this));},_getAddViaDelegateActions:function(s,i){var t=_(s,i,this);var u=t.parentOverlay&&t.parentOverlay.getDesignTimeMetadata();return Promise.resolve().then(function(){var v=u?u.getActionDataFromAggregations("add",t.parent,undefined,"delegate"):[];if(v.length){return q().then(n.bind(this,v,t,this));}return[];}.bind(this)).then(function(v){return v.reduce(function(w,x){return w.then(function(R){return o.call(this,x,u).then(function(y){if(y){y.addPropertyActionData.relevantContainer=t.relevantContainer;if(!R[y.aggregationName]){R[y.aggregationName]={};}R[y.aggregationName].addViaDelegate=y.addPropertyActionData;}return R;});}.bind(this));}.bind(this),Promise.resolve({}));}.bind(this));},_checkInvalidAddActions:function(s,i){var t=_(s,i,this);var u=t.parentOverlay&&t.parentOverlay.getDesignTimeMetadata();var v=u?u.getActionDataFromAggregations("addODataProperty",t.parent):[];if(v.length>0){L.error("Outdated addODataProperty action in designtime metadata in "+u.getData().designtimeModule+" or propagated or via instance specific designtime metadata.");}},_getCustomAddActions:function(s,i){var t=_(s,i,this);var u=t.parentOverlay&&t.parentOverlay.getDesignTimeMetadata();var v=u&&u.getActionDataFromAggregations("add",t.parent,undefined,"custom")||[];function w(x,C){var I=[];return Promise.resolve().then(function(){if(x&&typeof x.getItems==="function"){var y=O.getOverlay(C);if(this.hasStableId(y)){return x.getItems(C);}}}.bind(this)).then(function(y){I=y;if(Array.isArray(I)){var z=I.reduce(function(B,G){if(G.changeSpecificData.changeOnRelevantContainer){C=t.relevantContainer;}if(G.changeSpecificData.changeType){B.push(this.hasChangeHandler(G.changeSpecificData.changeType,C));}return B;}.bind(this),[]);return Promise.all(z);}}.bind(this)).then(function(H){if(Array.isArray(H)&&I.length===H.length&&H.indexOf(false)===-1){return{aggregationName:x.aggregation,addViaCustom:{designTimeMetadata:u,action:x,items:I}};}});}var C=t.parent;return v.reduce(function(x,y){return x.then(function(R){return w.call(this,y,C).then(function(z){if(z){R[z.aggregationName]={addViaCustom:z.addViaCustom};}return R;});}.bind(this));}.bind(this),Promise.resolve({}));},_getActions:function(s,i,I){return new Promise(function(t,u){var v=s?"asSibling":"asChild";if(!I&&i._mAddActions){return t(i._mAddActions[v]);}var R=this._getRevealActions(s,i);var w=this._getAddViaDelegateActions(s,i);var C=this._getCustomAddActions(s,i);return Promise.all([R,w,C,this._checkInvalidAddActions(s,i)]).then(function(x){var y=m(x[0],x[1],x[2]);var z=Object.keys(y);if(z.length===0){y={};}else if(z.length>1){L.error("reveal or addViaDelegate or custom add action defined for more than 1 aggregation, that is not yet possible");}if(z.length>0){var B=z[0];y[B].aggregation=B;y=y[B];}i._mAddActions=i._mAddActions||{asSibling:{},asChild:{}};i._mAddActions[v]=y;t(y);}).catch(function(x){u(x);});}.bind(this));},_getActionsOrUndef:function(s,i){var t=s?"asSibling":"asChild";return i._mAddActions&&i._mAddActions[t];},_checkIfCreateFunctionIsAvailable:function(C){return!C||(C&&C.content&&C.content.createFunction);},showAvailableElements:function(i,R,I,C){var s=R[0];var t=_(i,s);var v=i&&s.getElement();var u;return this._getActions(i,s).then(function(w){u=w;}).then(function(){return this.getAllElements(i,[t.responsibleElementOverlay],I,C);}.bind(this)).then(function(w){this.getDialog().setElements(w);return this.getDialog().open().then(function(){return this._createCommands(t,v,u,I);}.bind(this)).then(function(){var x=O.getOverlay(v)||s;x.focus();}).catch(function(x){if(x instanceof Error){throw x;}});}.bind(this)).catch(function(w){if(w instanceof Error){throw w;}else{L.info("Service not up to date, skipping add dialog","sap.ui.rta");}});},_setDialogTitle:function(i,s,C){var t=h("HEADER_ADDITIONAL_ELEMENTS",i,s,g,C);this.getDialog().setTitle(t);if(C){this.getDialog()._oList.setNoDataText(this.getDialog()._oTextResources.getText("MSG_NO_FIELDS",C.toLowerCase()));}},_onOpenCustomField:function(){return F.onTriggerCreateExtensionData(this._oCurrentFieldExtInfo);},_createCommands:function(i,s,t,I){var u=this.getDialog().getSelectedElements();u.sort(function(v,w){if(v.label>w.label){return-1;}if(v.label<w.label){return 1;}return 0;});if(u.length>0){return this.getCommandFactory().getCommandFor(i.parent,"composite").then(function(C){var v=Promise.resolve();u.forEach(function(w){switch(w.type){case"invisible":v=v.then(this._createCommandsForInvisibleElement.bind(this,C,w,i,s,t,I));break;case"delegate":v=v.then(this._createCommandsForAddViaDelegate.bind(this,C,w,i,s,t,I));break;case"custom":v=v.then(this._createCommandsForCustomElement.bind(this,C,w,i,s,t,I));break;default:L.error("Can't create command for untreated element.type "+w.type);}},this);return v.then(function(){return C;});}.bind(this)).then(function(C){this.fireElementModified({command:C});}.bind(this)).catch(function(M){throw D.propagateError(M,"AdditionalElementsPlugin#_createCommands","Error occured during _createCommands execution","sap.ui.rta.plugin");});}return Promise.resolve();},_createCommandsForInvisibleElement:function(C,s,i,t,u,I){return this._createRevealCommandForInvisible(s,u,i).then(function(R){C.addCommand(R);return this._createMoveCommandForInvisible(s,i,t,I);}.bind(this)).then(function(M){if(M){C.addCommand(M);}else{L.warning("No move action configured for "+i.parent.getMetadata().getName()+", aggregation: "+u.aggregation,"sap.ui.rta");}return C;});},_createCommandForAddLibrary:function(i,R,s){if(R){var C=b.getAppComponentForControl(i.relevantContainer);var t=p(C,R);if(t){var M=C.getManifest();var u=M["sap.app"].id;return this.getCommandFactory().getCommandFor(i.publicParent,"addLibrary",{reference:u,parameters:{libraries:R},appComponent:C},s);}}return Promise.resolve();},_createRevealCommandForInvisible:function(s,i,t){var R=E.getElementInstance(s.elementId);var u=O.getOverlay(R);var v=j(i,R);var w=v.designTimeMetadata;var x=v.action;var V;if(u){V=this.getVariantManagementReference(u);}if(x.changeOnRelevantContainer){return this.getCommandFactory().getCommandFor(R,"reveal",{revealedElementId:R.getId(),directParent:t.parent},w,V);}return this.getCommandFactory().getCommandFor(R,"reveal",{},w,V);},_createMoveCommandForInvisible:function(s,i,t,I){var R=E.getElementInstance(s.elementId);var u=O.getOverlay(R);var v=u.getParentAggregationOverlay().getAggregationName();var w=u.getParentElementOverlay().getElement()||i.parent;var T=i.parent;var x=U.getIndex(i.parent,t,v);var y=U.getIndex(w,R,v)-1;x=I!==undefined?I:E.adjustIndexForMove(w,T,y,x);if(x!==y||i.parent!==R.getParent()){var z=O.getOverlay(R)?O.getOverlay(R).getParentAggregationOverlay():i.relevantContainerOverlay;var B=z.getDesignTimeMetadata();var V=this.getVariantManagementReference(u);return this.getCommandFactory().getCommandFor(i.relevantContainer,"move",{movedElements:[{element:R,sourceIndex:y,targetIndex:x}],source:{parent:w,aggregation:v},target:{parent:T,aggregation:v}},B,V);}return Promise.resolve();},_createCommandsForCustomElement:function(C,s,i,t,u,I){var v=i.parent;var w=i.parentOverlay.getAggregationOverlay(u.aggregation).getDesignTimeMetadata();var x=Object.assign({changeOnRelevantContainer:s.changeSpecificData.changeOnRelevantContainer,aggregationName:u.aggregation,changeType:s.changeSpecificData.changeType,addElementInfo:s.changeSpecificData.content,index:I||U.getIndex(i.parent,t,u.aggregation)},s.itemId&&{customItemId:s.itemId});var V;if(i.relevantContainerOverlay){V=this.getVariantManagementReference(i.relevantContainerOverlay);}return this.getCommandFactory().getCommandFor(v,"customAdd",x,w,V).then(function(y){if(y){C.addCommand(y);}return C;});},_createCommandsForAddViaDelegate:function(C,s,i,t,u,I){var v=u.addViaDelegate.action;var R=v.delegateInfo.requiredLibraries;var w=i.parentOverlay.getAggregationOverlay(u.aggregation);var x=w.getDesignTimeMetadata();return this._createCommandForAddLibrary(i,R,x).then(function(y){if(y){C.addCommand(y);}return this._createAddViaDelegateCommand(s,i,x,t,u,I);}.bind(this)).then(function(y){if(y){C.addCommand(y);}return C;});},_createAddViaDelegateCommand:function(s,i,t,u,v,I){var w=v.addViaDelegate.action;var x=w.changeOnRelevantContainer?i.relevantContainer:i.parent;var y=w.changeOnRelevantContainer?i.relevantContainerOverlay:i.parentOverlay;var V=this.getVariantManagementReference(y);var z=U.getIndex(i.parent,u,v.aggregation,t.getData().getIndex);var C="addDelegateProperty";var M=b.getAppComponentForControl(i.parent).getManifest();var B=b.getODataServiceUriFromManifest(M);return this.getCommandFactory().getCommandFor(i.parent,C,{newControlId:U.createFieldLabelId(x,s.entityType,s.bindingPath),index:I!==undefined?I:z,bindingString:s.bindingPath,entityType:s.entityType,parentId:i.parent.getId(),propertyName:s.name,oDataServiceVersion:s.oDataServiceVersion,oDataServiceUri:B,modelType:w.delegateInfo.modelType,relevantContainerId:i.relevantContainer.getId()},t,V);},_isEditable:function(i,s){return Promise.all([this._isEditableCheck(s.sourceElementOverlay,true),this._isEditableCheck(s.sourceElementOverlay,false)]).then(function(t){return{asSibling:t[0],asChild:t[1]};}).catch(function(v){L.error(v);});},_isEditableCheck:function(i,s){return Promise.resolve().then(function(){var t=_(s,i,this);if(!t.relevantContainerOverlay){return false;}return this._getActions(s,i,true).then(function(u){return U.doIfAllControlsAreAvailable([i,t.parentOverlay],function(){var v=false;if(s){v=k(u,t);}if(!v&&u.reveal){v=true;}if(!v&&!s){if(u.addViaDelegate){return this.checkAggregationsOnSelf(t.parentOverlay,"add",undefined,"delegate");}}if(!v&&!s&&u.addViaCustom){v=true;}return v;}.bind(this));}.bind(this)).then(function(u){if(u){u=this.hasStableId(i)&&this.hasStableId(t.parentOverlay);}return u;}.bind(this));}.bind(this));},getAllElements:function(i,s,I,C){var t=s[0];var u=_(i,t,this);var v;var w=[];var x=this.getCachedElements(i);if(x){return x;}return this._getActions(i,t).then(function(y){v=y;w.push(v.reveal?this.getAnalyzer().enhanceInvisibleElements(u.parent,v):Promise.resolve([]),v.addViaDelegate?this.getAnalyzer().getUnrepresentedDelegateProperties(u.parent,v.addViaDelegate):Promise.resolve([]),v.addViaCustom?this.getAnalyzer().getCustomAddItems(u.parent,v.addViaCustom,v.aggregation):Promise.resolve([]));if(v.aggregation||C){this._setDialogTitle(v,u.parent,C);}if(v.addViaDelegate){return r(u.parent,this.getDialog());}}.bind(this)).then(function(y){this.getDialog().setCustomFieldEnabled(!!y);if(y){this._oCurrentFieldExtInfo=y;this.getDialog().detachEvent("openCustomField",this._onOpenCustomField,this);this.getDialog().attachEvent("openCustomField",null,this._onOpenCustomField,this);return this.getDialog().addExtensionData(this._oCurrentFieldExtInfo.extensionData);}this.getDialog()._oCustomFieldButton.setVisible(false);}.bind(this)).then(this._combineAnalyzerResults.bind(this,w)).then(function(y){this.setCachedElements(y,i);return y;}.bind(this)).catch(function(y){throw y;});},getMenuItems:function(s){var t=true;var u="CTX_ADD_ELEMENTS_AS_SIBLING";var R=20;var I="sap-icon://add";var M=[];this.clearCachedElements();return Promise.all([this.getAllElements(true,s),this.getAllElements(false,s)]).then(function(){for(var i=0;i<2;i++){if(this.isAvailable(t,s)){var G=this.getContextMenuTitle.bind(this,t);var v={id:u,text:G,handler:function(t,s){return this.showAvailableElements(t,s);}.bind(this,t),enabled:this.isEnabled.bind(this,t),rank:R,icon:I};M.push(this.enhanceItemWithResponsibleElement(v,s,["addViaDelegate","reveal","custom"]));}t=false;u="CTX_ADD_ELEMENTS_AS_CHILD";R=30;}return M;}.bind(this));},_combineAnalyzerResults:function(i){return Promise.all(i).then(function(s){return this.getAnalyzer().getFilteredItemsList(s);}.bind(this));},clearCachedElements:function(){this._aCachedElements=undefined;},setCachedElements:function(i,s){this._aCachedElements=this._aCachedElements||{};this._aCachedElements[s?"asSibling":"asChild"]=i;},getCachedElements:function(i){if(!this._aCachedElements){return undefined;}return this._aCachedElements[i?"asSibling":"asChild"];}});return A;});
