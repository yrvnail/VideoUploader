/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/dt/ElementUtil","sap/ui/fl/apply/api/DelegateMediatorAPI","sap/ui/rta/util/BindingsExtractor","sap/ui/thirdparty/jquery"],function(O,L,J,E,D,B,q){"use strict";function _(j,I,M){if(!j){return false;}var K=j.getBindingInfo(I,M);var P=K&&K.path;if(!P){return false;}if(P.indexOf(">")>-1){P=P.split(">").pop();}return P.indexOf("/")===0;}function a(j,I,K,M){var N;if(I){N=j.getBindingInfo(K,M);if(typeof N.model==="string"&&N.model!==M){N=undefined;}}else{N=j.getBindingContext(M);}return N;}function b(j,I,M){var K=_(j,I,M);var N=a(j,K,I,M);if(N){return K?N.path:N.getPath();}}function c(P){var j=P.reduce(function(I,K){if(Array.isArray(K.properties)){I=I.concat(K.properties.map(function(M){M.parentPropertyName=K.label||K.name;return M;}));}else{I.push(K);}return I;},[]);return j;}function d(j,I,K){var P={element:j,aggregationName:I,payload:K.delegateInfo.payload||{}};return K.delegateInfo.delegate.getPropertyInfo(P).then(c);}function g(j,I){return D.getDelegateForControl({control:j,modifier:J,readOnly:true,supportsDefault:true}).then(function(K){if(K&&K.instance){return K.instance.getPropertyInfo({element:j,aggregationName:I,payload:K.payload});}return[];});}function e(j,I,K){var M=K.addViaDelegate;var N;if(M){N=d.bind(null,j,I,M);}else{N=g.bind(null,j,I);}return N().then(function(P){return m(P);});}function f(P){return P.filter(function(j){return!(j.unsupported||j.hideFromReveal);});}function h(P,j){j.type="custom";if(j.id){j.itemId=P+"-"+j.id;j.key=j.itemId;}return j;}function i(P){return{selected:false,label:P.label||P.name,parentPropertyName:P.parentPropertyName?P.parentPropertyName:"",duplicateName:P.duplicateName?P.duplicateName:false,tooltip:P.tooltip||P.label,originalLabel:"",type:"delegate",entityType:P.entityType,name:P.name,bindingPath:P.bindingPath};}function k(j){var I=j.element;var K=j.action;return{selected:false,label:I.__label||E.getLabelForElement(I,K.getLabel),tooltip:I.__tooltip||E.getLabelForElement(I,K.getLabel)||I.__bindingPath,parentPropertyName:I.__parentPropertyName?I.__parentPropertyName:"",duplicateName:I.__duplicateName?I.__duplicateName:false,originalLabel:I.__renamedLabel&&I.__label!==I.__originalLabel?I.__originalLabel:"",bindingPath:I.__bindingPath,type:"invisible",elementId:I.getId()};}function l(j,R,I,M){if(R&&R!==j){var K=b(j,I,M);return E.findAllSiblingsInContainer(j,R).filter(function(S){return K===b(S,I,M);});}return[j];}function m(P){P.forEach(function(M,I,P){if(M["duplicateName"]!==true){for(var j=I+1;j<P.length-1;j++){if(M.label===P[j].label){M["duplicateName"]=true;P[j]["duplicateName"]=true;}}}});return P;}function n(I,P){return P.some(function(M){return M.label===I.__label;});}function o(M){return M.some(function(j){return j.hideFromReveal;});}function p(j){return Array.isArray(j)&&j.length>0;}function r(j,P){return P.filter(function(M){return j.some(function(I){return I.startsWith(M.bindingPath);});});}function s(j){return(q.isPlainObject(j)?j.parts[0].path:!!j.getPath&&j.getPath());}function t(j,I,M,K){var N=j.getModel(M);var R=l(j,I.relevantContainer,K,M);var P=[];R.forEach(function(j){P=P.concat(B.getBindings(j,N).map(s));});return P;}function u(j,I){var P={element:j.relevantContainer,aggregationName:I,payload:j.delegateInfo.payload||{}};return j.delegateInfo.delegate.getRepresentedProperties(P);}function v(j,I,M,K){return u(I,K).then(function(R){if(R===undefined){return t(j,I,M,K);}var N=[];R.forEach(function(P){N=N.concat(P.bindingPaths);});return N;});}function w(j,I,M,K){return Promise.resolve().then(function(){var N=!!O.get("delegateInfo.delegate.getRepresentedProperties",I);if(N){return v(j,I,M,K);}return t(j,I,M,K);});}function x(I,S){I.__originalLabel=S.label;I.__tooltip=S.tooltip;I.__bindingPath=S.name;if(I.__label!==I.__originalLabel){I.__renamedLabel=true;}if(S.parentPropertyName){I.__parentPropertyName=S.parentPropertyName;}}function y(j,I){var K=!!O.get("delegateInfo.delegate.getRepresentedProperties",j);if(K){return u(j,I);}}function z(I,R){var j;R.some(function(P){if(P.id===I.getId()){j=P;return true;}});return j.bindingPaths||[];}function A(I,P,j){if(p(j)){var M=r(j,P);if(!M.length||o(M)){return false;}x(I,M.pop());}return true;}function C(j,I,K,M,R,P){var N=M.addViaDelegate;var Q=G(N);var S=j.getModel(Q);var T=true;var U=[];if(R){U=z(K,R);}else if(b(j,I,Q)===b(K,I,Q)){U=B.collectBindingPaths(K,S,K).bindingPaths;}else if(B.getBindings(K,S).length>0){T=false;}if(T){K.__duplicateName=n(K,P);T=A(K,P,U);}return T;}function F(I,j,K,M){var N=j.addViaCustom;if(N&&K){N.items.forEach(function(P){h(M.getParent().getId(),P);if(P.itemId===I.getId()){x(I,P);}});}}function G(j){return O.get("delegateInfo.payload.modelName",j);}var H={enhanceInvisibleElements:function(j,I){var R=I.reveal;var K=I.addViaDelegate;var M=j.getMetadata().getAggregation();var N=M?M.name:I.aggregation;return Promise.all([e(j,N,I),y(K,N)]).then(function(P){var Q=P[0];var S=P[1];var T=[];var U=R.elements||[];U.forEach(function(V){var W=V.element;var X=V.action;W.__label=E.getLabelForElement(W,X.getLabel);var Y=C(j,N,W,I,S,Q);F(W,I,Y,j);if(Y){T.push({element:W,action:X});}});return T;}).then(function(P){return P.map(k);});},getUnrepresentedDelegateProperties:function(j,I){var M=G(I);var K=j.getMetadata().getAggregation();var N=K?K.name:I.action.aggregation;return Promise.all([d(j,N,I),w(j,I,M,N)]).then(function(P){var Q=P[0];var R=P[1];var S=I.action.filter?I.action.filter:function(){return true;};var U=f(Q);U=U.filter(function(T){var V=false;if(R){V=R.some(function(W){return W===T.bindingPath;});}return!V&&S(I.relevantContainer,T);});U=m(U);return U;}).then(function(U){return U.map(i);});},getCustomAddItems:function(j,I){return new Promise(function(R){if(Array.isArray(I.items)){R(I.items.map(h.bind(null,j.getParent().getId())).filter(function(K){if(!K.id){L.error("CustomAdd item with label "+K.label+" does not contain an 'id' property","sap.ui.rta.plugin.AdditionalElementsAnalyzer#showAvailableElements");return false;}return!E.getElementInstance(K.itemId);}));}else{R();}});},getFilteredItemsList:function(j){var I=j[0];var K=2;var M=j[K];if(M){var N=I.map(function(P){return P.elementId;});j[K]=M.filter(function(P){return!P.itemId||N.indexOf(P.itemId)===-1;});}return j.reduce(function(P,Q){return P.concat(Q);},[]);}};return H;});
