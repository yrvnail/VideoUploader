/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/rta/plugin/Plugin","sap/ui/rta/plugin/RenameHandler","sap/ui/rta/Utils","sap/ui/dt/ElementOverlay","sap/ui/dt/OverlayRegistry","sap/ui/dt/OverlayUtil","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/fl/Layer","sap/ui/fl/variants/VariantManagement","sap/ui/base/ManagedObject","sap/base/Log"],function(P,R,U,E,O,a,D,f,L,V,M,b){"use strict";E.prototype._variantManagement=undefined;E.prototype.getVariantManagement=function(){return this._variantManagement;};E.prototype.setVariantManagement=function(k){this._variantManagement=k;};E.prototype.hasVariantManagement=function(){return!!this._variantManagement;};function d(o){var m=o.getElement().getManageDialog();if(m&&!m.bIsDestroyed){m.destroy();}}var C=P.extend("sap.ui.rta.plugin.ControlVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:"string"},associations:{},events:{}}});C.prototype.registerElementOverlay=function(o){var c=o.getElement();var v;P.prototype.registerElementOverlay.apply(this,arguments);if(c instanceof V){var A=c.getFor();var e;var g=f.getAppComponentForControl(c);var s=c.getId();v=g.getLocalId(s)||s;o.setVariantManagement(v);if(!A||(Array.isArray(A)&&A.length===0)){return;}e=!Array.isArray(A)?[A]:A;e.forEach(function(h){var i=h instanceof M?h:sap.ui.getCore().byId(h);var j=O.getOverlay(i);this._propagateVariantManagement(j,v);}.bind(this));o.attachEvent("editableChange",R._manageClickEvent,this);d(o);}else if(!o.getVariantManagement()){v=this._getVariantManagementFromParent(o);if(v){o.setVariantManagement(v);o.attachEvent("editableChange",R._manageClickEvent,this);}}};C.prototype._isPersonalizationMode=function(){return this.getCommandFactory().getFlexSettings().layer===L.USER;};C.prototype._propagateVariantManagement=function(p,v){var e=[];p.setVariantManagement(v);e=a.getAllChildOverlays(p);e.forEach(function(o){e=e.concat(this._propagateVariantManagement(o,v));}.bind(this));return e;};C.prototype._getVariantManagementFromParent=function(o){var v=o.getVariantManagement();if(!v&&o.getParentElementOverlay()){return this._getVariantManagementFromParent(o.getParentElementOverlay());}return v;};C.prototype.deregisterElementOverlay=function(o){if(this._isVariantManagementControl(o)){d(o);}o.detachEvent("editableChange",R._manageClickEvent,this);o.detachBrowserEvent("click",R._onClick,this);this.removeFromPluginsList(o);P.prototype.deregisterElementOverlay.apply(this,arguments);};C.prototype._getVariantModel=function(e){var A=f.getAppComponentForControl(e);return A?A.getModel(f.VARIANT_MODEL_NAME):undefined;};C.prototype._isEditable=function(o){if(this._isPersonalizationMode()){return false;}return this._isVariantManagementControl(o)&&this.hasStableId(o);};C.prototype._isVariantManagementControl=function(o){var e=o.getElement();var A=e.getAssociation("for");return!!(A&&e instanceof V);};C.prototype.isVariantSwitchAvailable=function(e){return this._isVariantManagementControl(e);};C.prototype.isVariantSwitchEnabled=function(e){var o=e[0];var v=[];if(this._isVariantManagementControl(o)){var c=o.getElement();var s=o.getVariantManagement?o.getVariantManagement():undefined;if(!s){return false;}var m=this._getVariantModel(c);if(m){v=m.getData()[s].variants.reduce(function(r,h){if(h.visible){return r.concat(h);}return r;},[]);}var g=v.length>1;return g;}return false;};C.prototype.setDesignTime=function(o){R._setDesignTime.call(this,o);};C.prototype.isRenameAvailable=function(e){return this._isVariantManagementControl(e);};C.prototype.isRenameEnabled=function(e){return this._isVariantManagementControl(e[0]);};C.prototype.isVariantSaveAvailable=function(e){return this._isVariantManagementControl(e);};C.prototype.isVariantSaveEnabled=function(e){var o=e[0];var c=o.getElement();var m=this._getVariantModel(c);var v=o.getVariantManagement();return m.oData[v]&&m.oData[v].modified;};C.prototype.isVariantSaveAsAvailable=function(e){return this._isVariantManagementControl(e);};C.prototype.isVariantSaveAsEnabled=function(e){return this._isVariantManagementControl(e[0]);};C.prototype.isVariantConfigureAvailable=function(e){return this._isVariantManagementControl(e);};C.prototype.isVariantConfigureEnabled=function(e){return this._isVariantManagementControl(e[0]);};C.prototype.switchVariant=function(t,n,c){var o=t.getDesignTimeMetadata();var T=t.getElement();this.getCommandFactory().getCommandFor(T,"switch",{targetVariantReference:n,sourceVariantReference:c},o).then(function(s){this.fireElementModified({command:s});}.bind(this)).catch(function(m){throw D.createError("ControlVariant#switchVariant",m,"sap.ui.rta");});};C.prototype.renameVariant=function(e){this.startEdit(e[0]);};C.prototype.startEdit=function(v){var c=v.getDesignTimeMetadata().getData().variantRenameDomRef;R.startEdit.call(this,{overlay:v,domRef:c,pluginMethodName:"plugin.ControlVariant.startEdit"});};C.prototype.stopEdit=function(r){R._stopEdit.call(this,r,"plugin.ControlVariant.stopEdit");};C.prototype.createSaveCommand=function(e){var o=e[0];var c=o.getElement();var g=o.getDesignTimeMetadata();var m=this._getVariantModel(c);var v=o.getVariantManagement();return this.getCommandFactory().getCommandFor(c,"save",{model:m},g,v).then(function(s){this.fireElementModified({command:s});}.bind(this));};C.prototype.createSaveAsCommand=function(e){var o=e[0];var c=o.getElement();var g=o.getDesignTimeMetadata();var m=this._getVariantModel(c);var v=o.getVariantManagement();var s=m.getCurrentVariantReference(v);return this.getCommandFactory().getCommandFor(c,"saveAs",{sourceVariantReference:s,model:m},g,v).then(function(S){this.fireElementModified({command:S});}.bind(this));};C.prototype._emitLabelChangeEvent=function(){var t=R._getCurrentEditableFieldText.call(this);var o=this._oEditedOverlay;var c=o.getDesignTimeMetadata();var r=o.getElement();var v=o.getVariantManagement();return this._createSetTitleCommand({text:t,element:r,designTimeMetadata:c,variantManagementReference:v}).then(function(s){this.fireElementModified({command:s});}.bind(this));};C.prototype._createSetTitleCommand=function(p){this._$oEditableControlDomRef.text(p.text);return this.getCommandFactory().getCommandFor(p.element,"setTitle",{newText:p.text},p.designTimeMetadata,p.variantManagementReference).catch(function(m){b.error("Error during rename: ",m);});};C.prototype._prepareOverlayForValueState=function(o,v){o.getValueState=function(){return"Error";};o.getValueStateText=function(){return v;};o.getDomRefForValueStateMessage=function(){return this.$();};};C.prototype.configureVariants=function(e){var o=e[0];var v=o.getElement();var s=o.getVariantManagement();var m=this._getVariantModel(v);var c=o.getDesignTimeMetadata();m.manageVariants(v,s,this.getCommandFactory().getFlexSettings().layer,U.getRtaStyleClassName()).then(function(g){return this.getCommandFactory().getCommandFor(v,"configure",{control:v,changes:g},c,s);}.bind(this)).then(function(g){this.fireElementModified({command:g});}.bind(this)).catch(function(g){throw D.createError("ControlVariant#configureVariants",g,"sap.ui.rta");});};C.prototype.getMenuItems=function(e){var o=e[0];var m=[];if(this.isRenameAvailable(o)){m.push({id:"CTX_VARIANT_SET_TITLE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_RENAME"),handler:this.renameVariant.bind(this),enabled:this.isRenameEnabled.bind(this),rank:210,icon:"sap-icon://edit"});}if(this.isVariantSaveAvailable(o)){m.push({id:"CTX_VARIANT_SAVE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SAVE"),handler:this.createSaveCommand.bind(this),enabled:this.isVariantSaveEnabled.bind(this),rank:220,icon:"sap-icon://save"});}if(this.isVariantSaveAsAvailable(o)){m.push({id:"CTX_VARIANT_SAVEAS",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_SAVEAS"),handler:this.createSaveAsCommand.bind(this),enabled:this.isVariantSaveAsEnabled.bind(this),rank:225,icon:"sap-icon://duplicate"});}if(this.isVariantConfigureAvailable(o)){m.push({id:"CTX_VARIANT_MANAGE",text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta").getText("CTX_VARIANT_MANAGE"),handler:this.configureVariants.bind(this),enabled:this.isVariantConfigureEnabled.bind(this),startSection:true,rank:230,icon:"sap-icon://action-settings"});}if(this.isVariantSwitchAvailable(o)){var c=this._getVariantModel(o.getElement());var s=o.getVariantManagement();var S=c.getData()[s].variants.reduce(function(r,v){if(v.visible){var g=c.getData()[s].currentVariant===v.key;var i={id:v.key,text:v.title,icon:g?"sap-icon://accept":"blank",enabled:!g};return r.concat(i);}return r;},[]);m.push({id:"CTX_VARIANT_SWITCH_SUBMENU",text:sap.ui.getCore().getLibraryResourceBundle('sap.ui.rta').getText('CTX_VARIANT_SWITCH'),handler:function(e,p){var g=p.eventItem.data();var t=e[0];var n=g.key;var h=c.getData()[s].currentVariant;return this.switchVariant(t,n,h);}.bind(this),enabled:this.isVariantSwitchEnabled.bind(this),submenu:S,rank:240,icon:"sap-icon://switch-views"});}return m;};C.prototype.getActionName=function(){return"controlVariant";};return C;});
