/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_omit","sap/base/util/isEmptyObject","sap/ui/dt/Util","sap/ui/rta/plugin/Plugin","sap/ui/rta/plugin/RenameHandler","sap/ui/rta/Utils","sap/ui/fl/write/api/ContextSharingAPI"],function(_,i,D,P,R,U,C){"use strict";var a=P.extend("sap.ui.rta.plugin.CompVariant",{metadata:{library:"sap.ui.rta",properties:{oldValue:{type:"string"}}}});function b(o){return o.getElement().getMetadata().getName()==="sap.ui.comp.smartvariants.SmartVariantManagement";}function c(o,n,p){var k=o.getDesignTimeMetadata();var t=o.getElement();return this.getCommandFactory().getCommandFor(t,n,p,k).then(function(l){this.fireElementModified({command:l});}.bind(this)).catch(function(m){throw D.createError(n,m,"sap.ui.rta.plugin.CompVariant");});}function g(o){return o.getElement().getAllVariants();}function r(o){this.startEdit(o[0]);}a.prototype.startEdit=function(o){var v=o.getDesignTimeMetadata().getData().variantRenameDomRef;R.startEdit.call(this,{overlay:o,domRef:v,pluginMethodName:"plugin.CompVariant.startEdit"});};a.prototype.stopEdit=function(k){R._stopEdit.call(this,k,"plugin.CompVariant.stopEdit");};a.prototype._emitLabelChangeEvent=function(){var o=this._oEditedOverlay;var v=o.getElement().getPresentVariantId();var t=R._getCurrentEditableFieldText.call(this);var p={newVariantProperties:{}};p.newVariantProperties[v]={name:t};c.call(this,o,"compVariantUpdate",p);};function d(o){var v=o[0].getElement();var p={layer:this.getCommandFactory().getFlexSettings().layer,contextSharingComponentContainer:C.createComponent(this.getCommandFactory().getFlexSettings()),rtaStyleClass:U.getRtaStyleClassName()};v.openManageViewsDialogForKeyUser(p,function(k){if(!i(k)){c.call(this,o[0],"compVariantUpdate",{newVariantProperties:_(k,["default"]),newDefaultVariantId:k.default,oldDefaultVariantId:v.getDefaultVariantId()});}}.bind(this));}function e(o){return g(o[0]).length>1;}function s(o,p){var v=o[0].getElement();var E=p.eventItem.data();c.call(this,o[0],"compVariantSwitch",{targetVariantId:E.key,sourceVariantId:v.getPresentVariantId()});}function f(o){var v=o[0].getElement();v.getPresentVariantContent().then(function(k){var p={onlySave:true,newVariantProperties:{}};p.newVariantProperties[v.getPresentVariantId()]={content:k};c.call(this,o[0],"compVariantUpdate",p);}.bind(this));}function h(o){return o[0].getElement().currentVariantGetModified();}function j(o){var v=o[0].getElement();var k=C.createComponent(this.getCommandFactory().getFlexSettings());v.openSaveAsDialogForKeyUser(U.getRtaStyleClassName(),function(l){if(l){c.call(this,o[0],"compVariantSaveAs",{newVariantProperties:{"default":l.default,executeOnSelection:l.executeOnSelection,content:l.content,type:l.type,text:l.text,contexts:l.contexts},previousDirtyFlag:v.getModified(),previousVariantId:v.getPresentVariantId(),previousDefault:v.getDefaultVariantId()});}}.bind(this),k);}a.prototype._isEditable=function(o){return b(o)&&this.hasStableId(o);};a.prototype.getMenuItems=function(E){var o=E[0];var v=o.getElement();var m=[];if(this._isEditable(o)){var l=this.getCommandFactory().getFlexSettings().layer;var L=sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");var V=g(o);var k=V.find(function(n){return n.getId()===v.getPresentVariantId();});if(k.isRenameEnabled(l)){m.push({id:"CTX_COMP_VARIANT_RENAME",text:L.getText("CTX_RENAME"),handler:r.bind(this),enabled:true,rank:210,icon:"sap-icon://edit"});}if(k.isEditEnabled(l)){m.push({id:"CTX_COMP_VARIANT_SAVE",text:L.getText("CTX_VARIANT_SAVE"),handler:f.bind(this),enabled:h,rank:220,icon:"sap-icon://save"});}m.push({id:"CTX_COMP_VARIANT_SAVE_AS",text:L.getText("CTX_VARIANT_SAVEAS"),handler:j.bind(this),enabled:true,rank:230,icon:"sap-icon://duplicate"});m.push({id:"CTX_COMP_VARIANT_MANAGE",text:L.getText("CTX_VARIANT_MANAGE"),handler:d.bind(this),enabled:true,rank:240,icon:"sap-icon://action-settings"});var S=V.map(function(n){var p=v.getPresentVariantId()===n.getId();var I={id:n.getId(),text:n.getText("variantName"),icon:p?"sap-icon://accept":"blank",enabled:!p};return I;});m.push({id:"CTX_COMP_VARIANT_SWITCH",text:L.getText("CTX_VARIANT_SWITCH"),handler:s.bind(this),enabled:e,submenu:S,rank:250,icon:"sap-icon://switch-views"});}return m;};a.prototype.getActionName=function(){return"compVariant";};return a;});
