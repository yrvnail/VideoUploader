/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/dt/OverlayRegistry","sap/ui/dt/ElementOverlay","sap/ui/dt/AggregationOverlay","sap/ui/dt/Util","sap/ui/fl/Utils","sap/ui/fl/write/api/ExtensionPointRegistryAPI","sap/base/util/deepEqual","sap/base/util/isEmptyObject","sap/base/util/merge","sap/base/util/restricted/_omit","sap/ui/core/mvc/View","sap/base/Log"],function(O,E,A,D,F,a,d,i,m,_,V,L){"use strict";function g(v,C){var e=a.getExtensionPointInfoByViewId({viewId:v});return _(e,C);}function c(o){return _(o,["bIsView"]);}return function(r,p){var o={};o.mExtensionPointMetadata={palette:{icons:{svg:"sap/ui/core/designtime/Icon.icon.svg"}}};o._aConsideredExtensionPoints=[];o._attachNotConsideredExtensionPoints=function(b,e){var v=F.getViewForControl(b.getElement()).getId();var f=g(v,this._aConsideredExtensionPoints);Object.keys(f).forEach(function(s,I){var h=f[s];var j=this._getExtensionPointData(h);j.id=v;e.elements.splice(I,0,j);this._aConsideredExtensionPoints.push(j.name);}.bind(this));};o._getOutline=function(I,b){var R;if(!b&&D.isInteger(I)){b=I;I=undefined;}var e=[];if(!I){e=r._oDesignTime.getRootElements().map(function(s){return O.getOverlay(s);});}else{var P=O.getOverlay(I);if(!P){throw D.createError("services.Outline#get","Cannot find element with id= "+I+". A valid or empty value for the initial element id should be provided.","sap.ui.rta");}e.push(P);}R=e.map(function(f){return this._getChildrenNodes(f,b);},this);this._aConsideredExtensionPoints=[];return R;};o._getExtensionPoints=function(b){var P=b.id;var s=b.technicalName;return a.getExtensionPointInfoByParentId({parentId:P}).filter(function(e){return e.aggregationName===s;});};o._getExtensionPointData=function(e){return{id:e.targetControl.getId(),name:e.name,technicalName:"sap.ui.extensionpoint",type:"extensionPoint",icon:this.mExtensionPointMetadata.palette.icons.svg,extensionPointInfo:{defaultContent:e.defaultContent.map(function(C){return C.getId();})}};};o._enrichExtensionPointData=function(b,e){var I=sap.ui.getCore().getConfiguration().getDesignMode();if(!I){return undefined;}if(b.type==="aggregation"){var f=this._getExtensionPoints(b).sort(function(h,j){return j.index-h.index;});f.forEach(function(h){var j=this._getExtensionPointData(h);b.elements.splice(h.index,0,j);this._aConsideredExtensionPoints.push(j.name);}.bind(this));}else if(b.bIsView){return this._attachNotConsideredExtensionPoints(e,b);}};o._getChildrenNodes=function(b,e,P){var v=D.isInteger(e);if(b.getShouldBeDestroyed()){return{};}var f=this._getNodeProperties(b,P)||{};var C=b.getChildren();if((!v||(v&&e>0))&&C.length>0&&!i(f)){e=v?e-1:e;f.elements=C.map(function(h){return this._getChildrenNodes(h,e,h.getParent());},this).filter(function(h){return!i(h);});this._enrichExtensionPointData(f,b);}return c(f);};o._getNodeProperties=function(b,P){var e;var s;var t;var v;var I=false;var f=b.getElement();var h=f.getId();var j=f.getMetadata().getName();var k=b.getDesignTimeMetadata();var l=k.getData();var n=k.getLabel(f);var q=(l.palette&&l.palette.icons&&l.palette.icons.svg||undefined);var u;if(b instanceof E){t="element";I=b.getEditable();e=k.getName(f);v=b.isVisible();u=b.getElement()instanceof V;}else{t="aggregation";s=b.getAggregationName();e=P.getAggregation(s)?P.getDesignTimeMetadata().getAggregationDescription(s,f):undefined;}var w=Object.assign({id:h,technicalName:s||j,editable:I,type:t},n!==h&&n!==undefined&&{instanceName:n},e&&e.singular&&{name:e.singular},q!==undefined&&{icon:q},typeof v==="boolean"&&{visible:v},u&&{bIsView:u});return w;};o._removeDuplicate=function(R,b){return R.filter(function(u){return!d(b,u,Infinity);});};o._updatesHandler=function(e){var P=e.getParameters();if(this.sStatus==="initial"){this.aUpdates=[];}var R=m({},P);var s=R.id?O.getOverlay(R.id).getElement().getId():undefined;var t=R.targetId?O.getOverlay(R.targetId).getElement().getId():undefined;switch(e.getId()){case"elementOverlayCreated":if(P.elementOverlay.isRoot()){var b=P.elementOverlay.getElement().getId();R.element=o._getOutline(b)[0];R.type="new";break;}return;case"elementOverlayAdded":R.element=o._getOutline(s)[0];R.targetId=t;R.type="new";break;case"elementOverlayMoved":R.element=o._getOutline(s,0)[0];R.targetId=t;R.type="move";break;case"elementOverlayDestroyed":var f=R.elementOverlay.getParentAggregationOverlay();if((f instanceof A&&!f._bIsBeingDestroyed)||R.elementOverlay.isRoot()){R.element={};R.element.id=R.elementOverlay.getElement()?R.elementOverlay.getElement().getId():R.elementOverlay.getAssociation("element");R.type="destroy";break;}return;case"elementOverlayEditableChanged":R.element={id:s,editable:R.editable};R.type="editableChange";break;case"elementPropertyChanged":R.element=o._getOutline(s,0)[0];R.type="elementPropertyChange";break;default:L.error("Event type is not 'expected' by handler");}R=_(R,["elementOverlay","editable","target","id","elementId"]);this.aUpdates=o._removeDuplicate(this.aUpdates,R);this.aUpdates.push(R);if(this.sStatus==="initial"){setTimeout(function(){if(Array.isArray(this.aUpdates)&&this.aUpdates.length>0){this.sStatus="initial";p("update",this.aUpdates);}}.bind(o),200);}this.sStatus="processing";};o.destroy=function(){r._oDesignTime.detachEvent("elementOverlayCreated",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayAdded",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayMoved",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayDestroyed",this._updatesHandler,this);r._oDesignTime.detachEvent("elementPropertyChanged",this._updatesHandler,this);r._oDesignTime.detachEvent("elementOverlayEditableChanged",this._updatesHandler,this);delete this.aUpdates;delete this.sStatus;};o.aUpdates=[];o.sStatus="initial";r._oDesignTime.attachEvent("elementOverlayCreated",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayAdded",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayMoved",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayDestroyed",o._updatesHandler,o);r._oDesignTime.attachEvent("elementPropertyChanged",o._updatesHandler,o);r._oDesignTime.attachEvent("elementOverlayEditableChanged",o._updatesHandler,o);return{events:["update"],exports:{get:o._getOutline.bind(o)},destroy:o.destroy.bind(o)};};});
