/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/mdc/Control","./chart/ChartSettings","sap/ui/base/SyncPromise","sap/ui/mdc/util/loadModules","./ChartRenderer","sap/ui/base/ManagedObjectObserver","sap/ui/model/json/JSONModel","sap/ui/mdc/library","sap/ui/model/base/ManagedObjectModel","sap/ui/model/Sorter","sap/base/Log","sap/base/util/deepEqual","sap/ui/Device","sap/ui/mdc/chart/ToolbarHandler","sap/ui/mdc/mixin/FilterIntegrationMixin","sap/m/VBox","sap/m/Text","sap/ui/mdc/p13n/subcontroller/ChartItemController","sap/ui/mdc/p13n/subcontroller/SortController",'sap/ui/events/KeyCodes'],function(C,a,b,S,l,c,M,J,d,e,f,L,g,D,T,F,V,h,m,n,K){"use strict";var o,p,q,r,s,t,u="sap.ui.mdc.IFilter";var v=a.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",designtime:"sap/ui/mdc/designtime/chart/Chart.designtime",interfaces:["sap.ui.mdc.IxState"],defaultAggregation:"items",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/ChartDelegate"}},header:{type:"string",group:"Misc",defaultValue:null},noDataText:{type:"string"},chartType:{type:"string",group:"Misc",defaultValue:"column"},selectionMode:{type:"string",group:"Misc",defaultValue:"MULTIPLE"},p13nMode:{type:"sap.ui.mdc.ChartP13nMode[]"},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},vizProperties:{type:"object",group:"Misc"},_colorings:{type:"object",visibility:"_hidden",byValue:true},ignoreToolbarActions:{type:"sap.ui.mdc.ChartToolbarActionType[]",defaultValue:[]},minWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"240px",invalidate:true},minHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"400px",invalidate:true},sortConditions:{type:"object"},showChartTooltip:{type:"boolean",group:"Misc",defaultValue:true},autoBindOnInit:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{data:{multiple:true},items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--toolbar",aggregation:"actions"}},_chart:{type:"sap.chart.Chart",multiple:false},_toolbar:{type:"sap.ui.mdc.ActionToolbar",multiple:false},_breadcrumbs:{type:"sap.m.Breadcrumbs",multiple:false},_noDataStruct:{type:"sap.m.VBox",multiple:false},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false}},associations:{filter:{type:u,multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}},dataPointsSelected:{parameters:{dataContext:{type:"object"}}}}}});var _=function(i){if(!this.oChartPromise){return;}this.oChartPromise.then(function(j){if(this.bIsDestroyed){return;}i=i||this.getSelectionMode();j.setSelectionMode(i);if(i!=="NONE"){this._prepareSelection();}}.bind(this));};F.call(v.prototype);v.prototype.init=function(){this._oObserver=new M(this.update.bind(this));this._oObserver.observe(this,{aggregations:["items","_chart"],properties:["ignoreToolbarActions","p13nMode"]});this._oManagedObjectModel=new e(this);this.setModel(this._oManagedObjectModel,"$mdcChart");a.prototype.init.apply(this,arguments);};v.prototype.initModules=function(i){this.initControlDelegate(i[0]);o=i[1];r=i[2];s=i[3];t=i[4];};function w(){return["sap/chart/Chart","sap/ui/mdc/chart/ChartTypeButton","sap/ui/mdc/chart/MeasureItem","sap/viz/ui5/controls/VizTooltip"];}v.prototype.applySettings=function(i,j){var A;if(i){A=i.actions;delete i.actions;}var k=a.prototype.applySettings.apply(this,arguments);this._tempResolve;this._tempReject;this.oChartPromise=new S(function(B,E){this._tempResolve=B;this._tempReject=E;}.bind(this));var R={};R.controller={};var z=this.getP13nMode()||[];z.forEach(function(B){if(B=="Item"){R.controller["Item"]=m;}if(B=="Sort"){R.controller["Sort"]=n;}});this.getEngine().registerAdaptation(this,R);if(this.getAutoBindOnInit()){this._createChart(i,A);}else{this._mStoredSettings=i;this._mStoredActions=A;T.createToolbar(this,A,true);this._createTempNoData();}return k;};v.prototype._createTempNoData=function(){var N=new h({text:this.getProperty("noDataText")});var i=new V({items:[N],justifyContent:"Center",alignItems:"Center",height:"100%"});this.setAggregation("_noDataStruct",i);};v.prototype._createChart=function(i,A){var j=(i&&i.delegate)||this.getDelegate();var k=j&&j.name;var z=[k].concat(w());this.setBusyIndicatorDelay(0);this.setBusy(true);l(z).then(function E(B){this.initModules(B);if(this.bIsDestroyed){return S.reject();}return this.getControlDelegate().fetchProperties(this);}.bind(this)).then(function B(P){if(this.bIsDestroyed){return S.reject();}var I={};P.forEach(function(E){I[E.name]=E;});if(this.getAggregation("_noDataStruct")){this.getAggregation("_noDataStruct").destroy();this.setAggregation("_noDataStruct",null);}return this._createInnerChart(i,I);}.bind(this)).then(function B(I){if(this.getAutoBindOnInit()){T.createToolbar(this,A);}else{T.updateToolbar(this);}this._createDrillBreadcrumbs();this._toggleChartTooltipVisibility(this.getShowChartTooltip());this._tempResolve(I);return I;}.bind(this)).catch(function B(E){this._tempReject();if(E){L.error("The control could not be initialized.",E,this.getMetadata().getName());}}.bind(this));if(!i||i.selectionMode===undefined){_.apply(this);}if(i&&i.data){this._addBindingListener(i.data,"change",this._onDataLoadComplete.bind(this));}this._bInnerChartInitialized=true;this.bindAggregation("data",this.oDataInfo);};v.prototype.bindAggregation=function(N,B,i){if(N=="data"){this.oDataInfo=B;var j=this.getAggregation("_chart");if(j&&this.bDelegateInitialized){this.getControlDelegate().rebindChart(this,B,i);}else if(this.oChartPromise){this.oChartPromise.then(function(j){this.getControlDelegate().rebindChart(this,B,i);}.bind(this));}return this;}return a.prototype.bindAggregation.apply(this,arguments);};v.prototype._onDataLoadComplete=function(E){if(E.mParameters.reason==="change"&&!E.mParameters.detailedReason){this.setBusy(false);}};v.prototype._addBindingListener=function(B,E,H){if(!B.events){B.events={};}if(!B.events[E]){B.events[E]=H;}else{var O=B.events[E];B.events[E]=function(){H.apply(this,arguments);O.apply(this,arguments);};}};v.prototype.getBindingInfo=function(N){if(N=="data"){return this.oDataInfo;}return a.prototype.getBindingInfo.apply(this,arguments);};v.prototype.setLegendVisible=function(i){this.setVizProperties({'legend':{'visible':i},'sizeLegend':{'visible':i}});return this.setProperty("legendVisible",i);};v.prototype._createInnerChart=function(k,I){k=k||{};var z={},A,B=[],E=[],G=[],H={};z.chartType='{$mdcChart>/chartType}';z.dimensions=[];z.measures=[];z.id=this.getId()+"--innerChart";z.height='100%';z.width='100%';z.vizProperties='{$mdcChart>/vizProperties}';k.items=k.items||[];function N(j){if(this&&this.getVizItemType()=="Dimension"){z.dimensions.push(j);}else{z.measures.push(j);}}function O(A,R){if(A.getCriticality()){R._addCriticality(A);}G.push(A.getKey());if(A.getAdditionalColoringMeasures){for(var j=0;j<A.getAdditionalColoringMeasures().length;j++){if(E.indexOf(A.getAdditionalColoringMeasures()[j])==-1){E.push(A.getAdditionalColoringMeasures()[j]);}}}}function P(){var j,R;for(var i=0;i<E.length;i++){j=E[i];if(G.indexOf(j)==-1){R=this.getControlDelegate().retrieveAggregationItem("items",I[j]);R=s.getVizItemSettings(R.settings);B.push(s.createVizChartItem(R).then(N));}}}for(var i=0;i<k.items.length;i++){A=k.items[i];O(A,this);if(I[A.getKey()]){H=this.getControlDelegate().retrieveAggregationItem("items",I[A.getKey()]).settings;}else{H=undefined;}B.push(A.toVizChartItem(H).then(N.bind(A)));}P();var Q=function(j){this.fireDataPointsSelected({dataContext:j.getParameters()});};return Promise.all(B).then(function(){var j=new o(z);j.setVisibleDimensions([]);j.setVisibleMeasures([]);j.setInResultDimensions([]);j.attachSelectData(function(R){Q.call(this,R);}.bind(this));j.attachDeselectData(function(R){Q.call(this,R);}.bind(this));this._oObserver.observe(j,{bindings:["data"],aggregations:["dimensions","measures"]});this.setAggregation("_chart",j);return j;}.bind(this));};v.prototype.setSelectionMode=function(i){this.setProperty("selectionMode",i,true);i=this.getSelectionMode();_.call(this,i);return this;};v.prototype.addItem=function(i,j){var k=this.getAggregation("_chart");if(k){i.toChart(k);}else if(this.oChartPromise){this.oChartPromise.then(function(k){if(k){this.toChart(k);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.addAggregation("items",i,j);};v.prototype.insertItem=function(i,I,j){if(i.getCriticality()){this._addCriticality(i);}var k=this.getAggregation("_chart");if(k){i.toChart(k);}else if(this.oChartPromise){this.oChartPromise.then(function(k){if(k){this.toChart(k);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.insertAggregation("items",i,I,j);};v.prototype.removeItem=function(i,j){this._oObserver.unobserve(i);return this.removeAggregation("items",i,j);};v.prototype.exit=function(){a.prototype.exit.apply(this,arguments);this.oChartPromise=null;this._oSelectionHandlerPromise=null;var i=this.getAggregation("_chart");if(i){i.destroy();}};v.prototype.getItemsByKeys=function(I){var j=[],k=this.getItems();I.forEach(function(z){for(var i=k.length-1;i>=0;i--){if(k[i].getKey()==z){j.push(k[i]);break;}}});return j;};v.prototype._showDrillDown=function(){if(q){if(!this._oDrillDownPopover){q.createDrillDownPopover(this);}return q.showDrillDownPopover(this);}return new Promise(function(i,j){sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(k){q=k;q.createDrillDownPopover(this);q.showDrillDownPopover(this).then(function(z){i(z);});}.bind(this));}.bind(this));};v.prototype._createDrillBreadcrumbs=function(){if(q){if(!this._oDrillBreadcrumbs){return q.createDrillBreadcrumbs(this);}return Promise.resolve(this._oDrillBreadcrumbs);}return new Promise(function(i,j){sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(k){q=k;q.createDrillBreadcrumbs(this).then(function(z){i(z);});}.bind(this));}.bind(this));};v.prototype._getPropertyData=function(){return new Promise(function(i,j){if(!this.aFetchedProperties){return this.oChartPromise.then(function(){return this.getControlDelegate().fetchProperties(this);}.bind(this)).then(function(k){this.aFetchedProperties=k;i(k);}.bind(this));}else{i(this.aFetchedProperties);}}.bind(this));};v.prototype.getAvailableChartTypes=function(){var j=[];var k=this.getAggregation("_chart");if(k){var A=k.getAvailableChartTypes().available;if(j){var z=C.getLibraryResourceBundle("sap.chart.messages");for(var i=0;i<A.length;i++){var B=A[i].chart;j.push({key:B,icon:r.mMatchingIcon[B],text:z.getText("info/"+B),selected:(B==this.getChartType())});}}}return j;};v.prototype.getTypeInfo=function(){var i=this.getChartType(),j=C.getLibraryResourceBundle("sap.ui.mdc");var I={icon:r&&r.mMatchingIcon[i]?r.mMatchingIcon[i]:"sap-icon://horizontal-bar-chart",text:j.getText("chart.CHART_TYPE_TOOLTIP",[i])};return I;};v.prototype.getManagedObjectModel=function(){return this._oManagedObjectModel;};v.prototype.update=function(i){var j=this.getAggregation("_chart");if(j){this._update(j,i);}else if(this.oChartPromise){this.oChartPromise.then(function(j){if(j){this._update(j,i);}}.bind(this));}};v.prototype._update=function(j,k){var I=this.getItems(),z,A,B=[],E=[],G=[],H={};if(k.name==="ignoreToolbarActions"||k.name==="p13nMode"){return;}if(k.name==="data"&&k.type==="binding"&&k.mutation==="prepare"&&k.object.isA("sap.chart.Chart")){k.bindingInfo.sorter=this._getSorters();}this._aInResultProperties=[];for(var i=0;i<I.length;i++){A=I[i];z=A.getVizItemType()=="Measure"?j.getMeasureByName(A.getKey()):j.getDimensionByName(A.getKey());if(!z){continue;}if(A.getVisible()){if(A.getVizItemType()=="Measure"){B.push(z.getName());if(A.getDataPoint()){H[z.getName()]=A.getDataPoint();}}else{E.push(z.getName());}this._aInResultProperties.push(z.getName());}if(A.getVizItemType()=="Dimension"){if(A.getInResult()){G.push(z.getName());this._aInResultProperties.push(z.getName());}}}var R=false;if(!g(E,j.getVisibleDimensions())){j.setVisibleDimensions(E);R=true;}if(!g(B,j.getVisibleMeasures())){j.setVisibleMeasures(B);R=true;}if(!g(G,j.getInResultDimensions())){j.setInResultDimensions(G);R=true;}if(R){this.rebind();this._updateSemanticalPattern(j,B,H);this._updateColoring(j,E,B);}if(q&&this.getAggregation("_breadcrumbs")){q._updateDrillBreadcrumbs(this,this.getAggregation("_breadcrumbs"));}};v.prototype._updateSemanticalPattern=function(i,j,z){for(var k=0;k<j.length;k++){var A=z[j[k]];if(A){if(A.targetValue||A.foreCastValue){var B=i.getMeasureByName(j[k]);B.setSemantics("actual");if(A.targetValue!=null){var R=i.getMeasureByName(A.targetValue);if(R){R.setSemantics("reference");}else{L.error("sap.ui.mdc.Chart: "+A.targetValue+" is not a valid measure");}}if(A.foreCastValue){var P=i.getMeasureByName(A.foreCastValue);if(P){P.setSemantics("projected");}else{L.error("sap.ui.comp.SmartChart: "+A.ForecastValue.Path+" is not a valid measure");}}B.setSemanticallyRelatedMeasures({referenceValueMeasure:A.targetValue,projectedValueMeasure:A.foreCastValue});}}}};v.prototype._updateColoring=function(i,j,z,A){var B=this.getProperty("_colorings"),k;if(B&&B.Criticality){var E;for(k=0;k<j.length;k++){if(B.Criticality.DimensionValues[j[k]]){E={coloring:"Criticality",parameters:{dimension:j[k]}};delete B.Criticality.MeasureValues;break;}}if(!E){delete B.Criticality.DimensionValues;for(var G in B.Criticality.MeasureValues){if(z.indexOf(G)==-1){delete B.Criticality.MeasureValues[G];}}E={coloring:"Criticality",parameters:{measure:z}};}if(E){i.setColorings(B);i.setActiveColoring(E);}}};v.prototype._prepareSelection=function(){if(p){p.prepareChart(this);}else{this._oSelectionHandlerPromise=l(["sap/ui/mdc/chart/SelectionHandler"]).then(function(i){p=i[0];if(this.bIsDestroyed){return;}p.prepareChart(this);}.bind(this));}};v.prototype._getSorters=function(){var i;var j=this.getSortConditions()?this.getSortConditions().sorters:[];j.forEach(function(k){if(this._aInResultProperties.indexOf(k.name)!=-1){var z=new f(k.name,k.descending);if(i){i.push(z);}else{i=[z];}}}.bind(this));return i;};v.prototype.rebind=function(){this.setBusy(true);if(!this._bInnerChartInitialized){this._createChart(this._mStoredSettings,this._mStoredActions);return;}if(!this.bDelegateInitialized){return;}var B=this.oDataInfo,i=this.getControlDelegate();if(i){i.updateBindingInfo(this,B);}if(!this.isInnerChartBound()){return;}if(B){B.sorter=this._getSorters();B.binding.bHasAnalyticalInfo=true;}this.bindAggregation("data",B);this._updateInnerChartNoDataText();this._renderOverlay(false);};v.prototype.isInnerChartBound=function(){return this.getAggregation("_chart")?this.getAggregation("_chart").isBound("data"):false;};v.prototype._onFiltersChanged=function(E){if(this.isInnerChartBound()&&E.getParameter("conditionsBased")){this._renderOverlay(true);}};v.prototype._renderOverlay=function(i){if(this.getAggregation("_chart")){var $=this.getAggregation("_chart").$(),j=$.find(".sapUiMdcChartOverlay");if(i&&j.length===0){j=jQuery("<div>").addClass("sapUiOverlay sapUiMdcChartOverlay").css("z-index","1");$.append(j);}else if(!i){j.remove();}}};v.prototype.setNoDataText=function(N){this.setProperty("noDataText",N,true);this._updateInnerChartNoDataText();return this;};v.prototype._onFilterProvided=function(){this._updateInnerChartNoDataText();};v.prototype._onFilterRemoved=function(){this._updateInnerChartNoDataText();};v.prototype._updateInnerChartNoDataText=function(){var i=this.getAggregation("_chart");if(!i){return;}i.setCustomMessages({'NO_DATA':this._getNoDataText()});};v.prototype._getNoDataText=function(){var N=this.getNoDataText();if(N){return N;}var R=C.getLibraryResourceBundle("sap.ui.mdc");if(!this.isInnerChartBound()){if(this.getFilter()){return R.getText("chart.NO_DATA_WITH_FILTERBAR");}return R.getText("chart.NO_DATA");}return R.getText("chart.NO_RESULTS");};v.prototype._addCriticality=function(i){var j=this.getProperty("_colorings");j=j||{Criticality:{DimensionValues:{},MeasureValues:{}}};var k=i.getCriticality(),z={};if(i.getVizItemType()=="Dimension"){for(var A in k){z[A]={Values:k[A]};}j.Criticality.DimensionValues[i.getKey()]=z;}else{for(var A in k){z[A]=k[A];}j.Criticality.MeasureValues[i.getKey()]=z;}this.setProperty("_colorings",j);};v.prototype.getCollectionModel=function(){var B=this.getBindingInfo("data");return B?this.getModel(B.model):null;};v.prototype.getCollectionPath=function(){var B=this.getBindingInfo("data");return B?B.path:null;};v.prototype.done=function(){return this.oChartPromise;};v.prototype.initialized=function(){return this.oChartPromise;};var x=function(i){var P=[];if(i){i.getItems().forEach(function(j,I){P.push({name:j.getKey(),role:j.getRole()});});}return P;};var y=function(i){return i.getSortConditions()?i.getSortConditions().sorters:[];};v.prototype.isFilteringEnabled=function(){var P=this.getP13nMode()||[];return P.indexOf("Filter");};v.prototype.getCurrentState=function(){var i={};var P=this.getP13nMode();if(P){if(P.indexOf("Item")>-1){i.items=x(this);}if(P.indexOf("Sort")>-1){i.sorters=y(this);}}return i;};v.prototype.setShowChartTooltip=function(i){this.setProperty("showChartTooltip",i);this._toggleChartTooltipVisibility(i);return this;};v.prototype._toggleChartTooltipVisibility=function(i){var j=this.getAggregation("_chart");if(j){this._setChartTooltipVisiblity(j,i);}else if(this.oChartPromise){this.oChartPromise.then(function(j){this._setChartTooltipVisiblity(j,i);}.bind(this));}};v.prototype._setChartTooltipVisiblity=function(i,j){if(j){if(!this._vizTooltip){this._vizTooltip=new t();}this._vizTooltip.connect(i.getVizUid());}else{if(this._vizTooltip){this._vizTooltip.destroy();}}};v.prototype.onkeydown=function(E){if(E.isMarked()){return;}if((E.metaKey||E.ctrlKey)&&E.which===K.COMMA){var i=C.byId(this.getId()+"-chart_settings");if(i&&i.getEnabled()&&i.getVisible()){i.firePress();E.setMarked();E.preventDefault();}}};return v;},true);
