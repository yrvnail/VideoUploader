/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/model/SimpleType','sap/ui/model/FormatException','sap/ui/model/ParseException','sap/ui/model/ValidateException','sap/ui/model/type/String','sap/ui/mdc/enum/FieldDisplay','sap/ui/mdc/condition/FilterOperatorUtil','sap/ui/mdc/condition/Operator','sap/ui/mdc/condition/Condition','sap/ui/mdc/enum/BaseType','sap/ui/mdc/enum/ConditionValidated','sap/base/util/merge','sap/ui/base/SyncPromise'],function(S,F,P,V,a,b,c,O,C,B,d,m,e){"use strict";var f=S.extend("sap.ui.mdc.field.ConditionType",{constructor:function(i,G){S.apply(this,arguments);this.sName="Condition";this._oResourceBundle=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this._oCalls={active:0,last:0,condition:undefined,exception:undefined};}});f.prototype.destroy=function(){S.prototype.destroy.apply(this,arguments);if(this._oDefaultType){this._oDefaultType.destroy();delete this._oDefaultType;}this._bDestroyed=true;};f.prototype.formatValue=function(i,I){if(i==undefined||i==null||this._bDestroyed){return null;}if(typeof i!=="object"||!i.operator||!i.values||!Array.isArray(i.values)){throw new F("No valid condition provided");}if(!I){I="string";}var T=o.call(this);var G=p.call(this);var H=this.oFormatOptions.isUnit;var J=this.oFormatOptions.preventGetDescription;t.call(this,i,G);if(H){i=m({},i);if(i.values[0]&&Array.isArray(i.values[0])){i.values[0]=i.values[0][1];}if(i.operator!=="EQ"){i.operator="EQ";if(i.values[1]){i.values.splice(1,1);}}}t.call(this,i,T);switch(this.getPrimitiveType(I)){case"string":case"any":var K=n.call(this);var L=q.call(this);var M=c.getEQOperator(L);this._oCalls.active++;this._oCalls.last++;var N=this._oCalls.last;if(!J&&i.operator===M.name&&K!==b.Value&&i.validated===d.Validated&&!i.values[1]){var Q=this.oFormatOptions.bindingContext;var R=this.oFormatOptions.conditionModel;var U=this.oFormatOptions.conditionModelName;return e.resolve().then(function(){return D.call(this,i.values[0],i.inParameters,i.outParameters,Q,R,U);}.bind(this)).then(function(W){if(W){i=m({},i);if(typeof W==="object"){i=v.call(this,i,W);}else if(i.values.length===1){i.values.push(W);}else{i.values[1]=W;}}return g.call(this,i,undefined,N,true,T);}.bind(this)).catch(function(W){var X;if(!(W instanceof F)||!z.call(this)){X=W;}return g.call(this,i,X,N,true,T);}.bind(this)).unwrap();}return g.call(this,i,undefined,N,true,T);default:if(T&&i.values.length>=1){return T.formatValue(i.values[0],I);}throw new F("Don't know how to format Condition to "+I);}};function _(i){var G=n.call(this);var T=o.call(this);var H=this.oFormatOptions.hideOperator&&i.values.length===1;var I=c.getOperator(i.operator);if(!I){throw new F("No valid condition provided, Operator wrong.");}return I.format(i,T,G,H);}function g(i,G,H,I,T){this._oCalls.active--;if(H<this._oCalls.last&&(this._oCalls.condition!==undefined||this._oCalls.exception!==undefined)){i=this._oCalls.condition;G=this._oCalls.exception;}if(H===this._oCalls.last&&this._oCalls.active>0){this._oCalls.condition=m({},i);this._oCalls.exception=G;}else if(this._oCalls.active===0&&this._oCalls.last>0){this._oCalls={active:0,last:0,condition:undefined,exception:undefined};}if(G){throw G;}var R;if(I){R=_.call(this,i);}else{R=h.call(this,i,T);}return R;}f.prototype.parseValue=function(i,I){if(this._bDestroyed){return null;}if(!I){I="string";}else if(I==="any"&&typeof i==="string"){I="string";}var N=this.oFormatOptions.navigateCondition;if(N){var G=this.formatValue(N,I);if(G===i){return m({},N);}}var H=n.call(this);var J=y.call(this);var T=o.call(this);var K=p.call(this);var L=q.call(this);var M=this.oFormatOptions.isUnit;var Q;if(i===null||i===undefined||(i===""&&!J)){if(!s.call(this,T)&&!M){return null;}}u.call(this,T);u.call(this,K);switch(this.getPrimitiveType(I)){case"string":var R;var U=false;var W=false;if(L.length===1){R=c.getOperator(L[0]);W=true;}else{var X=c.getMatchingOperators(L,i);if(X.length===0){R=E.call(this,L,T);if(J&&!s.call(this,T)){var Y=c.getEQOperator(L);if(L.indexOf(Y.name)>=0){U=!!R&&R.name!==Y.name;R=Y;}}W=true;}else{R=X[0];}}if(R){var Z;var $=s.call(this,T);this._oCalls.active++;this._oCalls.last++;var a1=this._oCalls.last;if(!$&&R.validateInput&&J){Z=j.call(this,R,i,T,W,U,L,H,true);if(Z instanceof Promise){return w.call(this,Z);}else{return Z;}}else if(i===""&&!$){return g.call(this,null,undefined,a1,false,T);}else{try{if(i===""&&$&&W){Z=C.createCondition(R.name,[T.parseValue(i,"string",T._aCurrentValue)],undefined,undefined,d.NotValidated);}else{Z=R.getCondition(i,T,H,W);}}catch(b1){var c1=b1;if(c1 instanceof P&&K){try{K.parseValue(i,"string",K._aCurrentValue);}catch(d1){c1=d1;}}return g.call(this,undefined,c1,a1,false,T);}}if(Z){return g.call(this,Z,undefined,a1,false,T);}}throw new P("Cannot parse value "+i);default:if(T){if(L.length===1){Q=L[0];}else{Q=E.call(this,L,T).name;if(L.indexOf(Q)<0){Q=undefined;}}if(Q){return C.createCondition(Q,[T.parseValue(i,I)],undefined,undefined,d.NotValidated);}}throw new P("Don't know how to parse Condition from "+I);}};function h(i,T){var I=this.oFormatOptions.isUnit;var G=p.call(this);var U=null;if(I){var M;if(G._aCurrentValue){M=G._aCurrentValue[0];}if(i){if(i.operator!=="EQ"){throw new P("unsupported operator");}U=i.values[0];i.values=[[M,U]];}else{i=C.createCondition("EQ",[[M,null]],undefined,undefined,d.NotValidated);}t.call(this,i,G);}else if(i){var N=T.getMetadata().getName();var H=this.oFormatOptions.delegate;var J=this.oFormatOptions.payload;if(H&&H.getTypeUtil(J).getBaseType(N)===B.Unit&&!i.values[0][1]&&T._aCurrentValue){U=T._aCurrentValue[1]?T._aCurrentValue[1]:null;i.values[0][1]=U;if(i.operator==="BT"){i.values[1][1]=U;}}t.call(this,i,T);t.call(this,i,G);}return i;}function j(i,G,T,U,H,I,J,K){var L;var M;var N=true;var Q=true;var R=false;var W;var X;var Y=this.oFormatOptions.bindingContext;var Z=this.oFormatOptions.conditionModel;var $=this.oFormatOptions.conditionModelName;var a1;if(G===""){a1=[];L=G;W=G;}else{a1=i.getValues(G,J,U);L=K?a1[0]:a1[1];M=K?a1[1]:a1[0];R=J!==b.Value;Q=J===b.Value||J===b.ValueDescription;W=Q?L||M:M||L;}var b1=function(f1){if(f1&&!(f1 instanceof P)&&!(f1 instanceof F)){throw f1;}if(!f1._bNotUnique){if(G===""){return null;}if(K&&a1[0]&&a1[1]){return j.call(this,i,G,T,U,H,I,J,false);}if(H){return k.call(this,T,I,G,J);}}if(z.call(this)){return l.call(this,T,I,G,J);}throw new P(f1.message);};var c1=function(g1){if(g1){var a1=[g1.key];if(i.valueTypes.length>1&&i.valueTypes[1]!==O.ValueType.Static){a1.push(g1.description);}return C.createCondition(i.name,a1,g1.inParameters,g1.outParameters,d.Validated);}else if(G===""){return null;}else{return b1.call(this,new P(this._oResourceBundle.getText("valuehelp.VALUE_NOT_EXIST",[G])));}};var d1=this._oCalls.last;var e1=function(g1,h1){var i1;var j1;try{i1=h1.call(this,g1);}catch(f1){j1=f1;}return g.call(this,i1,j1,d1,false,T);};try{X=T.parseValue(W,"string");T.validateValue(X);}catch(f1){if(f1&&!(f1 instanceof P)&&!(f1 instanceof V)){throw f1;}N=false;Q=false;X=undefined;}return e.resolve().then(function(){return A.call(this,W,X,Y,Q,N,R,Z,$);}.bind(this)).then(function(g1){return e1.call(this,g1,c1);}.bind(this)).catch(function(f1){return e1.call(this,f1,b1);}.bind(this)).unwrap();}function k(T,i,G,H){var I=E.call(this,i,T);var J;if(I&&i.indexOf(I.name)>=0){J=I.getCondition(G,T,b.Value,true);J.validated=d.NotValidated;}return J;}function l(T,i,G,H){var I;if(i.length===1){I=c.getOperator(i[0]);}else{I=c.getEQOperator(i);if(i.indexOf(I.name)<0){I=undefined;}}if(!I){throw new P("Cannot parse value "+G);}var J=I.getCondition(G,T,b.Value,true);if(J){J.validated=d.NotValidated;}return J;}f.prototype.validateValue=function(i){var T=o.call(this);var G=p.call(this);var H=q.call(this);var I=this.oFormatOptions.isUnit;if(i===undefined||this._bDestroyed){return null;}else if(i===null){if(c.onlyEQ(H)){try{if(T.hasOwnProperty("_sParsedEmptyString")&&T._sParsedEmptyString!==null){T.validateValue(T._sParsedEmptyString);}else{T.validateValue(null);}}catch(J){if(J instanceof V){throw J;}else{return null;}}}return null;}if(typeof i!=="object"||!i.operator||!i.values||!Array.isArray(i.values)){throw new V(this._oResourceBundle.getText("field.VALUE_NOT_VALID"));}var K=c.getOperator(i.operator,H);if(I){i=m({},i);if(i.values[0]&&Array.isArray(i.values[0])){i.values[0]=i.values[0][1];}K=c.getEQOperator();}if(!K){throw new V("No valid condition provided, Operator wrong.");}try{K.validate(i.values,T);}catch(L){if(L instanceof V&&G){K.validate(i.values,G);}throw L;}};function n(){var i=this.oFormatOptions.display;if(!i){i=b.Value;}return i;}function o(){var T=this.oFormatOptions.valueType;if(!T){if(!this._oDefaultType){this._oDefaultType=new a();}T=this._oDefaultType;}return T;}function p(){return this.oFormatOptions.originalDateType;}function q(){var i=this.oFormatOptions.operators;if(!i||i.length===0){i=c.getOperatorsForType(B.String);}return i;}function r(){var i=this.oFormatOptions.fieldHelpID;if(i){var G=sap.ui.getCore().byId(i);if(G&&G.isUsableForValidation()){return G;}}return null;}function s(T){return T&&T.isA("sap.ui.model.CompositeType");}function t(i,T){if(s.call(this,T)&&i&&i.values[0]){T._aCurrentValue=i.values[0];}}function u(T){if(s.call(this,T)&&!T._aCurrentValue){T._aCurrentValue=[];}}function v(i,R){i.values=[R.key,R.description];if(R.inParameters){i.inParameters=R.inParameters;}if(R.outParameters){i.outParameters=R.outParameters;}return i;}function w(i){if(this.oFormatOptions.asyncParsing){this.oFormatOptions.asyncParsing(i);}return i;}function x(T){var i=T.getMetadata().getName();var G=T.getFormatOptions();var H=T.getConstraints();var I=this.oFormatOptions.delegate;var J=this.oFormatOptions.payload;var K=I?I.getTypeUtil(J).getBaseType(i,G,H):B.String;if(K===B.Unit){K=B.Numeric;}return K;}function y(){var i=r.call(this);var G=this.oFormatOptions.delegate;var H=this.oFormatOptions.payload;if(G){return G.isInputValidationEnabled(H,i);}else{return!!i;}}function z(){var i=r.call(this);var G=this.oFormatOptions.delegate;var H=this.oFormatOptions.payload;if(G){return G.isInvalidInputAllowed(H,i);}else if(i){return!i.getValidateInput();}else{return true;}}function A(i,G,H,I,J,K,L,M){var N=r.call(this);var Q=this.oFormatOptions.delegate;var R=this.oFormatOptions.payload;if(Q){return Q.getItemForValue(R,N,i,G,H,I,J,K,L,M);}else if(N){return N.getItemForValue(i,G,undefined,undefined,H,I,J,K,L,M);}}function D(K,i,G,H,I,J){var L=r.call(this);var M=this.oFormatOptions.delegate;var N=this.oFormatOptions.payload;if(M){return M.getDescription(N,L,K,i,G,H,I,J);}else if(L){return L.getTextForKey(K,i,G,H,I,J);}}function E(G,T){var H=this.oFormatOptions.defaultOperatorName;var I;if(H){I=c.getOperator(H);}else{I=c.getDefaultOperator(x.call(this,T));}if(I&&G.indexOf(I.name)<0){for(var i=0;i<G.length;i++){I=c.getOperator(G[i]);if(I.exclude||!I.hasRequiredValues()){I=undefined;}else{break;}}}return I;}return f;});
