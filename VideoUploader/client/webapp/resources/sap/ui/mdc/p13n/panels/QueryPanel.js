/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BasePanel","sap/ui/core/Item","sap/m/CustomListItem","sap/m/Select","sap/m/List","sap/m/HBox","sap/m/library","sap/m/Button"],function(B,I,C,S,L,H,l,a){"use strict";var Q=B.extend("sap.ui.mdc.p13n.panels.QueryPanel",{metadata:{library:"sap.ui.mdc"},renderer:{}});var b=l.ListType;var F=l.FlexJustifyContent;var c=l.ButtonType;Q.prototype.NONE_KEY="$_none";Q.prototype.init=function(){B.prototype.init.apply(this,arguments);this.setEnableReorder(true);this.addStyleClass("sapUiMDCP13nQueryPanel");};Q.prototype.setP13nModel=function(m){B.prototype.setP13nModel.apply(this,arguments);this._oListControl.removeAllItems();m.getProperty("/items").forEach(function(i){if(i[this._getPresenceAttribute()]){this._addQueryRow(i);}}.bind(this));this._addQueryRow();};Q.prototype._moveTableItem=function(i,n){this._oListControl.removeItem(i);this._oListControl.insertItem(i,n);this._updateEnableOfMoveButtons(i,false);this.fireChange({reason:"Move",item:this._getModelEntryForRow(i)});};Q.prototype._createInnerListControl=function(){return new L(this.getId()+"-innerP13nList",{itemPress:[this._onItemPressed,this],dragDropConfig:this._getDragDropConfig()});};Q.prototype._getModelEntryForRow=function(r){var k=r.getContent()[0].getItems()[0]._key;var f=this.getP13nModel().getProperty("/items").find(function(o){return o.name==k;});return f;};Q.prototype._getAvailableItems=function(){var s=this.getP13nModel().getProperty("/items");var d=[new I({key:this.NONE_KEY,text:this.getResourceText("sort.PERSONALIZATION_DIALOG_OPTION_NONE")})];s.forEach(function(n,i){d.push(new I({key:n.name,text:n.label,enabled:{path:this.P13N_MODEL+">/items/"+i+"/"+this._getPresenceAttribute(),formatter:function(q){return!q;}}}));}.bind(this));return d;};Q.prototype._getMoveDownButton=function(){var m=B.prototype._getMoveDownButton.apply(this,arguments);m.setIcon("sap-icon://navigation-down-arrow");return m;};Q.prototype._getMoveUpButton=function(){var m=B.prototype._getMoveUpButton.apply(this,arguments);m.setIcon("sap-icon://navigation-up-arrow");return m;};Q.prototype.getP13nState=function(){var i=[];this._oListControl.getItems().forEach(function(d){var k=d.getContent()[0].getItems()[0]._key;if(k){var f=this.getP13nModel().getProperty("/items").find(function(o){return o.name==k;});i.push(Object.assign({},f));}}.bind(this));return i;};Q.prototype._addQueryRow=function(i){i=i?i:{name:null,descending:null};var s=this._createKeySelect(i.name);var r=new C({type:b.Active,content:[new H({items:[s]})]});if(this.getEnableReorder()){this._addHover(r);}this._getAdditionalQueryRowContent(i).forEach(function(o){r.getContent()[0].addItem(o);});r.getContent()[0].getItems()[0]._key=i.name;this._oListControl.addItem(r);var d=!!i.name;var R=this._createRemoveButton(d);r.getContent()[0].addItem(R);return r;};Q.prototype._handleActivated=function(h){var q=h.getContent()[0];var i=q.getItems().length-1;var o=h.getContent()[0].getItems()[i];if(h&&o.getItems().length<2){o.insertItem(this._getMoveUpButton(),0);o.insertItem(this._getMoveDownButton(),1);this._updateEnableOfMoveButtons(h,false);}};Q.prototype._getAdditionalQueryRowContent=function(){return[];};Q.prototype._createKeySelect=function(k){var s=new S({items:this._getAvailableItems(),selectedKey:k,change:this._selectKey.bind(this)}).addStyleClass("sapUiSmallMarginEnd").addStyleClass("sapUiSmallMarginBegin");return s;};Q.prototype._selectKey=function(e){var o=e.getSource().getParent().getParent();var i=this._oListControl.getItems().length-1==this._oListControl.getItems().indexOf(o);var n=e.getParameter("selectedItem").getKey();var O=e.getSource()._key;var d=o.getContent()[0].getItems()[o.getContent()[0].getItems().length-1];d.setVisible(n!==this.NONE_KEY);if(O){this._updatePresence(O,false);}e.getSource()._key=n;this._updatePresence(n,true);if(n!==this.NONE_KEY&&i){this._addQueryRow();}};Q.prototype._createRemoveButton=function(v){var r=new H({justifyContent:F.End,width:"100%",visible:v,items:[new a({type:c.Transparent,icon:"sap-icon://decline",press:function(e){var R=e.getSource().getParent().getParent().getParent();this._oListControl.removeItem(R);this._updatePresence(R.getContent()[0].getItems()[0]._key,false);if(this._oListControl.getItems().length===0){this._addQueryRow();}}.bind(this)})]});return r;};Q.prototype._moveSelectedItem=function(){this._oSelectedItem=this._getMoveUpButton().getParent().getParent().getParent();B.prototype._moveSelectedItem.apply(this,arguments);};Q.prototype._updatePresence=function(k,A){var s=this.getP13nModel().getProperty("/items");var r=s.filter(function(i){return i.name===k;});if(r[0]){r[0][this._getPresenceAttribute()]=A;}this.getP13nModel().setProperty("/items",s);this.fireChange({reason:A?"Add":"Remove",item:r[0]});};return Q;});
