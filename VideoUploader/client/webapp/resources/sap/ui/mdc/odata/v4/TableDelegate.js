/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../util/loadModules","../../library","sap/m/ColumnPopoverSelectListItem","sap/ui/core/Item","sap/ui/core/Core","sap/ui/core/library","sap/m/MessageBox"],function(T,l,a,C,I,b,c,M){"use strict";var d=a.TableType;var f=new window.WeakMap();var D=Object.assign({},T);D.fetchPropertyHelper=function(t,p,e){return l("sap/ui/mdc/table/V4AnalyticsPropertyHelper").then(function(r){return r[0];});};D.fetchPropertyExtensions=function(t,p){return Promise.resolve(null);};D.fetchPropertiesForBinding=function(t){return this.fetchProperties(t);};D.fetchPropertyExtensionsForBinding=function(t,p){return this.fetchPropertyExtensions(t,p);};D.formatGroupHeader=function(t,o,p){};D.preInit=function(t){if(t._getStringType()===d.ResponsiveTable){return;}t.setShowRowCount(false);t.setShowRowCount=function(){return this;};return k(t);};D.addColumnMenuItems=function(t,m){var p=t.getPropertyHelper();var G=p.getGroupableProperties(m.getDataProperty());var A=p.getAggregatableProperties(m.getDataProperty());var r=b.getLibraryResourceBundle("sap.ui.mdc");var P=t._oPopover;P&&P.getItems().forEach(function(n,q,s){if(n.getLabel()===r.getText("table.SETTINGS_GROUP")||n.getLabel()===r.getText("table.SETTINGS_TOTALS")){s[q].destroy();}if(s.length==0){P.destroy();}});var o,e;if(t.isGroupingEnabled()&&G&&G.length>0){e=this._onGroup(G,m);}if(t.isAggregationEnabled()&&A&&A.length>0){o=this._onAggregate(A,m);}return[e,o];};D._onGroup=function(G,m){var o,e=[];var r=b.getLibraryResourceBundle("sap.ui.mdc");G.forEach(function(p){o=new I({text:p.getLabel(),key:p.getName()});e.push(o);});if(e.length>0){var n=new C({items:e,label:r.getText("table.SETTINGS_GROUP"),icon:"sap-icon://group-2",action:[{sName:"Group",oMDCColumn:m},this._checkForPreviousAnalytics,this]});return n;}};D._onAggregate=function(A,m){var o,e=[];var r=b.getLibraryResourceBundle("sap.ui.mdc");A.forEach(function(p){o=new I({text:p.getLabel(),key:p.getName()});e.push(o);});if(e.length>0){var n=new C({items:e,label:r.getText("table.SETTINGS_TOTALS"),icon:"sap-icon://sum",action:[{sName:"Aggregate",oMDCColumn:m},this._checkForPreviousAnalytics,this]});return n;}};D._checkForPreviousAnalytics=function(e,o){var n=o.sName,t,m,A,p=o.oMDCColumn,q=p.getParent(),G=q.getCurrentState().groupLevels||[],r=q.getCurrentState().aggregations||{},s=Object.keys(r),F=false,P=e.getParameter("property");var u=n=="Aggregate"?G:s;var v=u.filter(function(w){return n=="Aggregate"?w.name===P:w===P;}).length>0;if(v){var R=b.getLibraryResourceBundle("sap.ui.mdc");if(n==="Aggregate"){t=R.getText("table.SETTINGS_WARNING_TITLE_TOTALS");m=R.getText("table.SETTINGS_MESSAGE2");A=R.getText("table.SETTINGS_WARNING_BUTTON_TOTALS");}else{t=R.getText("table.SETTINGS_WARNING_TITLE_GROUPS");m=R.getText("table.SETTINGS_MESSAGE1");A=R.getText("table.SETTINGS_WARNING_BUTTON_GROUP");}F=true;M.warning(m,{id:q.getId()+"-messageBox",title:t,actions:[A,R.getText("table.SETTINGS_WARNING_BUTTON_CANCEL")],onClose:function(w){if(w===A){this._forceAnalytics(n,q,P);}b.byId(q.getId()+"-messageBox").destroy();}.bind(this)});}if(n==="Aggregate"&&!F){this._onAction(n,q,P);}else if(n==="Group"&&!F){this._onAction(n,q,P);}};D._onAction=function(A,t,p){if(A==="Group"){t._onCustomGroup(p);}else{t._onCustomAggregate(p);}};D._forceAnalytics=function(n,t,p){if(n==="Aggregate"){t._onCustomGroup(p);t._onCustomAggregate(p);}else if(n==="Group"){t._onCustomAggregate(p);t._onCustomGroup(p);}};D.updateBinding=function(t,B,o){var F=false;if(!o||o.hasPendingChanges()||o.getPath()!=B.path){F=true;}else{try{o.suspend();}catch(e){}try{o.changeParameters(B.parameters);o.filter(B.filters,"Application");o.sort(B.sorter);this._setAggregation(t);}catch(e){F=true;}try{!F&&o.resume();}catch(e){}}if(F){this._setAggregation(t);this.rebindTable(t,B);}};D._setAggregation=function(t,G,A){var m=f.get(t)||{};var p=m.plugin;if(p){G=G||t._getGroupedProperties();A=A||t._getAggregatedProperties();var e=Object.keys(A);var n=G.map(function(q){return q.name;});var o={visible:this._getVisibleProperties(t,p),groupLevels:n,grandTotal:e,subtotals:e,columnState:g(t,e)};p.setAggregationInfo(o);}};function g(t,A){var m={};t.getColumns().forEach(function(o){var s=o.getId()+"-innerColumn";var e=i(t,o,A);var n=e.length>0;if(s in m){m[s].subtotals=n||m[s].subtotals;m[s].grandTotal=n||m[s].grandTotal;return;}m[s]={subtotals:n,grandTotal:n};j(t,e).forEach(function(u){s=u.getId()+"-innerColumn";if(s in m){m[s].subtotals=n||m[s].subtotals;m[s].grandTotal=n||m[s].grandTotal;}else{m[s]={subtotals:n,grandTotal:n};}});});return m;}function h(t,o){var p=t.getPropertyHelper().getProperty(o.getDataProperty());if(!p){return[];}else if(p.isComplex()){return p.getReferencedProperties();}else{return[p];}}function i(t,o,A){return h(t,o).filter(function(p){return A.includes(p.name);});}function j(t,p){var u=[];p.forEach(function(P){var U=P?P.getUnitProperty():null;if(U){u.push(U);}});return t.getColumns().filter(function(o){return h(t,o).some(function(P){return u.includes(P);});});}D._getVisibleProperties=function(t,p){var v=[];var P=p.getPropertyInfos();t.getColumns().forEach(function(e){var s=e.getDataProperty(),o=P.find(function(m){return m.name===s;});if(o){if(o.propertyInfos){o.propertyInfos.forEach(function(r){if(v.indexOf(r)<0){v.push(r);}});}else if(v.indexOf(s)<0){v.push(s);}}});return v;};D.validateState=function(o,s){var e;if(!s.sorters){e=true;}else if(!s.items){e=false;}else{var p,P=[];s.items.forEach(function(m){p=o.getPropertyHelper().getProperty(m.name);if(!p.isComplex()){P.push(p.name);}else{p.getReferencedProperties().forEach(function(R){if(P.indexOf(R.name)===-1){P.push(R.name);}});}});e=s.sorters.every(function(S){return P.find(function(m){return S.name===m;});});}if(!e){var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");return{validation:c.MessageType.Warning,message:r.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")};}return{validation:c.MessageType.None};};function k(t){var p;var e;var P;var o=t.getControlDelegate();return Promise.all([t.awaitPropertyHelper(),l("sap/ui/table/plugins/V4Aggregation")]).then(function(r){var V=r[1][0],m=t._oTable;P=new V({groupHeaderFormatter:function(n,s){return o.formatGroupHeader(t,n,s);}});m.addDependent(P);f.set(t,{plugin:P});return o.fetchPropertiesForBinding(t);}).then(function(m){p=m;return o.fetchPropertyExtensionsForBinding(t,p);}).then(function(E){e=E;return o.fetchPropertyHelper(t,p,e);}).then(function(H){var m=new H(p,e,t);P.setPropertyInfos(m.getProperties());o._setAggregation(t,[],{});m.destroy();});}return D;});
