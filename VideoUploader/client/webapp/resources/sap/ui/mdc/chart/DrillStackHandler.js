/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Core","sap/m/ResponsivePopover","sap/m/List","sap/m/Bar","sap/m/SearchField","sap/m/StandardListItem","sap/ui/core/InvisibleText","sap/m/library","sap/ui/Device","sap/ui/mdc/chart/DimensionItem","sap/ui/mdc/chart/ChartSettings"],function(C,R,L,B,S,c,I,M,D,d,e){"use strict";var f;var P=M.PlacementType;var g=M.ListType;var h=M.ListMode;function _(o){var a=o.getAggregation("_chart").getDrillStack();var s=[];a.forEach(function(b){b.dimension.forEach(function(i){if(i!=null&&i!=""&&s.indexOf(i)==-1){s.push(i);}});});return s;}function j(p){var i=p.filter(function(o){return o.kind=="Dimension";});if(i){i.sort(function(a,b){if(a.label&&b.label){return a.label.localeCompare(b.label);}});}return i;}var k=function(){};k.createDrillDownPopover=function(o){var l=new L({mode:h.SingleSelectMaster,selectionChange:function(a){var b=a.getParameter("listItem");if(b){o.getEngine().createChanges({control:o,key:"Item",state:[{name:b.data("dim").name,position:o.getItems().length}]});}p.close();}});var s=new B();var p=new R({contentWidth:"25rem",contentHeight:"20rem",placement:P.Bottom,subHeader:s});var r=C.getLibraryResourceBundle("sap.ui.mdc");if(D.system.desktop){var i=new I({text:r.getText("chart.CHART_DRILLDOWN_TITLE")});p.setShowHeader(false);p.addContent(i);p.addAriaLabelledBy(i);}else{p.setTitle(r.getText("chart.CHART_DRILLDOWN_TITLE"));}p.addContent(l);o._oDrillDownPopover=p;return p;};k.showDrillDownPopover=function(o){var F=o.getControlDelegate().fetchProperties(o);return F.then(function(p){var a=o._oDrillDownPopover;var b=a.getContent()[1];var l,s,m,n;b.destroyItems();l=_(o);s=j(p);for(var i=0;i<s.length;i++){m=s[i];if(l.indexOf(m.name)>-1){continue;}n=new c({title:m.label,type:g.Active});n.data("dim",m);b.addItem(n);}return new Promise(function(r,q){a.attachEventOnce("afterOpen",function u(t){r(a);});a.openBy(o._oDrillDownBtn);});});};k.createDrillBreadcrumbs=function(o){return new Promise(function(r,a){sap.ui.require(["sap/m/Breadcrumbs"],function(b){var i=o.getAggregation("_chart");if(i){var l=new b();o.setAggregation("_breadcrumbs",l);this._updateDrillBreadcrumbs(o,l).then(function(){r(l);});}}.bind(this));}.bind(this));};k.createCrumb=function(o,a){var i=o.getAggregation("_chart");var b=new f({text:a.dimensionText,press:function s(l){var m=o.getAggregation("_breadcrumbs"),n=m.indexOfLink(l.getSource());var p=i.getDrillStack()[i.getDrillStack().length-1].dimension,q=p.slice(n+1);i.fireDeselectData();var r=o.getItemsByKeys(q);var F=r.map(function(t){return{name:t.getKey(),visible:false};});o.getEngine().createChanges({control:o,key:"Item",state:F});this._updateDrillBreadcrumbs(o,m);}.bind(this)});b.data("key",a.dimensionKey);return b;};k._updateDrillBreadcrumbs=function(o,a){return new Promise(function(r,b){sap.ui.require(["sap/m/Link"],function(l){f=l;if(!a){return;}var m=o.getAggregation("_chart");if(!m){return;}var v=m.getDrillStack();var n=[];if(v){v.reverse();v.forEach(function(s,t,u){if(s.dimension.length>0&&typeof m.getDimensionByName(s.dimension[s.dimension.length-1])!='undefined'){a.setVisible(true);var w=m.getDimensionByName(s.dimension[s.dimension.length-1]).getLabel();var x=m.getDimensionByName(s.dimension[s.dimension.length-1]).getName();if(t==0){a.setCurrentLocationText(w);}else{var y={dimensionKey:x,dimensionText:w};var z=this.createCrumb(o,y);n.push(z);}}else{if(t==0){a.setVisible(false);}}},this);}var p=a.getLinks();n.reverse();var q=false;if(p.length!==n.length){q=true;}else{for(var i=0;i<n.length;i++){if(n[i].getText()!=p[i].getText()){q=true;break;}}}if(q){if(a.getLinks()){a.destroyLinks();}for(var i=0;i<n.length;i++){a.addLink(n[i]);}}r(a);}.bind(this));}.bind(this));};return k;});
