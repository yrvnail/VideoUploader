/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/assert","sap/base/Log","sap/base/util/includes","sap/base/util/isEmptyObject",'sap/ui/model/ChangeReason','sap/ui/model/Context','sap/ui/model/Filter','sap/ui/model/FilterProcessor','sap/ui/model/FilterType','sap/ui/model/Sorter','sap/ui/model/SorterProcessor','sap/ui/model/TreeBinding','sap/ui/model/TreeBindingUtils','sap/ui/model/odata/CountMode','sap/ui/model/odata/ODataUtils','sap/ui/model/odata/OperationMode',"sap/ui/thirdparty/jquery"],function(a,L,b,c,C,d,F,e,f,S,g,T,h,l,O,m,q){"use strict";var n=T.extend("sap.ui.model.odata.v2.ODataTreeBinding",{constructor:function(M,p,o,v,P,s){T.apply(this,arguments);this.mParameters=this.mParameters||P||{};this.sGroupId;this.sRefreshGroupId;this.oFinalLengths={};this.oLengths={};this.oKeys={};this.bNeedsUpdate=false;this._bRootMissing=false;this.bSkipDataEvents=false;if(s instanceof S){s=[s];}this.aSorters=s||[];this.sFilterParams="";this.mNormalizeCache={};if(v instanceof F){v=[v];}this.aApplicationFilters=v;this.oModel.checkFilterOperation(this.aApplicationFilters);this.mRequestHandles={};this.oRootContext=null;this.iNumberOfExpandedLevels=(P&&P.numberOfExpandedLevels)||0;this.iRootLevel=(P&&P.rootLevel)||0;this.sCountMode=(P&&P.countMode)||this.oModel.sDefaultCountMode;if(this.sCountMode==l.None){L.fatal("To use an ODataTreeBinding at least one CountMode must be supported by the service!");}if(P){this.sGroupId=P.groupId||P.batchGroupId;}this.bInitial=true;this._mLoadedSections={};this._iPageSize=0;this.sOperationMode=(P&&P.operationMode)||this.oModel.sDefaultOperationMode;if(this.sOperationMode===m.Default){this.sOperationMode=m.Server;}this.bClientOperation=false;switch(this.sOperationMode){case m.Server:this.bClientOperation=false;break;case m.Client:this.bClientOperation=true;break;case m.Auto:this.bClientOperation=false;break;}this.iThreshold=(P&&P.threshold)||0;this.bThresholdRejected=false;this.iTotalCollectionCount=null;this.bUseServersideApplicationFilters=(P&&P.useServersideApplicationFilters)||false;this.bUsePreliminaryContext=this.mParameters.usePreliminaryContext||M.bPreliminaryContext;this.oAllKeys=null;this.oAllLengths=null;this.oAllFinalLengths=null;}});n.DRILLSTATES={Collapsed:"collapsed",Expanded:"expanded",Leaf:"leaf"};n.prototype._getNodeFilterParams=function(p){var P=p.isRoot?this.oTreeProperties["hierarchy-node-for"]:this.oTreeProperties["hierarchy-parent-node-for"];var E=this._getEntityType();return O._createFilterParams(new F(P,"EQ",p.id),this.oModel.oMetadata,E);};n.prototype._getLevelFilterParams=function(o,i){var E=this._getEntityType();return O._createFilterParams(new F(this.oTreeProperties["hierarchy-level-for"],o,i),this.oModel.oMetadata,E);};n.prototype._loadSingleRootNodeByNavigationProperties=function(N,r){var t=this,G;if(this.mRequestHandles[r]){this.mRequestHandles[r].abort();}G=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;var A=this.getResolvedPath();if(A){this.mRequestHandles[r]=this.oModel.read(A,{groupId:G,success:function(D){var s=t._getNavPath(t.getPath());if(D){var E=D;var k=t.oModel._getKey(E);var o=t.oModel.getContext('/'+k);t.oRootContext=o;t._processODataObject(o.getObject(),N,s);}else{t._bRootMissing=true;}t.bNeedsUpdate=true;delete t.mRequestHandles[r];t.oModel.callAfterUpdate(function(){t.fireDataReceived({data:D});});},error:function(E){if(E&&E.statusCode!=0&&E.statusText!="abort"){t.bNeedsUpdate=true;t._bRootMissing=true;delete t.mRequestHandles[r];t.fireDataReceived();}}});}};n.prototype.getRootContexts=function(s,i,t){var N=null,r={numberOfExpandedLevels:this.iNumberOfExpandedLevels},R=[];if(this.isInitial()){return R;}s=s||0;i=i||this.oModel.sizeLimit;t=t||0;var j=""+N+"-"+s+"-"+this._iPageSize+"-"+t;if(this.bHasTreeAnnotations){this.bDisplayRootNode=true;R=this._getContextsForNodeId(null,s,i,t);}else{N=this.getResolvedPath();var I=this.oModel.isList(this.sPath,this.getContext());if(I){this.bDisplayRootNode=true;}if(this.bDisplayRootNode&&!I){if(this.oRootContext){return[this.oRootContext];}else if(this._bRootMissing){return[];}else{this._loadSingleRootNodeByNavigationProperties(N,j);}}else{r.navPath=this._getNavPath(this.getPath());if(!this.bDisplayRootNode){N+="/"+r.navPath;}R=this._getContextsForNodeId(N,s,i,t,r);}}return R;};n.prototype.getNodeContexts=function(o,s,i,t){var N,r={};if(this.isInitial()){return[];}if(this.bHasTreeAnnotations){N=this.oModel.getKey(o);r.level=parseInt(o.getProperty(this.oTreeProperties["hierarchy-level-for"]))+1;}else{var j=this._getNavPath(o.getPath());if(!j){return[];}N=this.oModel.resolve(j,o);r.navPath=this.oNavigationPaths[j];}return this._getContextsForNodeId(N,s,i,t,r);};n.prototype.hasChildren=function(o){if(this.bHasTreeAnnotations){if(!o){return false;}var D=o.getProperty(this.oTreeProperties["hierarchy-drill-state-for"]);var N=this.oModel.getKey(o);var i=this.oLengths[N];if(i===0&&this.oFinalLengths[N]){return false;}if(D==="expanded"||D==="collapsed"){return true;}else if(D==="leaf"){return false;}else{L.warning("The entity '"+o.getPath()+"' has not specified Drilldown State property value.");if(D===undefined||D===""){return true;}return false;}}else{if(!o){return this.oLengths[this.getPath()]>0;}var i=this.oLengths[o.getPath()+"/"+this._getNavPath(o.getPath())];return i!==0;}};n.prototype.getChildCount=function(o){if(this.bHasTreeAnnotations){var H;if(!o){H=null;}else{H=this.oModel.getKey(o);}return this.oLengths[H];}else{if(!o){if(!this.bDisplayRootNode){return this.oLengths[this.getPath()+"/"+this._getNavPath(this.getPath())];}else{return this.oLengths[this.getPath()];}}return this.oLengths[o.getPath()+"/"+this._getNavPath(o.getPath())];}};n.prototype._getContextsForNodeId=function(N,s,j,t,r){var k=[],K;if(this.sOperationMode==m.Auto){if(this.iTotalCollectionCount==null){if(!this.bCollectionCountRequested){this._getCountForCollection();this.bCollectionCountRequested=true;}return[];}}s=s||0;j=j||this.oModel.iSizeLimit;t=t||0;if(this.sOperationMode==m.Auto){if(this.iThreshold>=0){t=Math.max(this.iThreshold,t);}}if(!this._mLoadedSections[N]){this._mLoadedSections[N]=[];}if(this.oFinalLengths[N]&&this.oLengths[N]<s+j){j=Math.max(this.oLengths[N]-s,0);}var o=this;var p=function(s){for(var i=0;i<o._mLoadedSections[N].length;i++){var J=o._mLoadedSections[N][i];if(s>=J.startIndex&&s<J.startIndex+J.length){return true;}}};var M=[];var i=Math.max((s-t-this._iPageSize),0);if(this.oKeys[N]){var u=s+j+(t);if(this.oLengths[N]){u=Math.min(u,this.oLengths[N]);}for(i;i<u;i++){K=this.oKeys[N][i];if(!K){if(!this.bClientOperation&&!p(i)){M=h.mergeSections(M,{startIndex:i,length:1});}}if(i>=s&&i<s+j){if(K){k.push(this.oModel.getContext('/'+K));}else{k.push(undefined);}}}var B=Math.max((s-t-this._iPageSize),0);var E=s+j+(t);var v=M[0]&&M[0].startIndex===B&&M[0].startIndex+M[0].length===E;if(M.length>0&&!v){i=Math.max((M[0].startIndex-t-this._iPageSize),0);var w=M[0].startIndex;for(i;i<w;i++){var K=this.oKeys[N][i];if(!K){if(!p(i)){M=h.mergeSections(M,{startIndex:i,length:1});}}}i=M[M.length-1].startIndex+M[M.length-1].length;var x=i+t+this._iPageSize;if(this.oLengths[N]){x=Math.min(x,this.oLengths[N]);}for(i;i<x;i++){var K=this.oKeys[N][i];if(!K){if(!p(i)){M=h.mergeSections(M,{startIndex:i,length:1});}}}}}else{if(!p(s)){var y=s-i;M=h.mergeSections(M,{startIndex:i,length:j+y+t});}}if(this.oModel.getServiceMetadata()){if(M.length>0){var P=[];var z="";if(this.bHasTreeAnnotations){if(this.sOperationMode=="Server"||this.bUseServersideApplicationFilters){z=this.getFilterParams();}if(N){z=z?"%20and%20"+z:"";var A=this.oModel.getContext("/"+N);var D=A.getProperty(this.oTreeProperties["hierarchy-node-for"]);var G=this._getNodeFilterParams({id:D});P.push("$filter="+G+z);}else if(N==null){var H="";if(!this.bClientOperation||this.iRootLevel>0){var I=this.bClientOperation?"GE":"EQ";H=this._getLevelFilterParams(I,this.iRootLevel);}if(H||z){if(z&&H){z="%20and%20"+z;}P.push("$filter="+H+z);}}}else{z=this.getFilterParams();if(z){P.push("$filter="+z);}}if(this.sCustomParams){P.push(this.sCustomParams);}if(!this.bClientOperation){for(i=0;i<M.length;i++){var R=M[i];this._mLoadedSections[N]=h.mergeSections(this._mLoadedSections[N],{startIndex:R.startIndex,length:R.length});this._loadSubNodes(N,R.startIndex,R.length,0,P,r,R);}}else{if(!this.oAllKeys&&!this.mRequestHandles[n.REQUEST_KEY_CLIENT]){this._loadCompleteTreeWithAnnotations(P);}}}}return k;};n.prototype._getCountForCollection=function(){if(!this.bHasTreeAnnotations||this.sOperationMode!=m.Auto){L.error("The Count for the collection can only be retrieved with Hierarchy Annotations and in OperationMode.Auto.");return;}var p=[];function _(D){var o=D.__count?parseInt(D.__count):parseInt(D);this.iTotalCollectionCount=o;if(this.sOperationMode==m.Auto){if(this.iTotalCollectionCount<=this.iThreshold){this.bClientOperation=true;this.bThresholdRejected=false;}else{this.bClientOperation=false;this.bThresholdRejected=true;}this._fireChange({reason:C.Change});}}function i(E){if(E&&E.statusCode===0&&E.statusText==="abort"){return;}var o="Request for $count failed: "+E.message;if(E.response){o+=", "+E.response.statusCode+", "+E.response.statusText+", "+E.response.body;}L.warning(o);}var A=this.getResolvedPath();var s="";if(this.iRootLevel>0){s=this._getLevelFilterParams("GE",this.getRootLevel());}var j="";if(this.bUseServersideApplicationFilters){var j=this.getFilterParams();}if(s||j){if(j&&s){j="%20and%20"+j;}p.push("$filter="+s+j);}var k="";if(this.sCountMode==l.Request||this.sCountMode==l.Both){k="/$count";}else if(this.sCountMode==l.Inline||this.sCountMode==l.InlineRepeat){p.push("$top=0");p.push("$inlinecount=allpages");}if(A){this.oModel.read(A+k,{urlParameters:p,success:_.bind(this),error:i.bind(this),groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});}};n.prototype._getCountForNodeId=function(N,s,i,t,p){var j=this,G;var P=[];function _(D){j.oFinalLengths[N]=true;j.oLengths[N]=parseInt(D);}function k(E){if(E&&E.statusCode===0&&E.statusText==="abort"){return;}var w="Request for $count failed: "+E.message;if(E.response){w+=", "+E.response.statusCode+", "+E.response.statusText+", "+E.response.body;}L.warning(w);}var A;var o=this.getFilterParams()||"";var r="";if(this.bHasTreeAnnotations){var u=this.oModel.getContext("/"+N);var H=u.getProperty(this.oTreeProperties["hierarchy-node-for"]);A=this.getResolvedPath();if(N!=null){r=this._getNodeFilterParams({id:H});}else{r=this._getLevelFilterParams("EQ",this.getRootLevel());}}else{A=N;}if(r||o){var v="";if(r&&o){v="%20and%20";}o="$filter="+o+v+r;P.push(o);}if(A){G=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.oModel.read(A+"/$count",{urlParameters:P,success:_,error:k,sorters:this.aSorters,groupId:G});}};n.prototype._getParentMap=function(D){var p={};for(var i=0;i<D.length;i++){var I=D[i][this.oTreeProperties["hierarchy-node-for"]];if(p[I]){L.warning("ODataTreeBinding: Duplicate key: "+I+"!");}p[I]=this.oModel._getKey(D[i]);}return p;};n.prototype._createKeyMap=function(D,s){if(D&&D.length>0){var p=this._getParentMap(D),k={};for(var i=s?1:0;i<D.length;i++){var P=D[i][this.oTreeProperties["hierarchy-parent-node-for"]],j=p[P];if(parseInt(D[i][this.oTreeProperties["hierarchy-level-for"]])===this.iRootLevel){j="null";}if(!k[j]){k[j]=[];}k[j].push(this.oModel._getKey(D[i]));}return k;}};n.prototype._importCompleteKeysHierarchy=function(k){var i,K;for(K in k){i=k[K].length||0;this.oKeys[K]=k[K];this.oLengths[K]=i;this.oFinalLengths[K]=true;this._mLoadedSections[K]=[{startIndex:0,length:i}];}};n.prototype._updateNodeKey=function(N,s){var o=this.oModel.getKey(N.context),p,i;if(parseInt(N.context.getProperty(this.oTreeProperties["hierarchy-level-for"]))===this.iRootLevel){p="null";}else{p=this.oModel.getKey(N.parent.context);}i=this.oKeys[p].indexOf(o);if(i!==-1){this.oKeys[p][i]=s;}else{this.oKeys[p].push(s);}};n.prototype._loadSubTree=function(N,p){return new Promise(function(r,i){var R,G,A;if(!this.bHasTreeAnnotations){i(new Error("_loadSubTree: doesn't support hierarchies without tree annotations"));return;}R="loadSubTree-"+p.join("-");if(this.mRequestHandles[R]){this.mRequestHandles[R].abort();}var s=function(D){if(D.results.length>0){var P=this.oModel.getKey(D.results[0]);this._updateNodeKey(N,P);var k=this._createKeyMap(D.results);this._importCompleteKeysHierarchy(k);}delete this.mRequestHandles[R];this.bNeedsUpdate=true;this.oModel.callAfterUpdate(function(){this.fireDataReceived({data:D});}.bind(this));r(D);}.bind(this);var E=function(o){delete this.mRequestHandles[R];if(o&&o.statusCode===0&&o.statusText==="abort"){return;}this.fireDataReceived();i();}.bind(this);if(!this.bSkipDataEvents){this.fireDataRequested();}this.bSkipDataEvents=false;A=this.getResolvedPath();if(A){G=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.mRequestHandles[R]=this.oModel.read(A,{urlParameters:p,success:s,error:E,sorters:this.aSorters,groupId:G});}}.bind(this));};n.prototype._loadSubNodes=function(N,s,j,t,p,P,r){var k=this,G,I=false;if((s||j)&&!this.bClientOperation){p.push("$skip="+s+"&$top="+(j+t));}if(!this.oFinalLengths[N]||this.sCountMode==l.InlineRepeat){if(this.sCountMode==l.Inline||this.sCountMode==l.InlineRepeat||this.sCountMode==l.Both){p.push("$inlinecount=allpages");I=true;}else if(this.sCountMode==l.Request){k._getCountForNodeId(N);}}var R=""+N+"-"+s+"-"+this._iPageSize+"-"+t;function o(D){if(D){k.oKeys[N]=k.oKeys[N]||[];if(I&&D.__count>=0){k.oLengths[N]=parseInt(D.__count);k.oFinalLengths[N]=true;}}if(Array.isArray(D.results)&&D.results.length>0){if(k.bHasTreeAnnotations){var u={};for(var i=0;i<D.results.length;i++){var v=D.results[i];if(i==0){u[N]=s;}else if(u[N]==undefined){u[N]=0;}k.oKeys[N][u[N]]=k.oModel._getKey(v);u[N]++;}}else{for(var i=0;i<D.results.length;i++){var v=D.results[i];var K=k.oModel._getKey(v);k._processODataObject(v,"/"+K,P.navPath);k.oKeys[N][i+s]=K;}}}else if(D&&!Array.isArray(D.results)){k.oKeys[null]=k.oModel._getKey(D);if(!k.bHasTreeAnnotations){k._processODataObject(D,N,P.navPath);}}delete k.mRequestHandles[R];k.bNeedsUpdate=true;k.oModel.callAfterUpdate(function(){k.fireDataReceived({data:D});});}function E(u){if(u&&u.statusCode===0&&u.statusText==="abort"){return;}k.fireDataReceived();delete k.mRequestHandles[R];if(r){var v=[];for(var i=0;i<k._mLoadedSections[N].length;i++){var w=k._mLoadedSections[N][i];if(r.startIndex>=w.startIndex&&r.startIndex+r.length<=w.startIndex+w.length){if(r.startIndex!==w.startIndex&&r.length!==w.length){v=h.mergeSections(v,{startIndex:w.startIndex,length:r.startIndex-w.startIndex});v=h.mergeSections(v,{startIndex:r.startIndex+r.length,length:(w.startIndex+w.length)-(r.startIndex+r.length)});}}else{v.push(w);}}k._mLoadedSections[N]=v;}}if(N!==undefined){if(!this.bSkipDataEvents){this.fireDataRequested();}this.bSkipDataEvents=false;var A;if(this.bHasTreeAnnotations){A=this.getResolvedPath();}else{A=N;}if(this.mRequestHandles[R]){this.mRequestHandles[R].abort();}if(A){G=this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId;this.mRequestHandles[R]=this.oModel.read(A,{urlParameters:p,success:o,error:E,sorters:this.aSorters,groupId:G});}}};n.REQUEST_KEY_CLIENT="_OPERATIONMODE_CLIENT_TREE_LOADING";n.prototype._loadCompleteTreeWithAnnotations=function(u){var t=this;var r=n.REQUEST_KEY_CLIENT;var s=function(D){if(D.results&&D.results.length>0){var p={};var o;for(var k=0;k<D.results.length;k++){o=D.results[k];var j=o[t.oTreeProperties["hierarchy-node-for"]];if(p[j]){L.warning("ODataTreeBinding - Duplicate data entry for key: "+j+"!");}p[j]=t.oModel._getKey(o);}for(var i=0;i<D.results.length;i++){o=D.results[i];var P=o[t.oTreeProperties["hierarchy-parent-node-for"]];var v=p[P];if(parseInt(o[t.oTreeProperties["hierarchy-level-for"]])===t.iRootLevel){v="null";}t.oKeys[v]=t.oKeys[v]||[];var K=t.oModel._getKey(o);t.oKeys[v].push(K);t.oLengths[v]=t.oLengths[v]||0;t.oLengths[v]++;t.oFinalLengths[v]=true;t._mLoadedSections[v]=t._mLoadedSections[v]||[];t._mLoadedSections[v][0]=t._mLoadedSections[v][0]||{startIndex:0,length:0};t._mLoadedSections[v][0].length++;}}else{t.oKeys["null"]=[];t.oLengths["null"]=0;t.oFinalLengths["null"]=true;}t.oAllKeys=q.extend(true,{},t.oKeys);t.oAllLengths=q.extend(true,{},t.oLengths);t.oAllFinalLengths=q.extend(true,{},t.oFinalLengths);delete t.mRequestHandles[r];t.bNeedsUpdate=true;if((t.aApplicationFilters&&t.aApplicationFilters.length>0)||(t.aFilters&&t.aFilters.length>0)){t._applyFilter();}if(t.aSorters&&t.aSorters.length>0){t._applySort();}t.oModel.callAfterUpdate(function(){t.fireDataReceived({data:D});});};var E=function(o){delete t.mRequestHandles[r];var i=o.statusCode==0;if(!i){t.oKeys={};t.oLengths={};t.oFinalLengths={};t.oAllKeys={};t.oAllLengths={};t.oAllFinalLengths={};t._fireChange({reason:C.Change});t.fireDataReceived();}};if(!this.bSkipDataEvents){this.fireDataRequested();}this.bSkipDataEvents=false;if(this.mRequestHandles[r]){this.mRequestHandles[r].abort();}var A=this.getResolvedPath();if(A){this.mRequestHandles[r]=this.oModel.read(A,{urlParameters:u,success:s,error:E,sorters:this.aSorters,groupId:this.sRefreshGroupId?this.sRefreshGroupId:this.sGroupId});}};n.prototype.resetData=function(v){var o,D=false;if(typeof v==="boolean"){D=v;}else{o=v;}if(o){var p=o.getPath();delete this.oKeys[p];delete this.oLengths[p];delete this.oFinalLengths[p];delete this._mLoadedSections[p];}else{this.oKeys={};this.bClientOperation=false;switch(this.sOperationMode){case m.Server:this.bClientOperation=false;break;case m.Client:this.bClientOperation=true;break;case m.Auto:this.bClientOperation=false;break;}this.bThresholdRejected=false;this.iTotalCollectionCount=null;this.bCollectionCountRequested=false;this.oAllKeys=null;this.oAllLengths=null;this.oAllFinalLengths=null;this.oLengths={};this.oFinalLengths={};this.oRootContext=null;this._bRootMissing=false;if(!D){this._abortPendingRequest();}this._mLoadedSections={};this._iPageSize=0;this.sFilterParams="";}};n.prototype.refresh=function(i,G){if(typeof i==="string"){G=i;}this.sRefreshGroupId=G;this._refresh(i);this.sRefreshGroupId=undefined;};n.prototype._refresh=function(i,j,E){var k=false;if(!i){if(E){var r=this.getResolvedPath();if(r){if(r.indexOf("?")!==-1){r=r.split("?")[0];}var o=this.oModel.oMetadata._getEntityTypeByPath(r);if(o&&(o.entityType in E)){k=true;}}}if(j&&!k){k=this._hasChangedEntity(j);}if(!j&&!E){k=true;}}if(i||k){this.resetData();this.bNeedsUpdate=false;this.bRefresh=true;this._fireRefresh({reason:C.Refresh});}};n.prototype._hasChangedEntity=function(i){var s,N;for(N in this.oKeys){for(s in i){if(b(this.oKeys[N],s)){return true;}}}return false;};n.prototype.filter=function(i,s,r){var j=false;s=s||f.Control;this.oModel.checkFilterOperation(i);if(s==f.Control&&(!this.bClientOperation||this.sOperationMode==m.Server)){L.warning("Filtering with ControlFilters is ONLY possible if the ODataTreeBinding is running in OperationMode.Client or "+"OperationMode.Auto, in case the given threshold is lower than the total number of tree nodes.");return;}if(!i){i=[];}if(i instanceof F){i=[i];}if(s===f.Control){this.aFilters=i;}else{this.aApplicationFilters=i;}if(!this.bInitial){if(this.bClientOperation&&(s===f.Control||(s===f.Application&&!this.bUseServersideApplicationFilters))){if(this.oAllKeys){this.oKeys=q.extend(true,{},this.oAllKeys);this.oLengths=q.extend(true,{},this.oAllLengths);this.oFinalLengths=q.extend(true,{},this.oAllFinalLengths);this._applyFilter();this._applySort();this._fireChange({reason:C.Filter});}else{this.sChangeReason=C.Filter;}}else{this.resetData();this.sChangeReason=C.Filter;this._fireRefresh({reason:this.sChangeReason});}j=true;}if(r){return j;}else{return this;}};n.prototype._applyFilter=function(){var t=this;var o;if(this.bUseServersideApplicationFilters){o=e.groupFilters(this.aFilters);}else{o=e.combineFilters(this.aFilters,this.aApplicationFilters);}var i=function(k){var p=e.apply([k],o,function(r,P){var s=t.oModel.getContext('/'+r);return t.oModel.getProperty(P,s);},t.mNormalizeCache);return p.length>0;};var j={};this._filterRecursive({id:"null"},j,i);this.oKeys=j;if(!this.oKeys["null"]){L.warning("Clientside filter did not match on any node!");}else{this.oLengths["null"]=this.oKeys["null"].length;this.oFinalLengths["null"]=true;}};n.prototype._filterRecursive=function(N,k,j){var o=this.oKeys[N.id];if(o){N.children=N.children||[];for(var i=0;i<o.length;i++){var p=this._filterRecursive({id:o[i]},k,j);if(p.isFiltered){k[N.id]=k[N.id]||[];k[N.id].push(p.id);N.children.push(p);}}if(N.children.length>0){N.isFiltered=true;}else{N.isFiltered=j(N.id);}if(N.isFiltered){this.oLengths[N.id]=N.children.length;this.oFinalLengths[N.id]=true;}return N;}else{N.isFiltered=j(N.id);return N;}};n.prototype.sort=function(s,r){var i=false;if(s instanceof S){s=[s];}this.aSorters=s||[];if(!this.bInitial){this._abortPendingRequest();if(this.bClientOperation){this.addSortComparators(s,this.oEntityType);if(this.oAllKeys){this._applySort();this._fireChange({reason:C.Sort});}else{this.sChangeReason=C.Sort;}}else{this.resetData(undefined,{reason:C.Sort});this.sChangeReason=C.Sort;this._fireRefresh({reason:this.sChangeReason});}i=true;}if(r){return i;}else{return this;}};n.prototype.addSortComparators=function(s,E){var p,t;if(!E){L.warning("Cannot determine sort comparators, as entitytype of the collection is unkown!");return;}q.each(s,function(i,o){if(!o.fnCompare){p=this.oModel.oMetadata._getPropertyMetadata(E,o.sPath);t=p&&p.type;a(p,"PropertyType for property "+o.sPath+" of EntityType "+E.name+" not found!");o.fnCompare=O.getComparator(t);}}.bind(this));};n.prototype._applySort=function(){var t=this,o;var G=function(k,p){o=t.oModel.getContext('/'+k);return t.oModel.getProperty(p,o);};for(var N in this.oKeys){g.apply(this.oKeys[N],this.aSorters,G);}};n.prototype.checkUpdate=function(j,k){var s=this.sChangeReason?this.sChangeReason:C.Change;var o=false;if(!j){if(this.bNeedsUpdate||!k){o=true;}else{q.each(this.oKeys,function(i,N){q.each(N,function(i,K){if(K in k){o=true;return false;}});if(o){return false;}});}}if(j||o){this.bNeedsUpdate=false;this._fireChange({reason:s});}this.sChangeReason=undefined;};n.prototype._getNavPath=function(p){var A=this.oModel.resolve(p,this.getContext());if(!A){return;}var P=A.split("/"),E=P[P.length-1],N;var s=E.split("(")[0];if(s&&this.oNavigationPaths[s]){N=this.oNavigationPaths[s];}return N;};n.prototype._processODataObject=function(o,p,N){var i=[],t=this;if(N&&N.indexOf("/")>-1){i=N.split("/");N=i[0];i.splice(0,1);}var r=this.oModel._getObject(p);if(Array.isArray(r)){this.oKeys[p]=r;this.oLengths[p]=r.length;this.oFinalLengths[p]=true;}else if(r){this.oLengths[p]=1;this.oFinalLengths[p]=true;}if(N&&o[N]){if(Array.isArray(r)){r.forEach(function(R){var o=t.getModel().getData("/"+R);t._processODataObject(o,"/"+R+"/"+N,i.join("/"));});}else if(typeof r==="object"){t._processODataObject(o,p+"/"+N,i.join("/"));}}};n.prototype._hasTreeAnnotations=function(){var M=this.oModel.oMetadata,A=this.getResolvedPath(),E,t=M.mNamespaces["sap"],i=this;this.oTreeProperties={"hierarchy-level-for":false,"hierarchy-parent-node-for":false,"hierarchy-node-for":false,"hierarchy-drill-state-for":false};var s=function(){var j=0;var k=0;q.each(i.oTreeProperties,function(p,P){k++;if(P){j+=1;}});if(j===k){return true;}else if(j>0&&j<k){L.warning("Incomplete hierarchy tree annotations. Please check your service metadata definition!");}return false;};if(this.mParameters&&this.mParameters.treeAnnotationProperties){this.oTreeProperties["hierarchy-level-for"]=this.mParameters.treeAnnotationProperties.hierarchyLevelFor;this.oTreeProperties["hierarchy-parent-node-for"]=this.mParameters.treeAnnotationProperties.hierarchyParentNodeFor;this.oTreeProperties["hierarchy-node-for"]=this.mParameters.treeAnnotationProperties.hierarchyNodeFor;this.oTreeProperties["hierarchy-drill-state-for"]=this.mParameters.treeAnnotationProperties.hierarchyDrillStateFor;return s();}if(A.indexOf("?")!==-1){A=A.split("?")[0];}E=M._getEntityTypeByPath(A);if(!E){L.fatal("EntityType for path "+A+" could not be found.");return false;}q.each(E.property,function(I,p){if(!p.extensions){return true;}q.each(p.extensions,function(I,o){var N=o.name;if(o.namespace===t&&N in i.oTreeProperties&&!i.oTreeProperties[N]){i.oTreeProperties[N]=p.name;}});});return s();};n.prototype.initialize=function(){if(this.oModel.oMetadata&&this.oModel.oMetadata.isLoaded()&&this.bInitial){var i=this.isRelative();if(!i||(i&&this.oContext)){this._initialize();}this._fireRefresh({reason:C.Refresh});}return this;};n.prototype._initialize=function(){this.bInitial=false;this.bHasTreeAnnotations=this._hasTreeAnnotations();this.oEntityType=this._getEntityType();this._processSelectParameters();this._applyAdapter();return this;};n.prototype.setContext=function(o){if(o&&o.isPreliminary()&&!this.bUsePreliminaryContext){return;}if(o&&o.isUpdated()&&this.bUsePreliminaryContext&&this.oContext===o){this._fireChange({reason:C.Context});return;}if(d.hasChanged(this.oContext,o)){this.oContext=o;if(!this.isRelative()){return;}if(this.getResolvedPath()){this.resetData();this._initialize();this._fireChange({reason:C.Context});}else{if(!c(this.oAllKeys)||!c(this.oKeys)||!c(this._aNodes)){this.resetData();this._fireChange({reason:C.Context});}}}};n.prototype.applyAdapterInterface=function(){this.getContexts=this.getContexts||function(){return[];};this.getNodes=this.getNodes||function(){return[];};this.getLength=this.getLength||function(){return 0;};this.isLengthFinal=this.isLengthFinal||function(){return false;};this.getContextByIndex=this.getContextByIndex||function(){return;};this.attachSelectionChanged=this.attachSelectionChanged||function(D,i,o){this.attachEvent("selectionChanged",D,i,o);return this;};this.detachSelectionChanged=this.detachSelectionChanged||function(i,o){this.detachEvent("selectionChanged",i,o);return this;};this.fireSelectionChanged=this.fireSelectionChanged||function(p){this.fireEvent("selectionChanged",p);return this;};return this;};n.prototype._applyAdapter=function(){var M="hierarchy-node-descendant-count-for";var s="hierarchy-sibling-rank-for";var p="hierarchy-preorder-rank-for";if(this.bHasTreeAnnotations){var A=this.getResolvedPath();if(A.indexOf("?")!==-1){A=A.split("?")[0];}var E=this.oModel.oMetadata._getEntityTypeByPath(A);var t=this;q.each(E.property,function(I,P){if(!P.extensions){return true;}q.each(P.extensions,function(I,u){var N=u.name;if(u.namespace===t.oModel.oMetadata.mNamespaces["sap"]&&(N==M||N==s||N==p)){t.oTreeProperties[N]=P.name;}});});this.oTreeProperties[M]=this.oTreeProperties[M]||(this.mParameters.treeAnnotationProperties&&this.mParameters.treeAnnotationProperties.hierarchyNodeDescendantCountFor);if(this.oTreeProperties[M]&&this.sOperationMode==m.Server){var i,j,k;this.oTreeProperties[s]=this.oTreeProperties[s]||(this.mParameters.treeAnnotationProperties&&this.mParameters.treeAnnotationProperties.hierarchySiblingRankFor);this.oTreeProperties[p]=this.oTreeProperties[p]||(this.mParameters.treeAnnotationProperties&&this.mParameters.treeAnnotationProperties.hierarchyPreorderRankFor);if(this.mParameters.restoreTreeStateAfterChange){if(this.oTreeProperties[s]&&this.oTreeProperties[p]){this._bRestoreTreeStateAfterChange=true;this._aTreeKeyProperties=[];for(i=E.key.propertyRef.length-1;i>=0;i--){this._aTreeKeyProperties.push(E.key.propertyRef[i].name);}}else{L.warning("Tree state restoration not possible: Missing annotation \"hierarchy-sibling-rank-for\" and/or \"hierarchy-preorder-rank-for\"");this._bRestoreTreeStateAfterChange=false;}}else{this._bRestoreTreeStateAfterChange=false;}if(this.mParameters&&this.mParameters.select){if(this.mParameters.select.indexOf(this.oTreeProperties[M])===-1){this.mParameters.select+=","+this.oTreeProperties[M];}if(this._bRestoreTreeStateAfterChange){for(j=this._aTreeKeyProperties.length-1;j>=0;j--){k=this._aTreeKeyProperties[j];if(this.mParameters.select.indexOf(k)===-1){this.mParameters.select+=","+k;}}}this.sCustomParams=this.oModel.createCustomParams(this.mParameters);}var o=sap.ui.requireSync("sap/ui/model/odata/ODataTreeBindingFlat");o.apply(this);}else{var r=sap.ui.requireSync("sap/ui/model/odata/ODataTreeBindingAdapter");r.apply(this);}}else if(this.oNavigationPaths){var r=sap.ui.requireSync("sap/ui/model/odata/ODataTreeBindingAdapter");r.apply(this);}else{L.error("Neither hierarchy annotations, nor navigation properties are specified to build the tree.",this);}};n.prototype._processSelectParameters=function(){if(this.mParameters){this.oNavigationPaths=this.mParameters.navigation;if(this.mParameters.select){var s=this.mParameters.select.split(",");var N=[];if(this.oNavigationPaths){q.each(this.oNavigationPaths,function(p,P){if(N.indexOf(P)==-1){N.push(P);}});}q.each(N,function(p,P){if(s.indexOf(P)==-1){s.push(P);}});if(this.bHasTreeAnnotations){q.each(this.oTreeProperties,function(A,t){if(t){if(s.indexOf(t)==-1){s.push(t);}}});}this.mParameters.select=s.join(",");}this.sCustomParams=this.oModel.createCustomParams(this.mParameters);}if(!this.bHasTreeAnnotations&&!this.oNavigationPaths){L.error("Neither navigation paths parameters, nor (complete/valid) tree hierarchy annotations where provided to the TreeBinding.");this.oNavigationPaths={};}};n.prototype.getTreeAnnotation=function(A){return this.bHasTreeAnnotations?this.oTreeProperties[A]:undefined;};n.prototype.getDownloadUrl=function(s){var p=[],P;if(s){p.push("$format="+encodeURIComponent(s));}if(this.aSorters&&this.aSorters.length>0){p.push(O.createSortParams(this.aSorters));}if(this.getFilterParams()){p.push("$filter="+this.getFilterParams());}if(this.sCustomParams){p.push(this.sCustomParams);}P=this.getResolvedPath();if(P){return this.oModel._createRequestUrl(P,null,p);}};n.prototype.setNumberOfExpandedLevels=function(i){i=i||0;if(i<0){L.warning("ODataTreeBinding: numberOfExpandedLevels was set to 0. Negative values are prohibited.");i=0;}this.iNumberOfExpandedLevels=i;this._fireChange();};n.prototype.getNumberOfExpandedLevels=function(){return this.iNumberOfExpandedLevels;};n.prototype.setRootLevel=function(r){r=parseInt(r||0);if(r<0){L.warning("ODataTreeBinding: rootLevels was set to 0. Negative values are prohibited.");r=0;}this.iRootLevel=r;this.refresh();};n.prototype.getRootLevel=function(){return parseInt(this.iRootLevel);};n.prototype._getEntityType=function(){var r=this.getResolvedPath();if(r){var E=this.oModel.oMetadata._getEntityTypeByPath(r);a(E,"EntityType for path "+r+" could not be found!");return E;}return undefined;};n.prototype.getFilterParams=function(){var G;if(this.aApplicationFilters){this.aApplicationFilters=Array.isArray(this.aApplicationFilters)?this.aApplicationFilters:[this.aApplicationFilters];if(this.aApplicationFilters.length>0&&!this.sFilterParams){G=e.groupFilters(this.aApplicationFilters);this.sFilterParams=O._createFilterParams(G,this.oModel.oMetadata,this.oEntityType);this.sFilterParams=this.sFilterParams?"("+this.sFilterParams+")":"";}}else{this.sFilterParams="";}return this.sFilterParams;};n.prototype._abortPendingRequest=function(){if(!c(this.mRequestHandles)){this.bSkipDataEvents=true;q.each(this.mRequestHandles,function(r,R){if(R){R.abort();}});this.mRequestHandles={};}};return n;});
