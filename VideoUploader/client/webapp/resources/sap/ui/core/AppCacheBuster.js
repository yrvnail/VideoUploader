/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObject','sap/ui/thirdparty/URI','sap/base/Log','sap/base/util/extend','sap/base/strings/escapeRegExp','sap/ui/thirdparty/jquery','sap/ui/core/IconPool','./Core'],function(M,U,L,a,b,q,I){"use strict";var c=sap.ui.getCore().getConfiguration();var l=c.getLanguage();var s=c.getAppCacheBusterMode()==="sync";var B=c.getAppCacheBusterMode()==="batch";var S={index:{},active:false};var v,d,f,x,E;var g=document.baseURI.replace(/\?.*|#.*/g,"");var u=U(sap.ui.require.toUrl("")+"/../");var o=u.toString();if(u.is("relative")){u=u.absoluteTo(g);}var h=u.normalize().toString();var r=U("resources").absoluteTo(h).toString();var F=new RegExp("^"+b(r));var i=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/";}return e;};var R=function(h,e){var m=S.index;var j;var k;var n;if(Array.isArray(h)&&!B){h.forEach(function(G){R(G,e);});}else if(Array.isArray(h)&&B){var p=i(h[0]);var C=[];L.debug("sap.ui.core.AppCacheBuster.register(\""+p+"\"); // BATCH MODE!");var t=A.normalizeURL(p);L.debug("  --> normalized to: \""+t+"\"");h.forEach(function(G){k=i(G);var J=A.normalizeURL(k);if(!m[n]){C.push(J);}});if(C.length>0){var k=t+"sap-ui-cachebuster-info.json?sap-ui-language="+l;j={url:k,type:"POST",async:!s&&!!e,dataType:"json",contentType:"text/plain",data:C.join("\n"),success:function(G){A.onIndexLoaded(k,G);a(m,G);},error:function(){L.error("Failed to batch load AppCacheBuster index file from: \""+k+"\".");}};}}else{h=i(h);L.debug("sap.ui.core.AppCacheBuster.register(\""+h+"\");");n=A.normalizeURL(h);L.debug("  --> normalized to: \""+n+"\"");if(!m[n]){var k=n+"sap-ui-cachebuster-info.json?sap-ui-language="+l;j={url:k,async:!s&&!!e,dataType:"json",success:function(G){A.onIndexLoaded(k,G);m[n]=G;},error:function(){L.error("Failed to load AppCacheBuster index file from: \""+k+"\".");}};}}if(j){var w=A.onIndexLoad(j.url);if(w!=null){L.info("AppCacheBuster index file injected for: \""+k+"\".");j.success(w);}else{if(j.async){var y=e.startTask("load "+k);var z=j.success,D=j.error;Object.assign(j,{success:function(G){z.apply(this,arguments);e.finishTask(y);},error:function(){D.apply(this,arguments);e.finishTask(y,false);}});}L.info("Loading AppCacheBuster index file from: \""+k+"\".");q.ajax(j);}}};var A={boot:function(e){var C=c.getAppCacheBuster();if(C&&C.length>0){C=C.slice();var j=true;var V=String(C[0]).toLowerCase();if(C.length===1){if(V==="true"||V==="x"){var u=U(o);C=u.is("relative")?[u.toString()]:[];}else if(V==="false"){j=false;}}if(j){A.init();R(C,e);}}},init:function(){S.active=true;v=M.prototype.validateProperty;d=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");f=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href");var C=A.convertURL;var n=A.normalizeURL;var j=function(e){if(this.active===true&&e&&typeof(e)==="string"){e=n(e);return!e.match(F);}return false;}.bind(S);x=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,t){if(t&&j(t)){arguments[1]=C(t);}x.apply(this,arguments);};E=XMLHttpRequest.prototype.open;M.prototype.validateProperty=function(P,V){var t=this.getMetadata(),w=t.getProperty(P),y;if(w&&w.type==="sap.ui.core.URI"){y=Array.prototype.slice.apply(arguments);try{if(j(y[1])){y[1]=C(y[1]);}}catch(e){}}return v.apply(this,y||arguments);};I._convertUrl=function(e){return C(e);};var k=function(e){var t={get:e.get,set:function(w){if(j(w)){w=C(w);}e.set.call(this,w);},enumerable:e.enumerable,configurable:e.configurable};t.set._sapUiCoreACB=true;return t;};var m=false;try{Object.defineProperty(HTMLScriptElement.prototype,"src",k(d));}catch(p){L.error("Your browser doesn't support redefining the src property of the script tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+p);m=true;}try{Object.defineProperty(HTMLLinkElement.prototype,"href",k(f));}catch(p){L.error("Your browser doesn't support redefining the href property of the link tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+p);m=true;}if(m){this.exit();}},exit:function(){M.prototype.validateProperty=v;delete I._convertUrl;if(XMLHttpRequest.prototype.open===E){XMLHttpRequest.prototype.open=x;}var e;if((e=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLScriptElement.prototype,"src",d);}if((e=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLLinkElement.prototype,"href",f);}S.index={};S.active=false;S={index:{},active:false};},register:function(h){R(h);},convertURL:function(e){L.debug("sap.ui.core.AppCacheBuster.convertURL(\""+e+"\");");var m=S.index;if(m&&e&&!/^#/.test(e)){var n=A.normalizeURL(e);L.debug("  --> normalized to: \""+n+"\"");if(n&&A.handleURL(n)){for(var h in m){var j=m[h],k,p;if(h&&n.length>=h.length&&n.slice(0,h.length)===h){k=n.slice(h.length);p=k.match(/([^?#]*)/)[1];if(j[p]){e=h+"~"+j[p]+"~/"+k;L.debug("  ==> rewritten to \""+e+"\";");break;}}}}}return e;},normalizeURL:function(e){var u=U(e||"./");if(u.is("relative")){u=u.absoluteTo(g);}return u.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString();},handleURL:function(e){return true;},onIndexLoad:function(e){return null;},onIndexLoaded:function(e,m){}};var H=c.getAppCacheBusterHooks();if(H){["handleURL","onIndexLoad","onIndexLoaded"].forEach(function(e){if(typeof H[e]==="function"){A[e]=H[e];}});}return A;},true);
