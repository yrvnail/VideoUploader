/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/util/DataProvider","jquery.sap.global","sap/base/Log","sap/ui/model/odata/v4/ODataUtils"],function(D,q,L,O){"use strict";var m=["no-cors","same-origin","cors"];var M=["GET","POST"];var R=D.extend("sap.ui.integration.util.RequestDataProvider",{metadata:{properties:{allowCustomDataType:{type:"boolean",defaultValue:false}}}});R.prototype.getData=function(){var r=this.getSettings().request;if(this._oDestinations){return this._oDestinations.process(r).then(this._fetch.bind(this));}return this._fetch(r);};R.prototype._isValidRequest=function(r){if(!r){return false;}if(m.indexOf(r.mode)===-1){return false;}if(M.indexOf(r.method)===-1){return false;}if(typeof r.url!=="string"){return false;}return true;};R.prototype._fetch=function(r){var s="Invalid request";if(!r||!r.url){L.error(s);return Promise.reject(s);}if(!this.getAllowCustomDataType()&&r.dataType){L.error("To specify dataType property in the Request Configuration, first set allowCustomDataType to 'true'.");}var d=r.parameters,c=this.getCardInstance(),u=r.url,a=(this.getAllowCustomDataType()&&r.dataType)||"json",h=r.headers,b=r.batch,B,o;if(c&&!u.startsWith("/")){u=c.getRuntimeUrl(r.url);}if(this._hasHeader(r,"Content-Type","application/json")){d=JSON.stringify(r.parameters);}if(b){B=O.serializeBatchRequest(Object.values(b));a="text";d=B.body;h=Object.assign({},h,B.headers);}o={"mode":r.mode||"cors","url":u,"method":(r.method&&r.method.toUpperCase())||"GET","dataType":a,"data":d,"headers":h,"timeout":15000,"xhrFields":{"withCredentials":!!r.withCredentials}};if(!this._isValidRequest(o)){L.error(s);return Promise.reject(s);}return this._request(o).then(function(v){var d=v[0],j=v[1];if(b){return this._deserializeBatchResponse(b,d,j);}return d;}.bind(this));};R.prototype._request=function(r){return new Promise(function(a,b){q.ajax(r).done(function(d,t,j){a([d,j]);}).fail(function(j,t,e){b([e,j]);});});};R.prototype._hasHeader=function(r,h,v){if(!r.headers){return false;}for(var k in r.headers){if(k.toLowerCase()===h.toLowerCase()&&r.headers[k]===v){return true;}}return false;};R.prototype._deserializeBatchResponse=function(b,r,j){return new Promise(function(a,c){var C=j.getResponseHeader("Content-Type"),B=O.deserializeBatchResponse(C,r,false),k=Object.keys(b),d={};k.forEach(function(K,i){var e=B[i],o;if(!e){c("Batch responses do not match the batch requests.");return;}o=new Response(e.responseText,e);if(!o.ok){c("One of batch requests fails with '"+o.status+" "+o.statusText+"'");return;}d[K]=e.responseText?JSON.parse(e.responseText):{};});a(d);});};return R;});
