/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/MultiComboBox","sap/ui/core/ListItem","sap/base/util/each","sap/base/util/restricted/_debounce","sap/base/util/ObjectPath","sap/base/util/includes","sap/ui/core/SeparatorItem","sap/ui/core/Core","sap/ui/model/Sorter"],function(B,I,T,M,L,e,_,O,i,S,C,b){"use strict";var d="#";var r=C.getLibraryResourceBundle("sap.ui.integration");var c=B.extend("sap.ui.integration.designtime.editor.fields.ListField",{renderer:B.getMetadata().getRenderer()});c.prototype.initVisualization=function(o){var t=this;var v=o.visualization;if(!v){if(o.values){var f=this.formatListItem(o.values.item);v={type:M,settings:{selectedKeys:{path:'currentSettings>value'},busy:{path:'currentSettings>_loading'},editable:o.editable,visible:o.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:f,sorter:[new b({path:'Selected',descending:false,group:true})],groupHeaderFactory:t.getGroupHeader}}};if(this.isFilterBackend(o)){v.settings.selectedKeys={parts:['currentSettings>value','currentSettings>suggestValue'],formatter:function(V,s){if(s){t.setSuggestValue();}return V;}};}}else{v={type:I,settings:{value:{path:'currentSettings>value',formatter:function(a){a=a||[];return a.join(",");}},change:function(E){var s=E.getSource();s.getBinding("value").setRawValue(s.getValue().split(","));},editable:o.editable,visible:o.visible,placeholder:o.placeholder}};}}this._visualization=v;this.attachAfterInit(this._afterInit);};c.prototype._afterInit=function(){var o=this.getAggregation("_field");if(o instanceof M){var a=this.getConfiguration();this.prepareFieldsInKey(a);if(this.isFilterBackend(a)){this.onInput=_(this.onInput,500);o.oninput=this.onInput;o.attachSelectionChange(this.onSelectionChangeForFilterBackend);o.attachSelectionFinish(this.onSelectionFinish);var m=this.getModel();m.attachPropertyChange(this.mergeSelectedItems,this);}else{o.attachSelectionChange(this.onSelectionChange);}}};c.prototype.prepareFieldsInKey=function(o){this._sKeySeparator=o.values.keySeparator;if(!this._sKeySeparator){this._sKeySeparator=d;}var k=o.values.item.key;this._aFields=k.split(this._sKeySeparator);for(var n in this._aFields){if(this._aFields[n].startsWith("{")){this._aFields[n]=this._aFields[n].substring(1);}if(this._aFields[n].endsWith("}")){this._aFields[n]=this._aFields[n].substring(0,this._aFields[n].length-1);}}};c.prototype.getKeyFromItem=function(o){var s="";this._aFields.forEach(function(f){s+=o[f].toString()+this._sKeySeparator;}.bind(this));if(s.endsWith(this._sKeySeparator)){s=s.substring(0,s.length-this._sKeySeparator.length);}return s;};c.prototype.mergeSelectedItems=function(E){var o=this.getConfiguration();if(!o.valueItems){o.valueItems=[];}var p=o.values.data.path||"/";var v=this.getModel();var D=v.getData();if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}var P=p.split("/");var R=O.get(P,D);if(Array.isArray(R)){var s=o.valueItems.map(function(g){return this.getKeyFromItem(g);}.bind(this));var a=R.filter(function(g){var h=this.getKeyFromItem(g);return!i(s,h);}.bind(this));var f=a.filter(function(g){return g.Selected===r.getText("CARDEDITOR_ITEM_SELECTED");});o.valueItems=o.valueItems.concat(f);var n=a.filter(function(g){return g.Selected!==r.getText("CARDEDITOR_ITEM_SELECTED");});R=o.valueItems.concat(n);}else{R=o.valueItems;}O.set(P,R,D);}else if(Array.isArray(D)){var s=o.valueItems.map(function(g){return this.getKeyFromItem(g);}.bind(this));var a=D.filter(function(g){var h=this.getKeyFromItem(g);return!i(s,h);}.bind(this));var f=a.filter(function(g){return g.Selected===r.getText("CARDEDITOR_ITEM_SELECTED");});o.valueItems=o.valueItems.concat(f);var n=a.filter(function(g){return g.Selected!==r.getText("CARDEDITOR_ITEM_SELECTED");});D=o.valueItems.concat(n);}else{D=o.valueItems;}v.setData(D);this.setSuggestValue();};c.prototype.setSuggestValue=function(){var o=this.getAggregation("_field");var s=this.getBindingContext("currentSettings").sPath;var a=this.getModel("currentSettings");var f=a.getProperty(s+"/suggestValue");if(f&&f!==""){o.setValue(f.replaceAll("\'\'","'"));}};c.prototype.getGroupHeader=function(g){return new S({text:g.key});};c.prototype.onSelectionChangeForFilterBackend=function(E){var f=E.oSource.getParent();var o=f.getConfiguration();var l=E.getParameter("changedItem");var s=l.getKey();var a=E.getParameter("selected");if(!a){if(o.valueItems){o.valueItems=o.valueItems.filter(function(k){var m=f.getKeyFromItem(k);return m!==s;});}}else{var D=this.getModel().getData();var p=o.values.data.path||"/";if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}var P=p.split("/");D=O.get(P,D);}if(D){if(!o.valueItems){o.valueItems=[];}D.some(function(k){var m=f.getKeyFromItem(k);if(m===s){k.Selected=r.getText("CARDEDITOR_ITEM_SELECTED");o.valueItems=o.valueItems.concat([k]);return true;}return false;});}}var g=o.valueItems.map(function(k){return f.getKeyFromItem(k);});var h=this.getBindingContext("currentSettings").sPath;var j=this.getModel("currentSettings");j.setProperty(h+"/value",g);};c.prototype.onSelectionChange=function(E){var f=E.oSource.getParent();var o=f.getConfiguration();var l=E.getParameter("changedItem");var s=l.getKey();var a=E.getParameter("selected");var D=this.getModel().getData();var p=o.values.data.path||"/";if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}var P=p.split("/");var R=O.get(P,D);if(Array.isArray(R)){for(var n in R){var g=f.getKeyFromItem(R[n]);if(g===s){if(a){R[n].Selected=r.getText("CARDEDITOR_ITEM_SELECTED");}else{R[n].Selected=r.getText("CARDEDITOR_ITEM_UNSELECTED");}}}O.set(P,R,D);}}else if(Array.isArray(D)){for(var n in D){var g=f.getKeyFromItem(D[n]);if(g===s){if(a){D[n].Selected=r.getText("CARDEDITOR_ITEM_SELECTED");}else{D[n].Selected=r.getText("CARDEDITOR_ITEM_UNSELECTED");}}}}this.getModel().setData(D);this.getModel().checkUpdate(true);};c.prototype.onSelectionFinish=function(E){var f=this.getParent();var o=f.getConfiguration();var s=E.getParameter("selectedItems").map(function(h){return h.getKey();});var D=this.getModel().getData();var p=o.values.data.path||"/";if(p!=="/"){if(p.startsWith("/")){p=p.substring(1);}if(p.endsWith("/")){p=p.substring(0,p.length-1);}var P=p.split("/");D=O.get(P,D);}if(D){o.valueItems=D.filter(function(h){var j=f.getKeyFromItem(h);return i(s,j);});}var a=this.getBindingContext("currentSettings").sPath;var g=this.getModel("currentSettings");g.setProperty(a+"/value",s);g.setProperty(a+"/suggestValue","");};c.prototype.onInput=function(E){var t=E.target.value;var s=this.getBindingContext("currentSettings").sPath;var o=this.getModel("currentSettings");o.setProperty(s+"/suggestValue",t.replaceAll("'","\'\'"));o.setProperty(s+"/_loading",true);var a=o.getBindings();var p=s.substring(s.lastIndexOf("/")+1);e(a,function(f,g){if(g.sPath==="/form/items/"+p+"/value"){g.checkUpdate(true);}});E.srcControl.open();E.srcControl._getSuggestionsPopover()._sTypedInValue=t;};return c;});
