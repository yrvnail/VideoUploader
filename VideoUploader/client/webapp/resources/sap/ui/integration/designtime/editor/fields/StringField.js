/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/integration/designtime/editor/fields/BaseField","sap/m/Input","sap/m/Text","sap/m/Title","sap/m/Select","sap/m/ComboBox","sap/m/Popover","sap/m/Button","sap/m/OverflowToolbar","sap/m/ToolbarSpacer","sap/ui/core/ListItem","sap/m/List","sap/m/CustomListItem","sap/m/VBox","./viz/IconSelect","sap/base/util/each","sap/base/util/restricted/_debounce","sap/ui/core/Core","sap/ui/model/json/JSONModel","sap/ui/integration/designtime/editor/CardResourceBundles","sap/base/util/deepClone","sap/ui/model/Sorter","sap/ui/core/SeparatorItem","sap/base/util/includes","sap/base/util/merge","sap/ui/core/CustomData"],function(B,I,T,a,S,C,P,b,O,c,L,d,e,V,f,g,_,h,J,i,j,k,l,m,n,o){"use strict";var q=B.extend("sap.ui.integration.designtime.editor.fields.StringField",{renderer:B.getMetadata().getRenderer()});q.prototype.initVisualization=function(p){var v=p.visualization;if(!v){if(this.getMode()==="translation"){if(p.editable){v={type:I,settings:{value:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},editable:p.editable,visible:p.visible,placeholder:p.placeholder}};}else{v={type:T,settings:{text:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},visible:p.visible,wrapping:false}};}}else{if(p.enum){var r=new L({key:{path:"currentSettings>"},text:{path:"currentSettings>"}});v={type:S,settings:{selectedKey:{path:'currentSettings>value'},forceSelection:false,editable:p.editable,visible:p.visible,showSecondaryValues:false,width:"100%",items:{path:"currentSettings>enum",template:r}}};}else if(p.values){var r=this.formatListItem(p.values.item);if(!p.values.item.key){p.values.item.key=p.values.item.text;}v={type:C,settings:{busy:{path:'currentSettings>_loading'},selectedKey:{path:'currentSettings>value'},editable:p.editable,visible:p.visible,showSecondaryValues:true,width:"100%",items:{path:"",template:r}}};if(this.isFilterBackend(p)){v.settings.selectedKey={parts:['currentSettings>value','currentSettings>suggestValue'],formatter:function(s,t){if((!s||s==="")&&t){return t.replaceAll('\'\'',"'");}else{return s;}}};}}else{v={type:I,settings:{value:{path:'currentSettings>value'},tooltip:{path:'currentSettings>value'},editable:p.editable,visible:p.visible,placeholder:p.placeholder}};}}}this._visualization=v;this.attachAfterInit(this._afterInit);};q.prototype._afterInit=function(){var p=this.getAggregation("_field");if(p instanceof C){var r=this.getConfiguration();if(this.isFilterBackend(r)){this.onInput=_(this.onInput,500);p.oninput=this.onInput;p.attachSelectionChange(this.onSelectionChange);}}};q.prototype.onSelectionChange=function(E){var s=E.getParameter("selectedItem")||{};var K=s.getKey();var p=this.getBindingContext("currentSettings").sPath;var r=this.getModel("currentSettings");r.setProperty(p+"/value",K);};q.prototype.onInput=function(E){var t=E.target.value;var s=this.getBindingContext("currentSettings").sPath;var p=this.getModel("currentSettings");p.setProperty(s+"/suggestValue",t.replaceAll("'","\'\'"));p.setProperty(s+"/_loading",true);p.setProperty(s+"/value","");var r=p.getBindings();var u=s.substring(s.lastIndexOf("/")+1);g(r,function(w,x){if(x.sPath==="/form/items/"+u+"/value"){x.checkUpdate(true);}});var v=E.srcControl;v.open();v.setValue(t);v.setSelection(null);};q.prototype.getOriginTranslatedValues=function(r){var s=[];var t=i.getInstance(r._resourceBundleURL);for(var p in t){var R=t[p];var K;if(r._translatedDefaultPlaceholder.startsWith("{i18n>")&&r._translatedDefaultPlaceholder.endsWith("}")){K=r._translatedDefaultPlaceholder.substring(6,r._translatedDefaultPlaceholder.length-1);}else if(r._translatedDefaultPlaceholder.startsWith("{{")&&r._translatedDefaultPlaceholder.endsWith("}}")){K=r._translatedDefaultPlaceholder.substring(2,r._translatedDefaultPlaceholder.length-2);}var u="";var v="";if(K&&R){var w=R.resourceBundle.getText(K,[],true);if(w!==undefined){u=w;v=w;}}else{u=r._translatedDefaultPlaceholder;v=r._translatedDefaultPlaceholder;}var x={"key":p,"desription":R.language,"value":u,"originValue":v,"editable":true};s.push(x);}return s;};q.prototype.openTranslationListPopup=function(E){var t=this;var p=E.getSource();var F=p.getParent();var r=F.getConfiguration();if(!t._aOriginTranslatedValues){t._aOriginTranslatedValues=F.getOriginTranslatedValues(r);}var s=j(t._aOriginTranslatedValues);var R=h.getLibraryResourceBundle("sap.ui.integration");s.forEach(function(w){if(r.valueTranslations&&r.valueTranslations[w.key]){w.value=r.valueTranslations[w.key];if(!m(t._aUpdatedLanguages,w.key)){w.originValue=w.value;}}w.status=R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");if(w.key===R.sLocale){w.editable=false;}});var u={"currentLanguage":{},"isUpdated":false,"translatedLanguages":[]};var M;if(s){s.forEach(function(w){if(m(t._aUpdatedLanguages,w.key)){w.value=r.valueTranslations[w.key];w.status=R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");}if(w.key===R.sLocale){w.value=p.getValue();u.currentLanguage=w;}else{u.translatedLanguages.push(w);}});}if(!t._oTranslationPopover){var v=new d({items:{path:"languages>/translatedLanguages",template:new e({content:[new V({items:[new T({text:"{languages>desription}"}),new I({value:"{languages>value}",editable:"{languages>editable}"})]})],customData:[new o({key:"{languages>key}",value:"{languages>desription}"})]}),sorter:[new k({path:'status',descending:true,group:true})],groupHeaderFactory:t.getGroupHeader}});t._oTranslationPopover=new P({placement:"Right",contentWidth:"300px",contentHeight:"345px",customHeader:new V({items:[new a({text:R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_TITLE")}).addStyleClass("sapMPopoverTitle"),new a({text:R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_CURRENTLANGUAGE")}).addStyleClass("sapMHeaderTitle"),new V({items:[new T({text:"{languages>/currentLanguage/desription}"}),new I({value:"{languages>/currentLanguage/value}",editable:false})]}).addStyleClass("sapMCurrentLanguageVBox"),new a({text:R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_OTHERLANGUAGES")}).addStyleClass("sapMHeaderTitle")]}),content:v,footer:new O({content:[new c(),new b({type:"Emphasized",text:R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_SAVE"),enabled:"{languages>/isUpdated}",press:function(){var w=t._oTranslationPopover.getModel("languages").getData();var x=j(r.valueTranslations);var y={};var U=[];w.translatedLanguages.forEach(function(z){if(z.value!==z.originValue){y[z.key]=z.value;U.push(z.key);}});if(w.currentLanguage.value!=w.currentLanguage.originValue){y[w.currentLanguage.key]=w.currentLanguage.value;U.push(w.currentLanguage.key);}if(y!=={}){r.valueTranslations=n(x,y);r._changed=true;}if(U.length>0){t._aUpdatedLanguages=U;}t._oTranslationPopover.close();}}),new b({text:R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_BUTTON_CANCEL"),press:function(){t._oTranslationPopover.close();}})]})}).addStyleClass("sapUiIntegrationFieldTranslation");M=new J(u);M.attachPropertyChange(function(E){var D=M.getData();var U=R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_UPDATED");var N=R.getText("CARDEDITOR_FIELD_TRANSLATION_LIST_POPOVER_LISTITEM_GROUP_NOTUPDATED");var w=false;D.translatedLanguages.forEach(function(x){if(x.value!==x.originValue){x.status=U;w=true;}else{x.status=N;}});D.isUpdated=w;M.setData(D);M.checkUpdate(true);});t._oTranslationPopover.setModel(M,"languages");}else{M=t._oTranslationPopover.getModel("languages");M.setData(u);M.checkUpdate(true);}t._oTranslationPopover.openBy(p);};q.prototype.getGroupHeader=function(G){return new l({text:G.key});};return q;});
