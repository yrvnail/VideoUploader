/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["ui5loader","sap/ui/core/Control","sap/ui/core/Core","sap/base/util/deepClone","sap/base/util/merge","sap/ui/integration/widgets/Card","sap/ui/integration/Designtime","sap/ui/model/json/JSONModel","sap/ui/integration/util/CardMerger","sap/ui/integration/util/Utils","sap/m/Label","sap/m/Title","sap/m/Panel","sap/m/HBox","sap/m/VBox","sap/ui/core/Icon","sap/m/ResponsivePopover","sap/m/Popover","sap/m/Text","sap/base/Log","sap/ui/core/Popup","sap/base/i18n/ResourceBundle","sap/ui/thirdparty/URI","sap/ui/dom/includeStylesheet","sap/base/util/LoaderExtensions","sap/ui/core/theming/Parameters","sap/base/util/ObjectPath","sap/m/FormattedText","sap/m/MessageStrip","sap/base/util/includes"],function(u,C,c,d,f,g,D,J,h,U,L,T,P,H,V,I,R,k,l,p,q,r,t,v,w,x,O,F,M,y){"use strict";var A=k.prototype.init;k.prototype.init=function(){A.apply(this,arguments);var a=this.oPopup._applyPosition,b=this;this.oPopup._applyPosition=function(){var e=b.close;b.close=function(){};a.apply(this,arguments);b.close=e;};};function B(s){if(s&&s.nodeType!==1){return 0;}var z=parseInt(window.getComputedStyle(s).getPropertyValue('z-index'));if(isNaN(z)){return B(s.parentNode);}return z+1;}var E=/\{\{(?!parameters.)(?!destinations.)([^\}\}]+)\}\}/g,G=5000,K=c.getLibraryResourceBundle("sap.ui.integration");var N=C.extend("sap.ui.integration.designtime.editor.CardEditor",{metadata:{library:"sap.ui.integration",properties:{card:{type:"any",defaultValue:null},mode:{type:"string",defaultValue:"admin"},language:{type:"string",defaultValue:""},allowDynamicValues:{type:"boolean",defaultValue:false},allowSettings:{type:"boolean",defaultValue:false},designtime:{type:"object"}},aggregations:{_formContent:{type:"sap.ui.core.Control",multiple:true,visibility:"hidden"},_preview:{type:"sap.ui.integration.designtime.editor.CardPreview",multiple:false,visibility:"hidden"},_messageStrip:{type:"sap.m.MessageStrip",multiple:false,visibility:"hidden"}},events:{ready:{}}},renderer:function(o,a){o.openStart("div");a.getMode()==="translation"?o.addClass("sapUiIntegrationCardEditorTranslation"):o.addClass("sapUiIntegrationCardEditorPreview");o.addClass("sapUiIntegrationCardEditor");o.writeClasses();o.writeElementData(a);o.openEnd();if(a.isReady()){var b=a.getAggregation("_preview");var e=false;if(b&&b.getSettings()&&b.getSettings().preview&&b.getSettings().preview.modes==="None"){e=true;}o.openStart("div");a.getMode()==="translation"||e?o.addClass("sapUiIntegrationCardEditorFormWithNoPreview"):o.addClass("sapUiIntegrationCardEditorForm");if(a.getMode()!=="translation"){o.addClass("settingsButtonSpace");}o.writeClasses();o.openEnd();if(a.getMode()!=="translation"){o.renderControl(a.getAggregation("_messageStrip"));}var j=a.getAggregation("_formContent");if(j){var m;var s;var z;var S;var W=[];var X=2;var Y;var Z=function(){return new sap.m.FlexItemData({growFactor:1,baseSize:"0",maxWidth:"50%"});};var $=function(){if(W.length>0){var e1=X-W.length;for(var n=0;n<e1;n++){W.push(new V({}));}m.addContent(new H({items:W}));W=[];}};for(var i=0;i<j.length;i++){var _=j[i];if(a.getMode()!=="translation"){if(_.isA("sap.m.Panel")){if(m){$();if(m.getContent().length>0){o.renderControl(m);}}m=_;m.addStyleClass("sapUiIntegrationCardEditorItem");if(i===j.length-1){$();if(m.getContent().length>0){o.renderControl(m);}}continue;}if(_.isA("sap.m.FormattedText")){m.addContent(new H({items:_}).addStyleClass("sapUiIntegrationCardEditorHint"));continue;}if(_.isA("sap.m.Label")){_.addStyleClass("sapUiIntegrationCardEditorItemLabel");var a1=_.getDependents()&&_.getDependents()[0];var b1=new H({items:[_.addStyleClass("description")]});if(a1){b1.addItem(a1);}if(_._oMessageIcon){b1.addItem(_._oMessageIcon);}if(_._cols===1){if(W.length===X){m.addContent(new H({items:W}));W=[];}b1.addStyleClass("col1box");S=b1?b1:_;continue;}$();if(_._sOriginalType==="boolean"){z=b1?b1:_;}else{m.addContent(b1?b1:_);}}else if(_._cols===1){var c1=new V({items:[S,_]});c1.addStyleClass("col1");W.push(c1);S=null;}else if(z){_.setLayoutData(Z());z.setLayoutData(Z());m.addContent(new H({items:[z,_]}).addStyleClass("notWrappingBox"));z=null;}else{m.addContent(_);}if(i===j.length-1){$();if(m.getContent().length>0){o.renderControl(m);}}}else{if(i===0){s=_;o.renderControl(s);s.addStyleClass("sapUiIntegrationCardEditorTranslationPanel");continue;}if(_.isA("sap.m.Panel")){if(m&&m.getContent().length>0){s.addContent(m);}m=_;m.addStyleClass("sapUiIntegrationCardEditorTranslationSubPanel");continue;}if(_.isA("sap.m.FormattedText")){continue;}if(_.isA("sap.m.Label")){m.addContent(_);continue;}if(_.isOrigLangField){Y=_;continue;}Y.setLayoutData(Z());Y.addStyleClass("sapUiIntegrationFieldTranslationText");_.setLayoutData(Z());var d1=new H({items:[Y,_]});m.addContent(d1);if(i===j.length-1){s.addContent(m);}}}}o.close("div");b&&o.renderControl(b);}o.close("div");}});N.prototype.init=function(){this._ready=false;this._aFieldReadyPromise=[];this._oResourceBundle=K;this._appliedLayerManifestChanges=[];this._currentLayerManifestChanges={};this._mDestinationDataProviders={};this.setAggregation("_messageStrip",new M({showIcon:false}));};N.prototype.isReady=function(){return this._ready;};function Q(o,s,a,b){b=b||"";a=a||[];if(typeof o==="object"){if(!o[s]){for(var n in o){Q(o[n],s,a,b+"/"+n);}}else{if(o.type){a.push({path:o.pathvalue||b.substring(1),value:o.pathvalue||"{context>"+b.substring(1)+"/value}",object:o});}else{a.push({path:b.substring(1),object:o});for(var n in o){Q(o[n],s,a,b+"/"+n);}}}}return a;}N.prototype._filterManifestChangesByLayer=function(m){var a=this;var b=[],o={":layer":h.layers[a.getMode()]},i=h.layers[this.getMode()];m.manifestChanges.forEach(function(e){var j=e.hasOwnProperty(":layer")?e[":layer"]:1000;if(j<i){b.push(e);}else if(j===i){o=e;}});m.manifestChanges=b;a._currentLayerManifestChanges=o;};N.prototype.setCard=function(a,s){this._ready=false;if(a===this.getProperty("card")){return this;}if(this._oEditorCard){this._oEditorCard.destroy();}if(this._oDesigntimeInstance){this._oDesigntimeInstance.destroy();}this.setProperty("card",a,s);Promise.resolve().then(function(){this._initCard(a);}.bind(this));return this;};N.prototype.setLanguage=function(s,S){if(!s||typeof s!=="string"){return this;}this._language=s.replace("-","_");if(this.getLanguage()!=s){K=c.getLibraryResourceBundle("sap.ui.integration");this._oResourceBundle=K;}this.setProperty("language",s,S);if(!N._languages[this._language]){this._language=this._language.split("_")[0];}if(!N._languages[this._language]){p.warning("The language: "+s+" is currently unknown, some UI controls might show "+s+" instead of the language name.");}return this;};N.prototype.onAfterRendering=function(){if(this.getDomRef()){this._iZIndex=B(this.getDomRef());q.setInitialZIndex(this._iZIndex);}};N.prototype._getOriginalManifestJson=function(){try{return this._oEditorCard._oCardManifest._oManifest.getRawJson();}catch(e){return{};}};N.prototype._initCard=function(a){if(typeof a==="string"){try{a=JSON.parse(a);}catch(e){var i=c.byId(a);if(!i){var b=document.getElementById(a);if(b&&b.tagName&&b.tagName==="ui-integration-card"){i=b._getControl();}}a=i;}}if(a&&a.isA&&a.isA("sap.ui.integration.widgets.Card")){a={manifest:a.getManifest(),manifestChanges:a.getManifestChanges(),host:a.getHost(),baseUrl:a.getBaseUrl()};}if(typeof a==="object"){var j=h.layers[this.getMode()];if(a.manifestChanges){this._filterManifestChangesByLayer(a);}this._oEditorCard=new g(a);var m=this;this._oEditorCard._prepareToApplyManifestSettings=function(){g.prototype._prepareToApplyManifestSettings.apply(this,arguments);if(!m._oEditorCard._isManifestReady){return;}if(m._manifestModel){return;}m._appliedLayerManifestChanges=a.manifestChanges;var o=m._oEditorCard.getManifestEntry("/");var _=f({},o);m._oProviderCard=m._oEditorCard;m._oProviderCard._editorManifest=o;m._beforeManifestModel=new J(_);if(j<h.layers["translation"]&&m._currentLayerManifestChanges){o=h.mergeCardDelta(o,[m._currentLayerManifestChanges]);}m._manifestModel=new J(o);m._originalManifestModel=new J(m._getOriginalManifestJson());m._initInternal();if(!m._oEditorCard.getModel("i18n")){m._oEditorCard._loadDefaultTranslations();}m.setModel(m._oEditorCard.getModel("i18n"),"i18n");m._createContextModel();};this._oEditorCard.onBeforeRendering();}};N.prototype._initInternal=function(){var s=this._oEditorCard.getManifestEntry("/sap.card/designtime"),o=this._manifestModel.getProperty("/sap.card/configuration"),a,b=this.getDesigntime();if(b){if(typeof b==="function"){a=new Promise(function(e,i){var j=new b();this._applyDesigntimeDefaults(j.getSettings());e(j);}.bind(this));}else if(typeof b==="object"){a=new Promise(function(e,i){sap.ui.require(["sap/ui/integration/Designtime"],function(D){var j=D.extend("test.Designtime");j.prototype.create=function(){return b;};var m=new j();this._applyDesigntimeDefaults(m.getSettings());e(m);}.bind(this));}.bind(this));}}else if(s){a=this._oEditorCard.loadDesigntime().then(function(e){this._applyDesigntimeDefaults(e.getSettings());return e;}.bind(this));}else{a=Promise.resolve(this._createParameterDesigntime(o));}a.then(function(e){this._oDesigntimeInstance=e;if(this.getMode()==="admin"||this.getMode()==="all"){this._addDestinationSettings(o,this._oDesigntimeInstance);}this._settingsModel=new J(this._oDesigntimeInstance.getSettings());this.setModel(this._settingsModel,"currentSettings");this.setModel(this._settingsModel,"items");this._oProviderCard.setModel(this._settingsModel,"currentSettings");this._oProviderCard.setModel(this._settingsModel,"items");this._applyDesigntimeLayers();this._requireFields().then(function(){this._startEditor();}.bind(this));}.bind(this));};N.prototype.getCurrentSettings=function(){var s=this._settingsModel.getProperty("/"),m={},a;if(s&&s.form&&s.form.items){for(var n in s.form.items){var i=s.form.items[n];if(i.editable&&i.visible){var b="";if(i.manifestpath){b=i.manifestpath.substring(0,i.manifestpath.lastIndexOf("/"))+"/valueTranslations";}if(this.getMode()!=="translation"){if(i.translatable&&!i._changed&&i._translatedDefaultPlaceholder&&!this._currentLayerManifestChanges[i.manifestpath]&&!this._currentLayerManifestChanges[b]){continue;}else{m[i.manifestpath]=i.value;if(i.valueItems){m[i.manifestpath.substring(0,i.manifestpath.lastIndexOf("/"))+"/valueItems"]=i.valueItems;}}}else if(i.translatable&&i.value){m[i.manifestpath]=i.value;}if(i._next&&(this.getAllowSettings())){if(i._next.editable===false){a=a||{};a[i._settingspath+"/editable"]=false;}if(i._next.visible===false){a=a||{};a[i._settingspath+"/visible"]=false;}if(typeof i._next.allowDynamicValues==="boolean"&&this.getAllowDynamicValues()){a=a||{};a[i._settingspath+"/allowDynamicValues"]=i._next.allowDynamicValues;}}}}}if(this.getMode()!=="translation"){m[":multipleLanguage"]=true;}m[":layer"]=h.layers[this.getMode()];m[":errors"]=this.checkCurrentSettings()[":errors"];if(a){m[":designtime"]=a;}return m;};N.prototype.checkCurrentSettings=function(){var s=this._settingsModel.getProperty("/"),m={};if(s&&s.form&&s.form.items){for(var n in s.form.items){var i=s.form.items[n];if(i.editable){if((i.isValid||i.required)&&!(this.getMode()==="translation"&&i.translatable)){if(i.isValid){m[i.manifestpath]=i.isValid(i);}m[i.manifestpath]=true;var a=i.value;var b=i.type;if(b==="string"&&a===""){m[i.manifestpath]=a;}if((b==="date"||b==="datetime")&&isNaN(Date.parse(a))){m[i.manifestpath]=a;}if(b==="integer"){if(isNaN(parseInt(a))){m[i.manifestpath]=a;}else if(a<i.min||a>i.max){m[i.manifestpath]=a;}}if(b==="number"){if(isNaN(parseFloat(a))){m[i.manifestpath]=a;}else if(a<i.min||a>i.max){m[i.manifestpath]=a;}}}}}m[":layer"]=h.layers[this.getMode()];}m[":errors"]=Object.values(m).indexOf(false)>-1;return m;};N.prototype._createContextModel=function(){var b=this._oEditorCard.getHostInstance(),e=new J({}),i=new J([]);this.setModel(e,"context");this.setModel(i,"contextflat");i._getPathObject=function(s){var a=this.getData().filter(function(o){if(o.path===s){return true;}});return a.length?a[0]:null;};i._getValueObject=function(s){var a=this.getData()||[];a=a.filter(function(o){if(o.value===s||o.object.value===s){return true;}});return a.length?a[0]:null;};var j=new Promise(function(a,m){if(b&&b.getContext){var n=false;setTimeout(function(){if(n){return;}p.error("Card Editor context could not be determined with "+G+".");n=true;a({});},G);b.getContext().then(function(o){if(n){p.error("Card Editor context returned after more than "+G+". Context is ignored.");}n=true;a(o||{});});}else{a({});}});j.then(function(o){var a={};a["empty"]=N._contextEntries.empty;for(var n in o){a[n]=o[n];}a["card.internal"]=N._contextEntries["card.internal"];e.setData(a);i.setData(Q(a,"label"));});e.getProperty=function(s,o){var a=this.resolve(s,o);if(a.endsWith("/value")){this._mValues=this._mValues||{};if(this._mValues.hasOwnProperty(a)){return this._mValues[a];}this._mValues[a]=undefined;b.getContextValue(a.substring(1)).then(function(m){this._mValues[a]=m;this.checkUpdate();}.bind(this));return undefined;}else{return J.prototype.getProperty.apply(this,arguments);}};};N.fieldMap={"string":"sap/ui/integration/designtime/editor/fields/StringField","integer":"sap/ui/integration/designtime/editor/fields/IntegerField","number":"sap/ui/integration/designtime/editor/fields/NumberField","boolean":"sap/ui/integration/designtime/editor/fields/BooleanField","date":"sap/ui/integration/designtime/editor/fields/DateField","datetime":"sap/ui/integration/designtime/editor/fields/DateTimeField","string[]":"sap/ui/integration/designtime/editor/fields/ListField","destination":"sap/ui/integration/designtime/editor/fields/DestinationField"};N.Fields=null;N.prototype._requireFields=function(){if(N.Fields){return Promise.resolve();}return new Promise(function(a){sap.ui.require(Object.values(N.fieldMap),function(){N.Fields={};for(var n in N.fieldMap){N.Fields[n]=arguments[Object.keys(N.fieldMap).indexOf(n)];}a();});});};N.prototype._createLabel=function(o){var a=new L({text:o.label,tooltip:o.tooltip||o.label,required:o.required&&o.editable||false,visible:o.visible,objectBindings:{currentSettings:{path:"currentSettings>"+o._settingspath},items:{path:"items>/form/items"}}});a._cols=o.cols||2;a._sOriginalType=o.type;if(o.description){var b=new I({src:"sap-icon://message-information",color:"Marker",size:"12px",useIconTooltip:false,visible:this.getMode()!=="translation"});b.addStyleClass("sapUiIntegrationCardEditorDescriptionIcon");a.addDependent(b);a._oDescriptionIcon=b;b.onmouseover=function(b){this._getPopover().getContent()[0].applySettings({text:o.description});this._getPopover().openBy(b);b.addDependent(this._getPopover());}.bind(this,b);b.onmouseout=function(b){this._getPopover().close();b.removeDependent(this._getPopover());}.bind(this,b);}var m=new I({src:"sap-icon://message-information",size:"12px",useIconTooltip:false});m.addStyleClass("sapUiIntegrationCardEditorMessageIcon");a._oMessageIcon=m;return a;};N.prototype._getPopover=function(){if(this._oPopover){return this._oPopover;}var o=new l({text:""});o.addStyleClass("sapUiTinyMargin sapUiIntegrationCardEditorDescriptionText");this._oPopover=new R({showHeader:false,content:[o]});this._oPopover.addStyleClass("sapUiIntegrationCardEditorPopover");return this._oPopover;};N.prototype._updateProviderCard=function(a){if(this._ready){var m=this._oProviderCard._editorManifest;if(a.length===0){return;}for(var i=0;i<a.length;i++){var o=a[i];o.config._cancel=true;}delete m["sap.card"].header;delete m["sap.card"].content;delete m["sap.card"].data;m["sap.card"].type="List";var b=this._oProviderCard;this._oProviderCard=new g({manifest:m,baseUrl:this._getBaseUrl(),host:this._oProviderCard.getHost()});this._oProviderCard.setManifestChanges([this.getCurrentSettings()]);this._oProviderCard._editorManifest=m;var e=this;this._oProviderCard._fillFiltersModel=function(){if(!e._oProviderCard._oDataProviderFactory){return;}e._bIgnoreUpdates=true;for(var i=0;i<a.length;i++){var o=a[i];o.config._cancel=false;e._addValueListModel(o.config,o.field,true,500*i);}e._bIgnoreUpdates=false;};this._oProviderCard.setVisible(false);this._oProviderCard.setModel(this._settingsModel,"items");this._oProviderCard.setModel(this._settingsModel,"currentSettings");this._oProviderCard.onBeforeRendering();if(b&&b!==this._oEditorCard){b.destroy();}}};N.prototype._createField=function(o){var a=new N.Fields[o.type]({configuration:o,mode:this.getMode(),host:this._oEditorCard.getHostInstance(),objectBindings:{currentSettings:{path:"currentSettings>"+o._settingspath},items:{path:"items>/form/items"}},visible:o.visible});this._aFieldReadyPromise.push(a._readyPromise);var b=this._settingsModel.bindProperty(o._settingspath+"/value");b.attachChange(function(){if(!this._bIgnoreUpdates){o._changed=true;if(o._dependentFields&&o._dependentFields.length>0){this._updateProviderCard(o._dependentFields);}this._updatePreview();}}.bind(this));this._addValueListModel(o,a);a._cols=o.cols||2;return a;};N.prototype._addValueListModel=function(o,a,b,e){if(o.values){var j;if(o.values.data){if(this._oProviderCard&&this._oProviderCard._oDataProviderFactory){j=a.getModel();if(!j){j=new J({});a.setModel(j,undefined);}if(!e){e=0;}setTimeout(function(){var Y=this._oProviderCard._oDataProviderFactory.create(o.values.data);Y.bindObject({path:"items>/form/items"});Y.bindObject({path:"currentSettings>"+o._settingspath});var Z=Y.getData();this._settingsModel.setProperty(o._settingspath+"/_loading",true);Z.then(function($){if(o._cancel){o._values=[];return;}if(o.type==="string[]"){var _=o.values.data.path;if(_&&_!=="/"){if(_.startsWith("/")){_=_.substring(1);}if(_.endsWith("/")){_=_.substring(0,_.length-1);}var a1=_.split("/");var b1=O.get(a1,$);if(Array.isArray(b1)){for(var n in b1){var c1=a.getKeyFromItem(b1[n]);if(Array.isArray(o.value)&&o.value.length>0&&y(o.value,c1)){b1[n].Selected=K.getText("CARDEDITOR_ITEM_SELECTED");}else{b1[n].Selected=K.getText("CARDEDITOR_ITEM_UNSELECTED");}}O.set(a1,b1,$);}}else if(Array.isArray($)){for(var n in $){var c1=a.getKeyFromItem($[n]);if(Array.isArray(o.value)&&o.value.length>0&&y(o.value,c1)){$[n].Selected=K.getText("CARDEDITOR_ITEM_SELECTED");}else{$[n].Selected=K.getText("CARDEDITOR_ITEM_UNSELECTED");}}}}o._values=$;j.setData($);j.checkUpdate(true);j.firePropertyChange();this._settingsModel.setProperty(o._settingspath+"/_loading",false);a._hideValueState(true);}.bind(this)).catch(function(n){this._settingsModel.setProperty(o._settingspath+"/_loading",false);var $=K.getText("CARDEDITOR_BAD_REQUEST");if(Array.isArray(n)&&n.length>0){$=n[0];var _=n[1];if(_){var a1;if(_.responseJSON){a1=_.responseJSON.error;}else if(_.responseText){if(U.isJson(_.responseText)){a1=JSON.parse(_.responseText).error;}else{$=_.responseText;}}if(a1){$=(a1.code||a1.errorCode||_.status)+": "+a1.message;}}}else if(typeof(n)==="string"){$=n;}a._showValueState("error",$,true);}.bind(this));}.bind(this),e);}a.bindObject({path:o.values.data.path||"/"});}else if(this._oProviderCard&&this._oProviderCard.getAggregation("_extension")){j=this._oProviderCard.getAggregation("_extension").getModel();a.bindObject({path:o.values.path||"/"});a.setModel(j,undefined);}if(!b){var s=JSON.stringify(o.values.data);if(s){var m=/parameters\.([^\}\}]+)|destinations\.([^\}\}]+)|\{items\>[\/?\w+]+\}|\{currentSettings\>[\/?\w+]+\}/g,z=s.match(m);if(z){for(var i=0;i<z.length;i++){var S="/value";var W="/sap.card/configuration/";if(z[i].indexOf("destinations.")===0||z[i].indexOf("parameters.")===0){if(z[i].indexOf("destinations.")===0){S="/name";}W=W+z[i].replace(".","/")+S;}else if(z[i].indexOf("{items>")===0){W=W+"parameters/"+z[i].slice(7,-1);}else if(z[i].indexOf("{currentSettings>")===0){if(z[i].endsWith("suggestValue}")){W=W+"parameters/"+o._settingspath.substring(o._settingspath.lastIndexOf("/")+1)+"/value";}else{W=W+"parameters/"+z[i].slice(17,-1);}}var X=this._mItemsByPaths[W];if(X){if(X._settingspath===o._settingspath){o=f({},o);}X._dependentFields=X._dependentFields||[];X._dependentFields.push({field:a,config:o});}}}}}}};N.prototype._addItem=function(o){var m=this.getMode();if(this.getAllowDynamicValues()===false||!o.allowDynamicValues){o.allowDynamicValues=false;}if(this.getAllowSettings()===false){o.allowSettings=false;}o._beforeValue=this._beforeManifestModel.getProperty(o.manifestpath);o.__cols=o.cols||2;if(o.visible===false||(!o.translatable&&m==="translation"&&o.type!=="group")){return;}if(o.type==="group"){var a=new P({headerText:o.label,visible:o.visible,expandable:o.expandable!==false,expanded:o.expanded!==false,width:"auto",backgroundDesign:"Transparent",objectBindings:{currentSettings:{path:"currentSettings>"+o._settingspath},items:{path:"items>/form/items"}}});this.addAggregation("_formContent",a);a._cols=o.cols||2;if(o.hint){this._addHint(o.hint);}return;}var n=null;if(m==="translation"){if((typeof o.value==="string"&&o.value.indexOf("{")===0)||typeof o.values!=="undefined"){return;}o._language={value:o.value};o.cols=1;delete o.values;var b=d(o,10);b._settingspath+="/_language";b.editable=false;b.required=false;if(typeof(b._beforeValue)!=="undefined"&&!(b._beforeValue.startsWith("{i18n>")&&b._beforeValue.endsWith("}"))){b.value=b._beforeValue;}if(!b.value){b.value="-";}var e=this._createLabel(b);this.addAggregation("_formContent",e);var i=this._createField(b);i.isOrigLangField=true;this.addAggregation("_formContent",i);o.value=o._translatedDefaultValue||"";o.editable=o.visible=o.translatable;if(this._currentLayerManifestChanges){o.value=this._currentLayerManifestChanges[o.manifestpath]||o.value;}o.label=o._translatedLabel||"";o.required=false;}else{n=this._createLabel(o);this.addAggregation("_formContent",n);}var i=this._createField(o);i.setAssociation("_messageIcon",n&&n._oMessageIcon);this.addAggregation("_formContent",i);if(o.hint&&o.type==="boolean"&&(!o.cols||o.cols===2)){this._addHint(o.hint);}if(n){n._oMessageIcon.onmouseover=function(i){i._showMessage();}.bind(this,i);n._oMessageIcon.onmouseout=function(i){i._hideMessage();}.bind(this,i);}o.cols=o.__cols;delete o.__cols;};N.prototype._addHint=function(s){s=s.replace(/<a href/g,"<a target='blank' href");var o=new F({htmlText:s});this.addAggregation("_formContent",o);};N.prototype._getCurrentLanguageSpecificText=function(s){var a=this._language;if(this._oTranslationBundle){var b=this._oTranslationBundle.getText(s,[],true);if(b===undefined){return"";}return b;}if(!a){return"";}var i=this._oEditorCard.getManifestEntry("/sap.app/i18n");if(!i){return"";}if(typeof i==="string"){var e=[a];if(a.indexOf("_")>-1){e.push(a.substring(0,a.indexOf("_")));}if(!y(e,"en")){e.push("en");}this._oTranslationBundle=r.create({url:this._getBaseUrl()+i,async:false,locale:a,supportedLocales:e,fallbackLocale:"en"});return this._getCurrentLanguageSpecificText(s);}};N.prototype._getBaseUrl=function(){if(this._oEditorCard&&this._oEditorCard.isReady()){return this._oEditorCard.getBaseUrl()||this.oCardEditor._oEditorCard._oCardManifest.getUrl();}else if(this._oEditorCard){return this._oEditorCard.getBaseUrl();}return"";};N.prototype._startEditor=function(){var s=this._settingsModel.getProperty("/");var i;if(s.form&&s.form.items){i=s.form.items;var a=this._language||this.getLanguage()||c.getConfiguration().getLanguage().replaceAll('-','_');if(this.getMode()==="translation"){this._addItem({type:"group",translatable:true,expandable:false,label:K.getText("CARDEDITOR_ORIGINALLANG")+": "+N._languages[a]});}var b=false;for(var m in i){var o=i[m];if(o.type==="group"){break;}else if(o.visible){b=true;break;}}if(b){this._addItem({type:"group",translatable:true,label:K.getText("CARDEDITOR_PARAMETERS_GENERALSETTINGS")});}this._mItemsByPaths={};for(var n in i){var o=i[n];if(o){o.label=o.label||n;var e;if(o.manifestpath){this._mItemsByPaths[o.manifestpath]=o;e=this._currentLayerManifestChanges[o.manifestpath];}o._changed=e!==undefined;if(o.values){o.translatable=false;}if(o.type==="string"){o._translatedDefaultPlaceholder=this._getManifestDefaultValue(o.manifestpath)||o.defaultValue;var j=null,z=o._translatedDefaultPlaceholder;if(z){if(this._isValueWithHandlebarsTranslation(z)){j=z.substring(2,z.length-2);}else if(z.startsWith("{i18n>")){j=z.substring(6,z.length-1);}if(j){o.translatable=true;o._translatedDefaultValue=this.getModel("i18n").getResourceBundle().getText(j);if(o._changed){o.value=e;}else{o.value=o._translatedDefaultValue;}if(o.valueTranslations&&o.valueTranslations[a]){o.value=o.valueTranslations[a];}if(this.getMode()==="translation"){o._translatedDefaultValue=this._getCurrentLanguageSpecificText(j);}}else if(o.translatable&&this.getMode()==="translation"){o._translatedDefaultValue=o._translatedDefaultPlaceholder;}}if(this.getMode()==="translation"){if(o.valueTranslations&&o.valueTranslations[a]){o._translatedDefaultValue=o.valueTranslations[a];}if(this._isValueWithHandlebarsTranslation(o.label)){o._translatedLabel=this._getCurrentLanguageSpecificText(o.label.substring(2,o.label.length-2),true);}else if(o.label&&o.label.startsWith("{i18n>")){o._translatedLabel=this._getCurrentLanguageSpecificText(o.label.substring(6,o.label.length-1),true);}}}else if(o.type==="string[]"){var S=o.manifestpath.substring(0,o.manifestpath.lastIndexOf("/"))+"/valueItems";var W=this._manifestModel.getProperty(S);if(W){o.valueItems=W;}}}}}for(var n in i){var o=i[n];this._addItem(o);}if(this.getMode()!=="translation"){this._initPreview().then(function(){Promise.all(this._aFieldReadyPromise).then(function(){this._ready=true;this.fireReady();}.bind(this));}.bind(this));}else{Promise.all(this._aFieldReadyPromise).then(function(){this._ready=true;this.fireReady();}.bind(this));}};N.prototype.destroy=function(){if(this._oEditorCard){this._oEditorCard.destroy();}if(this._oPopover){this._oPopover.destroy();}if(this._oDesigntimeInstance){this._oDesigntimeInstance.destroy();}this._manifestModel=null;this._originalManifestModel=null;this._settingsModel=null;C.prototype.destroy.apply(this,arguments);};N.prototype._initPreview=function(){return new Promise(function(a,b){sap.ui.require(["sap/ui/integration/designtime/editor/CardPreview"],function(e){var o=new e({settings:this._oDesigntimeInstance.getSettings(),card:this._oEditorCard});this.setAggregation("_preview",o);a();}.bind(this));}.bind(this));};N.prototype._updatePreview=function(){var o=this.getAggregation("_preview");if(o){o.update();}};N.prototype._applyDesigntimeDefaults=function(s){s=s||{};s.form=s.form||{};s.form.items=s.form.items||{};s.preview=s.preview||{modes:"Abstract"};var i=s.form.items||s.form.items;for(var n in i){var o=i[n];if(o.manifestpath){o.value=this._manifestModel.getProperty(o.manifestpath);}if(o.visible===undefined||o.visible===null){o.visible=true;}if(typeof o.translatable!=="boolean"){o.translatable=false;}if(o.editable===undefined||o.editable===null){o.editable=true;}if(!o.label){o.label=n;}if(!o.type||o.type==="enum"){o.type="string";}if(o.value===undefined||o.value===null){switch(o.type){case"boolean":o.value=o.defaultValue||false;break;case"integer":case"number":o.value=o.defaultValue||0;break;case"string[]":o.value=o.defaultValue||[];break;default:o.value=o.defaultValue||"";}}if(o.type==="group"){if(o.visible===undefined||o.value===null){o.visible=true;}}o._settingspath="/form/items/"+n;}};N.prototype._applyDesigntimeLayers=function(s){if(this._appliedLayerManifestChanges&&Array.isArray(this._appliedLayerManifestChanges)){for(var i=0;i<this._appliedLayerManifestChanges.length;i++){var o=this._appliedLayerManifestChanges[i][":designtime"];if(o){var a=Object.keys(o);for(var j=0;j<a.length;j++){this._settingsModel.setProperty(a[j],o[a[j]]);}}}}if(this._currentLayerManifestChanges){var o=this._currentLayerManifestChanges[":designtime"];if(o){var a=Object.keys(o);for(var j=0;j<a.length;j++){var b=a[j],n=b.substring(0,b.lastIndexOf("/")+1)+"_next";if(!this._settingsModel.getProperty(n)){this._settingsModel.setProperty(n,{});}var n=b.substring(0,b.lastIndexOf("/")+1)+"_next",e=b.substring(b.lastIndexOf("/")+1);this._settingsModel.setProperty(n+"/"+e,o[a[j]]);}}}};N.prototype._createParameterDesigntime=function(o){var s={},b="/sap.card/configuration/parameters/",m=this.getMode();if(o&&o.parameters){s.form=s.form||{};s.form.items=s.form.items||{};var i=s.form.items;Object.keys(o.parameters).forEach(function(n){i[n]=f({manifestpath:b+n+"/value",editable:(m!=="translation"),_settingspath:"/form/items/"+n},o.parameters[n]);var a=i[n];if(!a.type){a.type="string";}if(!a.hasOwnProperty("visible")){a.visible=true;}});}return new D(s);};N.prototype._addDestinationSettings=function(o){var s=this._oDesigntimeInstance.getSettings(),i="/sap.card/configuration/destinations/";s.form=s.form||{};s.form.items=s.form.items||{};if(s&&o&&o.destinations){if(!s.form.items["destination.group"]){s.form.items["destination.group"]={label:K.getText("CARDEDITOR_DESTINATIONS")||"Destinations",type:"group",visible:true};}var j=s.form.items,m=this._oEditorCard.getHostInstance();Object.keys(o.destinations).forEach(function(n){j[n+".destinaton"]=f({manifestpath:i+n+"/name",visible:true,type:"destination",editable:true,allowDynamicValues:false,allowSettings:false,value:o.destinations[n].name,defaultValue:o.destinations[n].defaultUrl,_settingspath:"/form/items/"+[n+".destinaton"],_values:[],_destinationName:n},o.destinations[n]);if(typeof j[n+".destinaton"].label==="undefined"){j[n+".destinaton"].label=n;}if(m){j[n+".destinaton"]._loading=true;}});var z=false;if(m){this._oEditorCard.getHostInstance().getDestinations().then(function(a){z=true;Object.keys(o.destinations).forEach(function(n){j[n+".destinaton"]._values=a;j[n+".destinaton"]._loading=false;this._settingsModel.checkUpdate(true);}.bind(this));}.bind(this)).catch(function(){return this._oEditorCard.getHostInstance().getDestinations();}.bind(this)).then(function(b){if(z){return;}Object.keys(o.destinations).forEach(function(n){j[n+".destinaton"]._values=b;j[n+".destinaton"]._loading=false;this._settingsModel.checkUpdate(true);}.bind(this));}.bind(this)).catch(function(e){Object.keys(o.destinations).forEach(function(n){j[n+".destinaton"]._loading=false;this._settingsModel.checkUpdate(true);}.bind(this));p.error("Can not get destinations list from '"+m.getId()+"'.");}.bind(this));}}};N.prototype._getManifestDefaultValue=function(s){return this._originalManifestModel.getProperty(s);};N.prototype._isValueWithHandlebarsTranslation=function(a){if(typeof a==="string"){return!!a.match(E);}return false;};N._contextEntries={empty:{label:K.getText("CARDEDITOR_CONTEXT_EMPTY_VAL"),type:"string",description:K.getText("CARDEDITOR_CONTEXT_EMPTY_DESC"),placeholder:"",value:""},"card.internal":{label:K.getText("CARDEDITOR_CONTEXT_CARD_INTERNAL_VAL"),todayIso:{type:"string",label:K.getText("CARDEDITOR_CONTEXT_CARD_TODAY_VAL"),description:K.getText("CARDEDITOR_CONTEXT_CARD_TODAY_DESC"),tags:[],placeholder:K.getText("CARDEDITOR_CONTEXT_CARD_TODAY_VAL"),customize:["format.dataTime"],value:"{{parameters.TODAY_ISO}}"},nowIso:{type:"string",label:K.getText("CARDEDITOR_CONTEXT_CARD_NOW_VAL"),description:K.getText("CARDEDITOR_CONTEXT_CARD_NOW_DESC"),tags:[],placeholder:K.getText("CARDEDITOR_CONTEXT_CARD_NOW_VAL"),customize:["dateFormatters"],value:"{{parameters.NOW_ISO}}"},currentLanguage:{type:"string",label:K.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),description:K.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),tags:["technical"],customize:["languageFormatters"],placeholder:K.getText("CARDEDITOR_CONTEXT_CARD_LANG_VAL"),value:"{{parameters.LOCALE}}"}}};N._languages={};N._appendThemeVars=function(){var o=document.getElementById("sap-ui-integration-editor-style");if(o&&o.parentNode){o.parentNode.removeChild(o);}var a=["sapUiButtonHoverBackground","sapUiBaseBG","sapUiContentLabelColor","sapUiTileSeparatorColor","sapUiHighlight","sapUiListSelectionBackgroundColor","sapUiNegativeText","sapUiCriticalText","sapUiPositiveText","sapUiChartScrollbarBorderColor"],s=document.createElement("style");s.setAttribute("id","sap-ui-integration-editor-style");for(var i=0;i<a.length;i++){a[i]="--"+a[i]+":"+x.get(a[i]);}s.innerHTML=".sapUiIntegrationCardEditor, .sapUiIntegrationFieldSettings, .sapUiIntegrationIconSelectList {"+a.join(";")+"}";document.body.appendChild(s);};N.init=function(){this.init=function(){};N._appendThemeVars();c.attachThemeChanged(function(){N._appendThemeVars();});var s=sap.ui.require.toUrl("sap.ui.integration.designtime.editor.css.CardEditor".replace(/\./g,"/")+".css");v(s);w.loadResource("sap/ui/integration/designtime/editor/languages.json",{dataType:"json",failOnError:false,async:true}).then(function(o){N._languages=o;});};N.init();return N;});
