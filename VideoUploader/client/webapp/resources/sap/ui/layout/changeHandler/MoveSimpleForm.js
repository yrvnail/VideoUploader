/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/util/reflection/JsControlTreeModifier","sap/base/util/uid","sap/base/Log"],function(J,u,L){"use strict";var M={};M.CHANGE_TYPE_MOVE_FIELD="moveSimpleFormField";M.CHANGE_TYPE_MOVE_GROUP="moveSimpleFormGroup";M.sTypeTitle="sap.ui.core.Title";M.sTypeMTitle="sap.m.Title";M.sTypeToolBar="sap.m.Toolbar";M.sTypeOverflowToolBar="sap.m.OverflowToolbar";M.sTypeLabel="sap.m.Label";M.sTypeSmartLabel="sap.ui.comp.smartfield.SmartLabel";M.CONTENT_AGGREGATION="content";function f(o,s,C){for(var i=0;i<C.length;i++){var t=o.getControlType(C[i]);if(s.indexOf(t)===-1){if(o.getVisible(C[i])){return true;}}else{return false;}}}function a(C,o,i,s,p,S,G){if(f(o,S,i)){var v=p.view;var A=p.appComponent;var t=o.createControl("sap.ui.core.Title",A,v,G);o.setProperty(t,"text","");o.insertAggregation(s,"content",t,0,v);var n=C.getRevertData();n.createdTitleSelector=p.modifier.getSelector(t,p.appComponent);C.setRevertData(n);}return o.getAggregation(s,"content");}function m(o,s,C,G){var R;var l=-1;if(f(o,s,C)){l++;}for(var i=0;i<C.length;i++){var t=o.getControlType(C[i]);if(s.indexOf(t)>-1){l++;if(l===G){R=C[i];break;}}}return C.indexOf(R);}function b(E,i,o){if(i>=E.length||i===-1){return true;}var t=o.getControlType(E[i]);return(M.sTypeTitle===t||M.sTypeToolBar===t||M.sTypeMTitle===t||M.sTypeOverflowToolBar===t);}function c(o,l,C,s){var i=0;for(i=l+1;i<C.length;++i){var t=o.getControlType(C[i]);if(s.indexOf(t)>-1){break;}}return i-l;}function g(o,E,i){return c(o,i,E,[M.sTypeTitle,M.sTypeMTitle,M.sTypeToolBar,M.sTypeOverflowToolBar,M.sTypeLabel,M.sTypeSmartLabel]);}function d(o,C,G,F,U){if(!b(C,G,o)){L.error("Illegal argument. iIndex has to point to a Label.");}else{F=U?F+1:F;var i=0;var A=G;var l;while(A<C.length&&i<F){++i;l=g(o,C,A);A+=l;}return A;}}function e(s,S,t,T,l){var R=t;for(var i=0;i<l;i++){R.splice(T+i,0,s[S+i]);}return R;}function h(H){var R=H.getTitle();if(!R){R=H.getToolbar();}return R;}function j(s,i,p){var o=h(i.element);var S=p.modifier.getSelector(s,p.appComponent);var l={elementSelector:p.modifier.getSelector(o,p.appComponent),source:{groupIndex:i.sourceIndex},target:{groupIndex:i.targetIndex}};return{changeType:M.CHANGE_TYPE_MOVE_GROUP,targetSelector:S,movedControl:o,movedElements:[l]};}function k(s,i,S,t,p){var o=p.modifier.getSelector(s,p.appComponent);var l=i.element.getLabel();var n=p.modifier.getSelector(l,p.appComponent);var T=h(t.parent);var q=h(S.parent);var v=p.modifier.getSelector(T,p.appComponent);var w=p.modifier.getSelector(q,p.appComponent);var x={elementSelector:n,source:{groupSelector:w,fieldIndex:i.sourceIndex},target:{groupSelector:v,fieldIndex:i.targetIndex}};return{changeType:M.CHANGE_TYPE_MOVE_FIELD,targetSelector:o,target:T,source:q,movedControl:l,movedElements:[x]};}function r(o,s,M,C,v){o.removeAllAggregation(s,M.CONTENT_AGGREGATION);for(var i=0;i<C.length;++i){o.insertAggregation(s,M.CONTENT_AGGREGATION,C[i],i,v);}}M.applyChange=function(C,s,p){var o=p.modifier;var v=p.view;var A=p.appComponent;var t,i;var l=C.getContent();var n=l.movedElements[0];var q=o.getAggregation(s,M.CONTENT_AGGREGATION);var w=q.map(function(X){return o.getSelector(X,A);});var S={content:w};C.setRevertData(S);if(C.getChangeType()===M.CHANGE_TYPE_MOVE_FIELD){var x=o.bySelector(n.elementSelector||n.element,A,v);var y=q.indexOf(x);var z=g(o,q,y);t=o.bySelector(n.target.groupSelector||n.target.groupId,A,v);var T=q.indexOf(t);var B=o.bySelector(n.source.groupSelector||n.source.groupId,A,v);var D=q.indexOf(B);var E=d(o,q,T,n.target.fieldIndex,(D===T)&&(n.source.fieldIndex<n.target.fieldIndex));var F=g(o,q,E);i=q.slice();var G=i.slice(y,y+z);var H,I,K,N;if(y<E){H=i.slice(0,y);K=i.slice(y+z,E+F);N=i.slice(E+F,i.length);i=H.concat(K.concat(G.concat(N)));}else if(y>E){I=i.slice(0,E+F);K=i.slice(E+F,y);N=i.slice(y+z,i.length);i=I.concat(G.concat(K.concat(N)));}if(y!=E){r(o,s,M,i,v);}}else if(C.getChangeType()===M.CHANGE_TYPE_MOVE_GROUP){var O=[M.sTypeTitle,M.sTypeToolBar,M.sTypeMTitle,M.sTypeOverflowToolBar];var P=o.bySelector(n.elementSelector||n.element,A,v);if(n.target.groupIndex===0||!P){q=a(C,o,q,s,p,O,l.newControlId);}var Q=P?q.indexOf(P):0;var R=m(o,O,q,n.target.groupIndex);t=q[R];var U=c(o,R,q,O);var V=c(o,Q,q,O);i=q.slice();i.splice(Q,V);R=i.indexOf(t);var W=n.source.groupIndex<n.target.groupIndex?U:0;i=e(q,Q,i,R+W,V);r(o,s,M,i,v);}else{L.warning("Unknown change type detected. Cannot apply to SimpleForm");}return true;};M.completeChangeContent=function(C,s,p){var S;var o=p.modifier;var v=p.view;var A=p.appComponent;var i=o.bySelector(s.selector,A,v);var l=s.movedElements;if(l.length>1){L.warning("Moving more than 1 Formelement is not yet supported.");}var n=l[0];n.element=sap.ui.getCore().byId(n.id);var q=Object.assign({},s.source);var t=Object.assign({},s.target);if(!t.parent){t.parent=sap.ui.getCore().byId(t.id);}if(!q.parent){q.parent=sap.ui.getCore().byId(q.id);}if(i&&n.element&&t.parent){if(s.changeType==="moveSimpleFormGroup"){S=j(i,n,p);}else if(s.changeType==="moveSimpleFormField"){S=k(i,n,q,t,p);}}else{L.error("Element not found. This may be caused by an unstable id!");}var w=C.getDefinition();w.content.targetSelector=S.targetSelector;w.content.movedElements=S.movedElements;w.content.newControlId=o.getSelector(v.createId(u()),A);if(S.source&&S.target){C.addDependentControl(S.source,"sourceParent",p);C.addDependentControl(S.target,"targetParent",p);}C.addDependentControl([S.movedControl],"movedElements",p);};M.revertChange=function(C,s,p){var o=p.modifier;var A=p.appComponent;var v=p.view;var R=C.getRevertData();var i=R.content;var l=i.map(function(S){return o.bySelector(S,A,v);});r(o,s,M,l,v);var n=R.createdTitleSelector;var q=p.modifier.bySelector(n,p.appComponent);if(q){q.destroy();}C.resetRevertData();return true;};M.getChangeVisualizationInfo=function(C,A){var o=C.getContent().movedElements[0];var G=o.source.groupSelector;var i=C.getChangeType()==="moveSimpleFormGroup"?J.bySelector(o.elementSelector,A).getParent().getId():o.elementSelector;return{affectedControls:[i],dependentControls:[G&&G.id?G:C.getContent().targetSelector]};};return M;},true);
